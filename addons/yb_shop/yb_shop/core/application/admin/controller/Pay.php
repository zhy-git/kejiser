<?php
 namespace app\admin\controller; use think\Controller; use think\Db; use think\log; use think\Request; require EXTEND_PATH . "\x57\170\x70\x61\x79\x2f\127\x78\120\x61\x79\56\101\160\x69\x2e\160\150\160"; use app\admin\service\AliyunService; class Pay extends Controller { public function notice() { goto fPX8W; OvQhR: $user = Db::name("\x79\x62\x73\143\137\142\165\x73\151\x6e\145\x73\163")->where(["\x69\144" => $mid])->find(); goto hh_S5; fl1W1: $data["\x75\x72\154"] = $un_url[0]; goto yyipB; K7nBt: return json_encode($rs); goto y5Y80; hh_S5: $un_data["\x75\x72\154"] = $_SERVER["\x48\124\124\120\137\x48\x4f\123\124"]; goto gX0YW; jh_6O: $mid = $order["\155\143\150\137\x69\x64"]; goto OvQhR; O07RJ: $config = array("\141\x70\x70\151\144" => "\x4c\124\x41\111\x41\66\145\x71\x75\x77\123\171\153\x53\x43\x4b", "\x73\145\143\162\x65\164" => "\x32\x4f\124\x71\157\x59\x53\x55\x32\130\x56\x5a\x65\62\70\143\x66\x69\112\x70\152\x6b\61\x46\104\x33\102\105\161\x59", "\x61\x70\160\153\x65\171" => "\x32\x34\x39\x36\65\71\x33\x34"); goto Sj3fe; HSkPs: $rs["\x69\x6e\146\x6f"] = $info; goto K7nBt; yyipB: $data["\x75\x73\145\162\x6e\x61\155\x65"] = $user["\156\x61\155\145"]; goto VqKW9; fPX8W: $out_trade_no = Request::instance()->param("\151\144"); goto O07RJ; jj3ur: $alias = md5($data["\x75\x72\154"] . $data["\165\163\x65\162\156\141\x6d\x65"] . $data["\x75\156\151\141\x63\151\144"]); goto q_VDL; Sj3fe: $order = Db::name("\171\142\x73\x63\137\x6f\x72\x64\x65\x72")->where(["\157\x75\164\137\x74\162\141\x64\145\137\x6e\x6f" => $out_trade_no])->find(); goto jh_6O; NHhoO: $info = $aliyun->push($config, $alias); goto HSkPs; VqKW9: $data["\165\x6e\x69\141\x63\151\144"] = $user["\165\156\151\141\143\151\144"]; goto jj3ur; gX0YW: $un_url = explode("\72", $un_data["\x75\x72\x6c"]); goto fl1W1; q_VDL: $aliyun = new AliyunService(); goto NHhoO; y5Y80: } public function PayCallback() { goto IWMfL; hvpZE: $info = $this->pay_set($out_trade_no, 1); goto VdFg1; yU3Vm: if ($notify_data) { goto wf2qY; } goto n66ni; ZtxwU: if ($notify_data) { goto ku6b6; } goto GKbGn; HWUUz: wf2qY: goto ZtxwU; VdFg1: $rs["\x69\x6e\146\x6f"] = $info; goto qmrDj; IWMfL: $notify_data = file_get_contents("\x70\150\x70\72\x2f\57\151\156\160\165\x74"); goto yU3Vm; me38E: ku6b6: goto EwdHJ; qmrDj: return json_encode($rs); goto Jitvn; GKbGn: exit("\xe6\x9c\xaa\346\224\266\xe5\x88\xb0\xe5\x9b\236\350\260\x83"); goto me38E; SU3SU: Log::write($out_trade_no . "\x2c\xe6\224\xaf\344\273\230\345\256\x8c\346\210\220", "\x73\150\157\x70\137\160\x61\171\137\x73\165\143\x63\145\163\x73"); goto hvpZE; bkK88: $out_trade_no = $doc->getElementsByTagName("\157\165\x74\137\x74\162\141\x64\x65\x5f\x6e\157")->item(0)->nodeValue; goto SU3SU; EwdHJ: $doc = new \DOMDocument(); goto xXNSm; n66ni: $notify_data = $GLOBALS["\x48\124\x54\120\x5f\122\x41\x57\x5f\x50\117\123\x54\x5f\104\x41\x54\101"] ?: ''; goto HWUUz; xXNSm: $doc->loadXML($notify_data); goto bkK88; Jitvn: } public function pay_set($out_trade_no, $pay_type) { goto sxGYe; HyUJF: Db::startTrans(); goto QQ8eR; clnlT: return "\x73\x75\143\143\x65\163\x73"; goto Wgg_S; sxGYe: $data = array("\x6f\x72\144\145\x72\x5f\163\x74\141\x74\x75\x73" => 1, "\160\x61\171\x5f\x73\x74\x61\x74\165\163" => 1, "\160\141\171\137\x74\171\160\x65" => $pay_type, "\160\141\x79\137\164\x69\155\x65" => time()); goto jY2LE; QQ8eR: try { goto u5oz1; vMSUe: if (!(!empty($res) && $res > 0)) { goto dbeil; } goto JhptB; NwVa2: Db::name("\x79\x62\x73\143\137\157\162\x64\x65\162\137\160\x61\x79\155\x65\156\164")->where(["\157\165\x74\137\x74\x72\x61\x64\145\x5f\x6e\x6f" => $out_trade_no, "\x70\141\171\137\x73\164\x61\164\165\x73" => 0])->update($data_pay); goto iucvT; iucvT: Db::commit(); goto vMSUe; s2F8k: dbeil: goto jrz5Y; u5oz1: $res = Db::name("\x79\x62\x73\x63\137\x6f\x72\144\145\162")->where(["\x6f\165\164\x5f\164\162\141\144\145\x5f\156\157" => $out_trade_no, "\157\162\144\x65\162\x5f\163\164\141\x74\x75\163" => 0])->update($data); goto NwVa2; JhptB: $this->notice($out_trade_no); goto s2F8k; jrz5Y: } catch (\Exception $e) { Db::rollback(); return null; } goto clnlT; jY2LE: $data_pay = array("\160\141\171\x5f\x73\x74\141\x74\165\163" => 1, "\160\x61\x79\137\164\x69\x6d\x65" => time()); goto HyUJF; Wgg_S: } }
