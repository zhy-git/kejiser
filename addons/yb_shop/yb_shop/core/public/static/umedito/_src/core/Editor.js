!function(){function c(a,b){var c,e,d,f;if(b.textarea)if(utils.isString(b.textarea)){for(d=0,f=domUtils.getElementsByTagName(a,"textarea");e=f[d++];)if(e.id=="umeditor_textarea_"+b.options.textarea){c=e;break}}else c=b.textarea;c||(a.appendChild(c=domUtils.createElement(document,"textarea",{name:b.options.textarea,id:"umeditor_textarea_"+b.options.textarea,style:"display:none"})),b.textarea=c),c.value=b.hasContents()?b.options.allHtmlEnabled?b.getAllHtml():b.getContent(null,null,!0):""}function d(a){for(var b in UM.plugins)-1==a.options.excludePlugins.indexOf(b)&&(UM.plugins[b].call(a),a.plugins[b]=1);a.langIsReady=!0,a.fireEvent("langReady")}function e(a){for(var b in a)return b}var b,a=0,f=UM.Editor=function(b){var c=this;c.uid=a++,EventBase.call(c),c.commands={},c.options=utils.extend(utils.clone(b||{}),UMEDITOR_CONFIG,!0),c.shortcutkeys={},c.inputRules=[],c.outputRules=[],c.setOpt({isShow:!0,initialContent:"",initialStyle:"",autoClearinitialContent:!1,textarea:"editorValue",focus:!1,focusInEnd:!0,autoClearEmptyNode:!0,fullscreen:!1,readonly:!1,zIndex:999,enterTag:"p",lang:"zh-cn",langPath:c.options.UMEDITOR_HOME_URL+"lang/",theme:"default",themePath:c.options.UMEDITOR_HOME_URL+"themes/",allHtmlEnabled:!1,autoSyncData:!0,autoHeightEnabled:!0,excludePlugins:""}),c.plugins={},utils.isEmptyObject(UM.I18N)?utils.loadFile(document,{src:c.options.langPath+c.options.lang+"/"+c.options.lang+".js",tag:"script",type:"text/javascript",defer:"defer"},function(){d(c)}):(c.options.lang=e(UM.I18N),d(c))};f.prototype={ready:function(a){var b=this;a&&(b.isReady?a.apply(b):b.addListener("ready",a))},setOpt:function(a,b){var c={};utils.isString(a)?c[a]=b:c=a,utils.extend(this.options,c,!0)},getOpt:function(a){return this.options[a]||""},destroy:function(){var b,c,d,a=this;a.fireEvent("destroy"),b=a.container.parentNode,b===document.body&&(b=a.container),c=a.textarea,c?c.style.display="":(c=document.createElement("textarea"),b.parentNode.insertBefore(c,b)),c.style.width=a.body.offsetWidth+"px",c.style.height=a.body.offsetHeight+"px",c.value=a.getContent(),c.id=a.key,b.contains(c)&&$(c).insertBefore(b),b.innerHTML="",domUtils.remove(b),UM.clearCache(a.id);for(d in a)a.hasOwnProperty(d)&&delete this[d]},initialCont:function(a){if(a){if(a.getAttribute("name")&&(this.options.textarea=a.getAttribute("name")),a&&/script|textarea/gi.test(a.tagName)){var b=document.createElement("div");a.parentNode.insertBefore(b,a),this.options.initialContent=UM.htmlparser(a.value||a.innerHTML||this.options.initialContent).toHtml(),a.className&&(b.className=a.className),a.style.cssText&&(b.style.cssText=a.style.cssText),/textarea/i.test(a.tagName)?(this.textarea=a,this.textarea.style.display="none"):(a.parentNode.removeChild(a),a.id&&(b.id=a.id)),a=b,a.innerHTML=""}return a}return null},render:function(a){var e,b=this,c=b.options,d=function(b){return parseInt($(a).css(b))};utils.isString(a)&&(a=document.getElementById(a)),a&&(this.id=a.getAttribute("id"),UM.setEditor(this),utils.cssRule("edui-style-body",b.options.initialStyle,document),a=this.initialCont(a),a.className+=" edui-body-container",c.minFrameWidth=c.initialFrameWidth?c.initialFrameWidth:c.initialFrameWidth=$(a).width()||UM.defaultWidth,c.initialFrameHeight?c.minFrameHeight=c.initialFrameHeight:c.initialFrameHeight=c.minFrameHeight=$(a).height()||UM.defaultHeight,a.style.width=/%$/.test(c.initialFrameWidth)?"100%":c.initialFrameWidth-d("padding-left")-d("padding-right")+"px",e=/%$/.test(c.initialFrameHeight)?"100%":c.initialFrameHeight-d("padding-top")-d("padding-bottom"),this.options.autoHeightEnabled?(a.style.minHeight=e+"px",a.style.height="",browser.ie&&browser.version<=6&&(a.style.height=e,a.style.setExpression("height","this.scrollHeight <= "+e+' ? "'+e+'px" : "auto"'))):$(a).height(e),a.style.zIndex=c.zIndex,this._setup(a))},_setup:function(a){var e,f,g,b=this,d=b.options;for(a.contentEditable=!0,document.body.spellcheck=!1,b.document=document,b.window=document.defaultView||document.parentWindow,b.body=a,b.$body=$(a),b.selection=new dom.Selection(document,b.body),b._isEnabled=!1,browser.gecko&&(e=this.selection.getNative())&&e.removeAllRanges(),this._initEvents(),f=a.parentNode;f&&!domUtils.isBody(f);f=f.parentNode)if("FORM"==f.tagName){b.form=f,b.options.autoSyncData?$(a).on("blur",function(){c(f,b)}):$(f).on("submit",function(){c(this,b)});break}d.initialContent&&(d.autoClearinitialContent?(g=b.execCommand,b.execCommand=function(){return b.fireEvent("firstBeforeExecCommand"),g.apply(b,arguments)},this._setDefaultContent(d.initialContent)):this.setContent(d.initialContent,!1,!0)),domUtils.isEmptyNode(b.body)&&(b.body.innerHTML="<p>"+(browser.ie?"":"<br/>")+"</p>"),d.focus&&setTimeout(function(){b.focus(b.options.focusInEnd),!b.options.autoClearinitialContent&&b._selectionChange()},0),b.container||(b.container=a.parentNode),b._bindshortcutKeys(),b.isReady=1,b.fireEvent("ready"),d.onready&&d.onready.call(b),(!browser.ie||browser.ie9above)&&$(b.body).on("blur focus",function(a){var c=b.selection.getNative();if("blur"==a.type)c.rangeCount>0&&(b._bakRange=c.getRangeAt(0));else{try{b._bakRange&&c.addRange(b._bakRange)}catch(a){}b._bakRange=null}}),!d.isShow&&b.setHide(),d.readonly&&b.setDisabled()},sync:function(a){var b=this,d=a?document.getElementById(a):domUtils.findParent(b.body.parentNode,function(a){return"FORM"==a.tagName},!0);d&&c(d,b)},setHeight:function(a,b){!b&&(this.options.initialFrameHeight=a),this.options.autoHeightEnabled?($(this.body).css({"min-height":a+"px"}),browser.ie&&browser.version<=6&&this.container&&(this.container.style.height=a,this.container.style.setExpression("height","this.scrollHeight <= "+a+' ? "'+a+'px" : "auto"'))):$(this.body).height(a),this.fireEvent("resize")},setWidth:function(a){this.$container&&this.$container.width(a),$(this.body).width(a-1*$(this.body).css("padding-left").replace("px","")-1*$(this.body).css("padding-right").replace("px","")),this.fireEvent("resize")},addshortcutkey:function(a,b){var c={};b?c[a]=b:c=a,utils.extend(this.shortcutkeys,c)},_bindshortcutKeys:function(){var a=this,b=this.shortcutkeys;a.addListener("keydown",function(c,d){var f,g,i,h,j,k,e=d.keyCode||d.which;for(f in b)for(g=b[f].split(","),h=0;i=g[h++];)i=i.split(":"),j=i[0],k=i[1],(/^(ctrl)(\+shift)?\+(\d+)$/.test(j.toLowerCase())||/^(\d+)$/.test(j))&&(("ctrl"==RegExp.$1?d.ctrlKey||d.metaKey:0)&&(""!=RegExp.$2?d[RegExp.$2.slice(1)+"Key"]:1)&&e==RegExp.$3||e==RegExp.$1)&&(-1!=a.queryCommandState(f,k)&&a.execCommand(f,k),domUtils.preventDefault(d))})},getContent:function(a,b,c,d,e){var g,f=this;return a&&utils.isFunction(a)&&(b=a,a=""),(b?b():this.hasContents())?(f.fireEvent("beforegetcontent"),g=UM.htmlparser(f.body.innerHTML,d),f.filterOutputRule(g),f.fireEvent("aftergetcontent",g),g.toHtml(e)):""},getAllHtml:function(){var d,a=this,b=[];return a.fireEvent("getAllHtml",b),browser.ie&&browser.version>8&&(d="",utils.each(a.document.styleSheets,function(a){d+=a.href?'<link rel="stylesheet" type="text/css" href="'+a.href+'" />':"<style>"+a.cssText+"</style>"}),utils.each(a.document.getElementsByTagName("script"),function(a){d+=a.outerHTML})),"<html><head>"+(a.options.charset?'<meta http-equiv="Content-Type" content="text/html; charset='+a.options.charset+'"/>':"")+(d||a.document.getElementsByTagName("head")[0].innerHTML)+b.join("\n")+"</head>"+"<body "+(ie&&browser.version<9?'class="view"':"")+">"+a.getContent(null,null,!0)+"</body></html>"},getPlainTxt:function(){var a=new RegExp(domUtils.fillChar,"g"),b=this.body.innerHTML.replace(/[\n\r]/g,"");return b=b.replace(/<(p|div)[^>]*>(<br\/?>|&nbsp;)<\/\1>/gi,"\n").replace(/<br\/?>/gi,"\n").replace(/<[^>\/]+>/g,"").replace(/(\n)?<\/([^>]+)>/g,function(a,b,c){return dtd.$block[c]?"\n":b?b:""}),b.replace(a,"").replace(/\u00a0/g," ").replace(/&nbsp;/g," ")},getContentTxt:function(){var a=new RegExp(domUtils.fillChar,"g");return this.body[browser.ie?"innerText":"textContent"].replace(a,"").replace(/\u00a0/g," ")},setContent:function(a,b,d){function g(a){return"DIV"==a.tagName&&a.getAttribute("cdata_tag")}var f,i,h,j,k,e=this;if(e.fireEvent("beforesetcontent",a),f=UM.htmlparser(a),e.filterInputRule(f),a=f.toHtml(),e.body.innerHTML=(b?e.body.innerHTML:"")+a,"p"==e.options.enterTag)if(h=this.body.firstChild,!h||1==h.nodeType&&(dtd.$cdata[h.tagName]||g(h)||domUtils.isCustomeNode(h))&&h===this.body.lastChild)this.body.innerHTML="<p>"+(browser.ie?"&nbsp;":"<br/>")+"</p>"+this.body.innerHTML;else for(j=e.document.createElement("p");h;){for(;h&&(3==h.nodeType||1==h.nodeType&&dtd.p[h.tagName]&&!dtd.$cdata[h.tagName]);)i=h.nextSibling,j.appendChild(h),h=i;if(j.firstChild){if(!h){e.body.appendChild(j);break}h.parentNode.insertBefore(j,h),j=e.document.createElement("p")}h=h.nextSibling}e.fireEvent("aftersetcontent"),e.fireEvent("contentchange"),!d&&e._selectionChange(),e._bakRange=e._bakIERange=e._bakNativeRange=null,browser.gecko&&(k=this.selection.getNative())&&k.removeAllRanges(),e.options.autoSyncData&&e.form&&c(e.form,e)},focus:function(a){try{var b=this,c=b.selection.getRange();a?c.setStartAtLast(b.body.lastChild).setCursor(!1,!0):c.select(!0),this.fireEvent("focus")}catch(d){}},blur:function(){var a=this.selection.getNative();a.empty?a.empty():a.removeAllRanges(),this.fireEvent("blur")},isFocus:function(){return this.fireEvent("isfocus")===!0?!0:this.selection.isFocus()},_initEvents:function(){var a=this,b=a.body,c=function(){a._proxyDomEvent.apply(a,arguments)};$(b).on("click contextmenu mousedown keydown keyup keypress mouseup mouseover mouseout selectstart",c).on("focus blur",c).on("mouseup keydown",function(b){"keydown"==b.type&&(b.ctrlKey||b.metaKey||b.shiftKey||b.altKey)||2!=b.button&&a._selectionChange(250,b)})},_proxyDomEvent:function(a){return this.fireEvent(a.type.replace(/^on/,""),a)},_selectionChange:function(a,c){var f,g,h,d=this,e=!1;browser.ie&&browser.version<9&&c&&"mouseup"==c.type&&(h=this.selection.getRange(),h.collapsed||(e=!0,f=c.clientX,g=c.clientY)),clearTimeout(b),b=setTimeout(function(){var a,h;if(d.selection.getNative()){if(e&&"None"==d.selection.getNative().type){a=d.document.body.createTextRange();try{a.moveToPoint(f,g)}catch(b){a=null}}a&&(h=d.selection.getIERange,d.selection.getIERange=function(){return a}),d.selection.cache(),h&&(d.selection.getIERange=h),d.selection._cachedRange&&d.selection._cachedStartElement&&(d.fireEvent("beforeselectionchange"),d.fireEvent("selectionchange",!!c),d.fireEvent("afterselectionchange"),d.selection.clear())}},a||50)},_callCmdFn:function(a,b){b=Array.prototype.slice.call(b,0);var d,e,c=b.shift().toLowerCase();return d=this.commands[c]||UM.commands[c],e=d&&d[a],d&&e||"queryCommandState"!=a?e?e.apply(this,[c].concat(b)):void 0:0},execCommand:function(a){var b,d,c,e;return this.isFocus()||(b=this.selection._bakRange,b?b.select():this.focus(!0)),a=a.toLowerCase(),c=this,e=c.commands[a]||UM.commands[a],e&&e.execCommand?(e.notNeedUndo||c.__hasEnterExecCommand?(d=this._callCmdFn("execCommand",arguments),!c.__hasEnterExecCommand&&!e.ignoreContentChange&&!c._ignoreContentChange&&c.fireEvent("contentchange")):(c.__hasEnterExecCommand=!0,-1!=c.queryCommandState.apply(c,arguments)&&(c.fireEvent("saveScene"),c.fireEvent("beforeexeccommand",a),d=this._callCmdFn("execCommand",arguments),!e.ignoreContentChange&&!c._ignoreContentChange&&c.fireEvent("contentchange"),c.fireEvent("afterexeccommand",a),c.fireEvent("saveScene")),c.__hasEnterExecCommand=!1),!c.__hasEnterExecCommand&&!e.ignoreContentChange&&!c._ignoreContentChange&&c._selectionChange(),d):null},queryCommandState:function(){try{return this._callCmdFn("queryCommandState",arguments)}catch(b){return 0}},queryCommandValue:function(){try{return this._callCmdFn("queryCommandValue",arguments)}catch(b){return null}},hasContents:function(a){var c,b,d,f,e;if(a)for(b=0;c=a[b++];)if(this.body.getElementsByTagName(c).length>0)return!0;if(!domUtils.isEmptyBlock(this.body))return!0;for(a=["div"],b=0;c=a[b++];)for(d=domUtils.getElementsByTagName(this.body,c),e=0;f=d[e++];)if(domUtils.isCustomeNode(f))return!0;return!1},reset:function(){this.fireEvent("reset")},isEnabled:function(){return 1!=this._isEnabled},setEnabled:function(){var b,a=this;if(a.body.contentEditable=!0,a.lastBk){b=a.selection.getRange();try{b.moveToBookmark(a.lastBk),delete a.lastBk}catch(c){b.setStartAtFirst(a.body).collapse(!0)}b.select(!0)}a.bkqueryCommandState&&(a.queryCommandState=a.bkqueryCommandState,delete a.bkqueryCommandState),a._bkproxyDomEvent&&(a._proxyDomEvent=a._bkproxyDomEvent,delete a._bkproxyDomEvent),a.fireEvent("setEnabled")},enable:function(){return this.setEnabled()},setDisabled:function(a,b){var c=this;c.body.contentEditable=!1,c._except=a?utils.isArray(a)?a:[a]:[],c.lastBk||(c.lastBk=c.selection.getRange().createBookmark(!0)),c.bkqueryCommandState||(c.bkqueryCommandState=c.queryCommandState,c.queryCommandState=function(a){return-1!=utils.indexOf(c._except,a)?c.bkqueryCommandState.apply(c,arguments):-1}),b||c._bkproxyDomEvent||(c._bkproxyDomEvent=c._proxyDomEvent,c._proxyDomEvent=function(){return!1}),c.fireEvent("selectionchange"),c.fireEvent("setDisabled",c._except)},disable:function(a){return this.setDisabled(a)},_setDefaultContent:function(){function a(){var b=this;b.document.getElementById("initContent")&&(b.body.innerHTML="<p>"+(ie?"":"<br/>")+"</p>",b.removeListener("firstBeforeExecCommand focus",a),setTimeout(function(){b.focus(),b._selectionChange()},0))}return function(b){var c=this;c.body.innerHTML='<p id="initContent">'+b+"</p>",c.addListener("firstBeforeExecCommand focus",a)}}(),setShow:function(){var a=this,b=a.selection.getRange();if("none"==a.container.style.display){try{b.moveToBookmark(a.lastBk),delete a.lastBk}catch(c){b.setStartAtFirst(a.body).collapse(!0)}setTimeout(function(){b.select(!0)},100),a.container.style.display=""}},show:function(){return this.setShow()},setHide:function(){var a=this;a.lastBk||(a.lastBk=a.selection.getRange().createBookmark(!0)),a.container.style.display="none"},hide:function(){return this.setHide()},getLang:function(a){var d,c,b=UM.I18N[this.options.lang];if(!b)throw Error("not import language file");for(a=(a||"").split("."),c=0;(d=a[c++])&&(b=b[d],b););return b},getContentLength:function(a,b){var e,d,c=this.getContent(!1,!1,!0).length;if(a)for(b=(b||[]).concat(["hr","img","iframe"]),c=this.getContentTxt().replace(/[\t\r\n]+/g,"").length,d=0;e=b[d++];)c+=this.body.getElementsByTagName(e).length;return c},addInputRule:function(a,b){a.ignoreUndo=b,this.inputRules.push(a)},filterInputRule:function(a,b){for(var d,c=0;d=this.inputRules[c++];)b&&d.ignoreUndo||d.call(this,a)},addOutputRule:function(a,b){a.ignoreUndo=b,this.outputRules.push(a)},filterOutputRule:function(a,b){for(var d,c=0;d=this.outputRules[c++];)b&&d.ignoreUndo||d.call(this,a)}},utils.inherits(f,EventBase)}();