UM.plugins["undo"]=function(){function h(a,b){if(a.length!=b.length)return 0;for(var c=0,d=a.length;d>c;c++)if(a[c]!=b[c])return 0;return 1}function i(a,b){return a.collapsed!=b.collapsed?0:h(a.startAddress,b.startAddress)&&h(a.endAddress,b.endAddress)?1:0}function j(){this.list=[],this.index=0,this.hasUndo=!1,this.hasRedo=!1,this.undo=function(){if(this.hasUndo){if(!this.list[this.index-1]&&1==this.list.length)return this.reset(),void 0;for(;this.list[this.index].content==this.list[this.index-1].content;)if(this.index--,0==this.index)return this.restore(0);this.restore(--this.index)}},this.redo=function(){if(this.hasRedo){for(;this.list[this.index].content==this.list[this.index+1].content;)if(this.index++,this.index==this.list.length-1)return this.restore(this.index);this.restore(++this.index)}},this.restore=function(){var d,h,a=this.editor,b=this.list[this.index],c=UM.htmlparser(b.content.replace(e,""));a.options.autoClearEmptyNode=!1,a.filterInputRule(c,!0),a.options.autoClearEmptyNode=g,a.body.innerHTML=c.toHtml(),a.fireEvent("afterscencerestore"),browser.ie&&utils.each(domUtils.getElementsByTagName(a.document,"td th caption p"),function(b){domUtils.isEmptyNode(b)&&domUtils.fillNode(a.document,b)});try{d=new dom.Range(a.document,a.body).moveToAddress(b.address),browser.ie&&d.collapsed&&1==d.startContainer.nodeType&&(h=d.startContainer.childNodes[d.startOffset],(!h||1==h.nodeType&&dtd.$empty[h])&&d.insertNode(a.document.createTextNode(" ")).collapse(!0)),d.select(f[d.startContainer.nodeName.toLowerCase()])}catch(i){}this.update(),this.clearKey(),a.fireEvent("reset",!0)},this.getScene=function(){var d,e,a=this.editor,b=a.selection.getRange(),c=b.createAddress(!1,!0);return a.fireEvent("beforegetscene"),d=UM.htmlparser(a.body.innerHTML,!0),a.options.autoClearEmptyNode=!1,a.filterOutputRule(d,!0),a.options.autoClearEmptyNode=g,e=d.toHtml(),browser.ie&&(e=e.replace(/>&nbsp;</g,"><").replace(/\s*</g,"<").replace(/>\s*/g,">")),a.fireEvent("aftergetscene"),{address:c,content:e}},this.save=function(b,d){clearTimeout(a);var e=this.getScene(d),f=this.list[this.index];f&&f.content==e.content&&(b?1:i(f.address,e.address))||(this.list=this.list.slice(0,this.index+1),this.list.push(e),this.list.length>c&&this.list.shift(),this.index=this.list.length-1,this.clearKey(),this.update())},this.update=function(){this.hasRedo=!!this.list[this.index+1],this.hasUndo=!!this.list[this.index-1]},this.reset=function(){this.list=[],this.index=0,this.hasUndo=!1,this.hasRedo=!1,this.clearKey()},this.clearKey=function(){m=0,n=null}}function k(){this.undoManger.save()}var a,n,l,m,o,p,b=this,c=b.options.maxUndoCount||20,d=b.options.maxInputCount||20,e=new RegExp(domUtils.fillChar+"|</hr>","gi"),f={ol:1,ul:1,table:1,tbody:1,tr:1,body:1},g=b.options.autoClearEmptyNode;b.undoManger=new j,b.undoManger.editor=b,b.addListener("saveScene",function(){var a=Array.prototype.splice.call(arguments,1);this.undoManger.save.apply(this.undoManger,a)}),b.addListener("beforeexeccommand",k),b.addListener("afterexeccommand",k),b.addListener("reset",function(a,b){b||this.undoManger.reset()}),b.commands["redo"]=b.commands["undo"]={execCommand:function(a){this.undoManger[a]()},queryCommandState:function(a){return this.undoManger["has"+("undo"==a.toLowerCase()?"Undo":"Redo")]?0:-1},notNeedUndo:1},l={16:1,17:1,18:1,37:1,38:1,39:1,40:1},m=0,o=!1,b.addListener("ready",function(){$(this.body).on("compositionstart",function(){o=!0}).on("compositionend",function(){o=!1})}),b.addshortcutkey({Undo:"ctrl+90",Redo:"ctrl+89,shift+ctrl+z"}),p=!0,b.addListener("keydown",function(b,c){function g(a){a.selection.getRange().collapsed&&a.fireEvent("contentchange"),a.undoManger.save(!1,!0),a.fireEvent("selectionchange")}var e=this,f=c.keyCode||c.which;if(!(l[f]||c.ctrlKey||c.metaKey||c.shiftKey||c.altKey)){if(o)return;if(!e.selection.getRange().collapsed)return e.undoManger.save(!1,!0),p=!1,void 0;0==e.undoManger.list.length&&e.undoManger.save(!0),clearTimeout(a),a=setTimeout(function(){if(o)var a=setInterval(function(){o||(g(e),clearInterval(a))},300);else g(e)},200),n=f,m++,m>=d&&g(e)}}),b.addListener("keyup",function(a,b){var c=b.keyCode||b.which;if(!(l[c]||b.ctrlKey||b.metaKey||b.shiftKey||b.altKey)){if(o)return;p||(this.undoManger.save(!1,!0),p=!0)}})};