<?php
 namespace app\admin\service; use app\common\model\Hooks; class Addons extends Base { function __construct() { parent::__construct(); $this->addons = new \app\common\model\Addons(); } public function getAddonsList($condition = '', $order = '', $field = "\52") { goto q250u; PoqoS: $dirs = array_map("\142\x61\x73\x65\x6e\x61\155\x65", glob($addon_dir . "\x2a", GLOB_ONLYDIR)); goto aao6I; UYzS6: YqyhT: goto FkgUJ; q250u: $sys_addons = new \app\common\model\Addons(); goto uBxg3; L8OAN: return $addons; goto bgUfC; aao6I: if (!($dirs === FALSE || !file_exists($addon_dir))) { goto YqyhT; } goto HyK9V; FjmGV: $addon_dir = ADDON_PATH; goto M_vA2; FkUmJ: foreach ($dirs as $value) { goto euzk5; Z1beL: Gs1yF: goto p2DOf; tJtmA: $addons[$value] = $obj->info; goto CXCAi; dhh6j: \think\Log::record("\xe6\x8f\222\xe4\273\266" . $value . "\xe7\x9a\x84\xe5\205\245\345\x8f\243\xe6\x96\x87\344\273\266\344\xb8\215\xe5\255\230\xe5\x9c\xa8\xef\xbc\x81"); goto U65Lv; p2DOf: XLPCD: goto naYXU; Z52fw: $obj = new $class(); goto tJtmA; IsPN6: trace($class); goto dhh6j; jSeTt: unset($addons[$value]["\x73\x74\141\x74\165\x73"]); goto Z1beL; naYXU: NXTTI: goto fCdfK; U65Lv: goto NXTTI; goto KMqaF; DXiGM: $class = get_addon_class($value); goto EKtel; euzk5: if (isset($addons[$value])) { goto XLPCD; } goto DXiGM; CXCAi: if (!$addons[$value]) { goto Gs1yF; } goto kI28W; kI28W: $addons[$value]["\165\x6e\151\156\163\164\141\154\154"] = 1; goto jSeTt; KMqaF: cKlQV: goto Z52fw; EKtel: if (class_exists($class)) { goto cKlQV; } goto IsPN6; fCdfK: } goto cnf7M; M_vA2: oVL07: goto PoqoS; HyK9V: $this->error = "\xe6\217\222\344\xbb\266\xe7\233\xae\345\xbd\x95\xe4\xb8\x8d\345\x8f\xaf\xe8\257\273\346\210\226\xe8\200\x85\xe4\xb8\215\345\255\230\xe5\234\xa8"; goto brO2I; FkgUJ: $addons = array(); goto qf7sm; uBxg3: if ($addon_dir) { goto oVL07; } goto FjmGV; H3TzB: lW8jz: goto sW_xm; brO2I: return FALSE; goto UYzS6; cnf7M: nDPdq: goto L8OAN; qf7sm: $where["\x6e\141\x6d\145"] = array("\151\x6e", $dirs); goto eg5tg; riN3L: foreach ($list as $key => $value) { $list[$key] = $value->toArray(); fqksL: } goto H3TzB; sW_xm: foreach ($list as $addon) { goto o0z3_; o0z3_: $addon["\165\156\x69\156\163\x74\x61\154\154"] = 0; goto cAIX3; rIA9D: IremD: goto ldOfW; cAIX3: $addons[$addon["\156\141\x6d\x65"]] = $addon; goto rIA9D; ldOfW: } goto z737a; eg5tg: $list = $sys_addons->getQuerys($where, "\x2a", "\143\x72\145\141\x74\145\x5f\164\x69\155\145\40\144\x65\163\x63"); goto riN3L; z737a: rEVFr: goto FkUmJ; bgUfC: } public function addAddons($name, $title, $description, $status, $config, $author, $version, $content) { goto P5SSo; non_B: $data = array("\156\141\155\145" => $name, "\x74\x69\164\x6c\145" => $title, "\x64\x65\x73\143" => $description, "\163\x74\141\x74\165\x73" => $status, "\143\157\156\146\x69\x67" => $config, "\141\x75\164\150\157\162" => $author, "\166\x65\x72\163\151\157\x6e" => $version, "\x63\x6f\x6e\164\145\x6e\164" => $content, "\x63\162\x65\141\164\x65\x5f\x74\x69\x6d\x65" => time()); goto hscpg; hscpg: $res = $sys_addons->save($data); goto MJ0n9; MJ0n9: return $sys_addons->id; goto dFggl; P5SSo: $sys_addons = new \app\common\model\Addons(); goto non_B; dFggl: } public function updateHooks($addons_name) { goto FdsBr; CXzNd: foreach ($common as $hook) { goto L9hwE; CM4o9: return false; goto cETKT; fs1xv: if (!(false === $flag)) { goto gj0zj; } goto RaynZ; RaynZ: $this->removeHooks($addons_name); goto CM4o9; L9hwE: $flag = $this->updateAddons($hook, array($addons_name)); goto fs1xv; m7N0q: Op7Kh: goto q5LjR; cETKT: gj0zj: goto m7N0q; q5LjR: } goto TMyJq; fhzHW: m7_Wz: goto qkzf5; qkzf5: $methods = get_class_methods($addons_class); goto Fd0vP; OjD1r: $this->error = "\xe6\x9c\xaa\xe5\xae\x9e\347\216\xb0{$addons_name}\xe6\x8f\222\344\xbb\266\xe7\232\x84\xe5\x85\245\xe5\217\xa3\xe6\x96\207\xe4\xbb\266"; goto mBwIQ; Fd0vP: $hooks = $sys_hooks->column("\156\x61\x6d\145"); goto s_jlc; TMyJq: xDybf: goto B0PeF; s_jlc: $common = array_intersect($hooks, $methods); goto y1FOn; mBwIQ: return false; goto fhzHW; B0PeF: Mdy1k: goto iRRaQ; y1FOn: if (empty($common)) { goto Mdy1k; } goto CXzNd; HQmTX: if (class_exists($addons_class)) { goto m7_Wz; } goto OjD1r; FdsBr: $sys_hooks = new Hooks(); goto Z3jYB; Z3jYB: $addons_class = get_addon_class($addons_name); goto HQmTX; iRRaQ: return true; goto SYyw3; SYyw3: } public function updateAddons($hook_name, $addons_name) { goto JH3rx; zqexN: $sys_hooks->save(["\141\x64\x64\157\x6e\x73" => $o_addons], ["\156\x61\x6d\145" => $hook_name]); goto CSpuN; xS1_i: goto lIi4a; goto W_S6k; cplCq: return $res; goto zKurE; CSpuN: MaAYe: goto cplCq; WAPVB: $addons = array_merge($o_addons, $addons_name); goto nt6UR; kEnwz: iyaMI: goto ix_WW; zvgth: $addons = $addons_name; goto xS1_i; mqbZI: $res = $sys_hooks->save(["\x61\144\144\157\156\x73" => $addons], ["\x6e\141\155\x65" => $hook_name]); goto hFX7N; W_S6k: tCZmq: goto WAPVB; hFX7N: if (!(false === $res)) { goto MaAYe; } goto zqexN; WDDhj: if (!$o_addons) { goto DhLPd; } goto WAECB; FkbJj: $o_addons = $hooks_info["\141\144\x64\157\x6e\x73"]; goto H50tv; WAECB: $o_addons = implode("\x2c", $o_addons); goto coTR6; H50tv: if (!$o_addons) { goto iyaMI; } goto nJwmz; nJwmz: $o_addons = explode("\54", $o_addons); goto kEnwz; nt6UR: $addons = array_unique($addons); goto izMg8; JH3rx: $sys_hooks = new Hooks(); goto bLSLX; izMg8: lIi4a: goto LUjZU; bLSLX: $hooks_info = $sys_hooks->getInfo(["\x6e\141\155\x65" => $hook_name], "\x61\144\x64\x6f\156\x73"); goto FkbJj; coTR6: DhLPd: goto mqbZI; LUjZU: $addons = implode("\54", $addons); goto WDDhj; ix_WW: if ($o_addons) { goto tCZmq; } goto zvgth; zKurE: } public function removeHooks($addons_name) { goto SK1xV; grDv4: $methods = get_class_methods($addons_class); goto siAlV; Ho_s9: I3VfG: goto grDv4; KhkcJ: return false; goto Ho_s9; XsHCC: $addons_class = get_addon_class($addons_name); goto eohiE; cUKmZ: return true; goto LR2uW; eohiE: if (class_exists($addons_class)) { goto I3VfG; } goto KhkcJ; ILoVV: A__CG: goto cUKmZ; HvxTG: $common = array_intersect($hooks, $methods); goto ierU_; sLgrL: IJ42B: goto ILoVV; ierU_: if (!$common) { goto A__CG; } goto fzh48; siAlV: $hooks = $sys_hooks->column("\156\141\155\145"); goto HvxTG; fzh48: foreach ($common as $hook) { goto g5QCE; uAyZs: Zvsr5: goto mtYXA; VnIXF: return false; goto uAyZs; g5QCE: $flag = $this->removeAddons($hook, array($addons_name)); goto u9pmM; mtYXA: kN3Br: goto X0n00; u9pmM: if (!(false === $flag)) { goto Zvsr5; } goto VnIXF; X0n00: } goto sLgrL; SK1xV: $sys_hooks = new Hooks(); goto XsHCC; LR2uW: } public function removeAddons($hook_name, $addons_name) { goto x_IgW; jax97: goto wj4Lr; goto sEh3N; T6lAa: $o_addons = explode("\54", $hooks_info["\x61\144\144\157\156\x73"]); goto E1DDr; WyUh0: $sys_hooks->save(["\x61\x64\144\x6f\x6e\163" => $o_addons], ["\156\x61\x6d\x65" => $hook_name]); goto MKne1; UwKzE: return true; goto jax97; E1DDr: if ($o_addons) { goto ua9GN; } goto UwKzE; sEh3N: ua9GN: goto VV5ee; o3BNO: if (!(false === $flag)) { goto dcCvg; } goto WyUh0; VV5ee: $addons = array_diff($o_addons, $addons_name); goto YTBcy; vfu1a: $o_addons = implode("\54", $o_addons); goto iWEFu; iWEFu: $flag = $sys_hooks->save(["\141\144\x64\x6f\156\163" => $addons], ["\x6e\141\155\x65" => $hook_name]); goto o3BNO; MKne1: dcCvg: goto PkicX; zX2PC: $addons = implode("\54", $addons); goto vfu1a; PkicX: return $flag; goto Cm1ZU; Lc50S: $hooks_info = $sys_hooks->getInfo(["\156\x61\155\x65" => $hook_name], "\141\144\x64\x6f\x6e\163"); goto T6lAa; YTBcy: wj4Lr: goto zX2PC; x_IgW: $sys_hooks = new Hooks(); goto Lc50S; Cm1ZU: } public function getAddonsInfo($condition, $field = "\x2a") { $sys_addons = new \app\common\model\Addons(); return $sys_addons->getInfo($condition, $field); } public function deleteAddons($condition) { $sys_addons = new \app\common\model\Addons(); return $sys_addons->destroy($condition); } }
