<?php
 namespace app\images\service; load()->func("\146\x69\154\x65"); use think\Db; class Index { protected $bus_id; protected $url_prefix = ''; public function __construct($id) { $this->bus_id = $id; } public function init() { goto TgKhx; I8y1l: VzHYw: goto xnaR3; gGYeu: Db::tb("\151\155\x61\147\145\x73\137\x67\x72\x6f\165\x70")->insert($data); goto I8y1l; m7hP0: if (!empty($default)) { goto VzHYw; } goto CqnFM; CqnFM: $data = array("\147\x72\x6f\x75\x70\x5f\151\x64" => "\61", "\147\162\x6f\x75\160\137\156\141\x6d\145" => "\351\xbb\230\350\256\244\xe7\233\xb8\xe5\x86\214", "\163\x6f\162\x74" => 0, "\151\x73\x5f\x64\x65\146\x61\x75\154\x74" => 1, "\155\x63\150\137\151\144" => $this->bus_id); goto gGYeu; TgKhx: $default = Db::tb("\151\x6d\141\147\x65\163\137\147\162\x6f\x75\160")->where(["\x67\x72\157\x75\160\137\151\x64" => 1, "\151\x73\x5f\x64\145\146\x61\x75\154\164" => 1])->find(); goto m7hP0; xnaR3: } public function addAlbum($group_name, $sort) { goto bv8Pq; BmfSh: $res = Db::tb("\151\155\141\147\145\163\x5f\147\x72\x6f\x75\160")->insertGetId($data); goto eSb8h; eSb8h: return $res; goto Y2R1_; bv8Pq: $data = array("\147\162\157\165\160\x5f\x6e\141\x6d\x65" => $group_name, "\163\x6f\x72\164" => $sort, "\x69\x73\x5f\x64\x65\x66\x61\x75\x6c\x74" => 0, "\155\x63\150\137\x69\144" => $this->bus_id); goto BmfSh; Y2R1_: } public function album_rename($group_id, $name) { $res = Db::tb("\151\x6d\x61\147\x65\163\x5f\x67\x72\x6f\165\x70")->where("\x6d\143\x68\137\x69\144", $this->bus_id)->where("\x67\162\157\x75\x70\x5f\x69\x64", $group_id)->update(["\147\162\x6f\x75\160\137\x6e\x61\155\x65" => $name]); return $res; } public function album_del($group_id) { goto mPpdM; M7BNd: $this->album_images_del($img_ids); goto fate3; GYGtI: foreach ($imgs as $img) { $img_ids[] = $img["\x69\x6d\147\x5f\x69\144"]; XWi33: } goto xjaM_; mPpdM: $where["\x67\162\x6f\165\160\x5f\x69\144"] = $group_id; goto f_ad6; f_ad6: $imgs = Db::tb("\151\155\141\x67\x65\x73")->where($where)->field("\151\155\x67\137\x69\x64")->select(); goto Co2ey; Co2ey: $img_ids = array(); goto GYGtI; BSEvK: return $res; goto X9jTT; fate3: $res = Db::tb("\x69\155\x61\147\145\163\x5f\147\x72\157\x75\160")->where($where)->delete(); goto BSEvK; xjaM_: g_qbE: goto M7BNd; X9jTT: } public function getAlbumList($search_text = '') { goto Dy0vH; MiTdh: $condition["\147\56\155\143\150\137\x69\x64"] = array("\x65\x71", $this->bus_id); goto VZ3Wo; ibvkq: zyEHT: goto SX8x0; Dy0vH: if (!($search_text !== '')) { goto z94LU; } goto pkVrg; A6KxJ: foreach ($list as $k => &$v) { goto TXpBh; tPSME: $v["\x69\155\x67\x5f\x63\x6f\x75\x6e\164"] = $count; goto f1FER; f1FER: n4Lba: goto YcKas; TXpBh: $count = $this->getAlbumPictureCount($v["\147\x72\x6f\x75\x70\137\x69\x64"]); goto tPSME; YcKas: } goto ibvkq; pkVrg: $condition["\x67\56\x67\x72\x6f\165\x70\137\x6e\x61\x6d\x65"] = ["\x6c\151\x6b\x65", "\45" . $search_text . "\45"]; goto v7vaP; QQva5: $list = json_decode(json_encode($list, true), true)["\x64\x61\x74\141"]; goto A6KxJ; VZ3Wo: $list = Db::tb("\x69\155\x61\147\x65\x73\x5f\x67\162\157\x75\160")->alias("\x67")->join("\151\x6d\x61\x67\145\x73\40\151", "\x67\56\147\x72\x6f\x75\160\x5f\143\x6f\x76\x65\x72\40\x3d\x20\x69\56\151\x6d\147\137\x69\144", "\x4c\105\106\124")->where($condition)->order("\147\56\163\157\162\x74\x20\x61\163\x63")->field("\147\56\x2a\x2c\x69\x2e\151\155\147\137\143\x6f\166\x65\162\40\141\163\x20\141\154\x62\165\x6d\137\143\x6f\166\145\162")->paginate(20); goto cBirA; cBirA: $page = $list->render(); goto QQva5; v7vaP: z94LU: goto MiTdh; SX8x0: return [$list, $page]; goto KJxj2; KJxj2: } public function getAlbumAll() { goto tQL1r; K6_jM: return $list; goto S3rq8; q8Ijq: $list = Db::tb("\x69\x6d\141\x67\x65\163\x5f\x67\162\x6f\x75\x70")->alias("\147")->join("\x69\x6d\141\147\x65\163\x20\x69", "\x67\x2e\147\x72\x6f\165\160\137\x63\157\x76\x65\x72\x20\75\x20\151\x2e\151\x6d\x67\137\x69\144", "\114\x45\106\124")->where($condition)->order("\147\x2e\163\157\162\x74\x20\x61\x73\x63")->field("\147\x2e\52\54\151\x2e\x69\155\147\137\143\157\x76\145\x72\40\141\163\40\x61\154\142\x75\x6d\x5f\x63\x6f\x76\145\x72")->select(); goto P7p0t; tQL1r: $condition["\147\x2e\155\x63\x68\137\x69\144"] = array("\145\x71", $this->bus_id); goto q8Ijq; P7p0t: foreach ($list as $k => &$v) { goto KApap; KApap: $count = $this->getAlbumPictureCount($v["\147\x72\157\165\160\x5f\151\x64"]); goto wchlE; wchlE: $v["\151\x6d\147\x5f\x63\157\x75\x6e\164"] = $count; goto t_Uvu; t_Uvu: df3DX: goto F1fOM; F1fOM: } goto M_E5k; M_E5k: Chaur: goto K6_jM; S3rq8: } public function getPictureList($group_id) { goto XqfOq; XqfOq: $condition = array("\147\162\157\165\x70\x5f\151\144" => $group_id); goto wUiQL; MPCwr: $page = $list->render(); goto jbQEi; jbQEi: return [$list, $page]; goto QH239; wUiQL: $list = Db::tb("\x69\155\x61\147\x65\163")->where($condition)->order("\x75\160\x6c\157\141\144\x5f\164\151\155\145\x20\144\x65\x73\143")->paginate(30); goto MPCwr; QH239: } public function getPictureAll($group_id) { goto mISXP; Rsarf: return $list; goto p81Oi; mISXP: $condition = array("\147\162\157\x75\x70\x5f\x69\144" => $group_id); goto mTuU1; mTuU1: $list = Db::tb("\x69\x6d\x61\147\145\163")->where($condition)->order("\165\x70\154\x6f\x61\x64\137\x74\x69\155\145\x20\x64\145\x73\x63")->select(); goto Rsarf; p81Oi: } public function imageUpload($group_id) { goto SuSky; Dx_mW: i84Jc: goto ZzwzS; XrYfa: $rs["\155\x73\x67"] = "\xe6\226\x87\344\273\xb6\xe5\xa4\xa7\345\260\217\xe4\xb8\xba\60\115\102"; goto XTAYc; lM2PH: Fggd4: goto fd_Mw; XoQpM: $rs["\155\x73\147"] = "\xe8\xbf\x9c\347\xa8\213\xe9\x99\204\xe4\xbb\266\344\xb8\x8a\344\274\240\345\xa4\261\xe8\264\xa5\xef\274\x8c\xe8\xaf\xb7\xe6\243\x80\xe6\237\xa5\xe9\205\215\347\xbd\256\345\xb9\xb6\351\207\x8d\346\x96\260\344\xb8\x8a\xe4\xbc\xa0"; goto mjyj2; BbLyN: $rs["\x6e\x65\167\x66\151\x6c\x65\x70\141\x74\150"] = $newfilepath; goto h2O91; SVx7p: mkdir($base_path, $mode, true); goto lM2PH; mjyj2: if (!file_exists($newfilepath)) { goto Q2xUd; } goto B70Rf; ho3He: CJZ2A: goto dIpC7; PEERu: goto xOm2_; goto Ydpxv; oITu8: $newfilepath = $base_path . "\x2f" . $newfilename; goto BbLyN; SmTgp: if (!($mimetype != IMAGETYPE_GIF && $mimetype != IMAGETYPE_JPEG && $mimetype != IMAGETYPE_PNG && $mimetype != IMAGETYPE_BMP || $width * $height === 0)) { goto CJZ2A; } goto KbfPj; pg0mZ: $rs["\143\157\144\x65"] = 0; goto khMvN; rNPdm: $rs["\x63\x6f\144\x65"] = 0; goto xeqGD; m2rA3: $rs["\x6f\162\151\x67\151\156\137\156\141\155\x65"] = $file_name; goto vOIAh; khMvN: $rs["\x6d\x73\147"] = "\xe6\226\207\344\xbb\xb6\345\xa4\247\345\xb0\x8f\xe4\270\215\xe8\x83\xbd\350\266\x85\350\277\207\65\115\x42"; goto YryvE; gCYst: unlink($newfilepath); goto Dx_mW; waV3x: return $rs; goto jioOJ; KnaEZ: $ext = pathinfo($file_name, PATHINFO_EXTENSION); goto P8rOi; fd_Mw: $localpath .= "\x2f" . $newfilename; goto oITu8; rMKF1: $rs["\x63\x6f\144\x65"] = 1; goto m2rA3; x03g9: $rs["\156\x61\155\x65"] = $newfilename; goto WB4Vt; kdppY: $base_path = str_replace("\141\160\x70\154\151\143\141\x74\x69\157\156\57", '', APP_PATH) . $localpath; goto CrTms; kpo3p: $file_type = $_FILES["\x66\x69\x6c\x65\x5f\165\x70\154\157\x61\144"]["\x74\171\160\x65"]; goto SWM06; XTAYc: return $rs; goto kwVRX; kCIDv: $file_name = $_FILES["\146\151\154\145\x5f\x75\160\154\x6f\141\144"]["\156\x61\155\145"]; goto viFY6; ZzwzS: return $rs; goto PEERu; iv9xh: if (file_exists($base_path)) { goto Fggd4; } goto cCKaM; nIiVu: $res = Db::tb("\x69\x6d\141\147\x65\x73")->insertGetId(["\147\x72\157\x75\x70\137\151\144" => $group_id, "\151\155\147\x5f\156\x61\x6d\145" => $newfilename, "\151\155\x67\x5f\x63\x6f\166\x65\162" => $remoteurl]); goto Q0Llc; bFGdH: DwkUT: goto KnaEZ; CrTms: goto vvbhS; goto Enhrk; jioOJ: xOm2_: goto LcxrO; WB4Vt: $rs["\x75\162\154"] = $remoteurl; goto OukJw; Enhrk: Y72O4: goto K0nMl; t1kA9: if (!file_exists($newfilepath)) { goto i84Jc; } goto gCYst; uYbCP: By0Ch: goto tF9Lt; OukJw: $rs["\x69\144"] = $res; goto t1kA9; LcxrO: vqDo2: goto jFp7v; kwVRX: ZoNvL: goto wL3zy; Q0Llc: $rs["\143\157\144\145"] = 1; goto LWiQA; xeqGD: $rs["\155\163\147"] = "\xe6\226\x87\344\273\xb6\xe4\xbf\x9d\xe5\xad\230\345\244\xb1\xe8\264\245"; goto h1kc3; viFY6: $file_size = $_FILES["\x66\151\154\x65\x5f\165\160\x6c\157\x61\x64"]["\x73\x69\172\145"]; goto kpo3p; VAOjZ: return $rs; goto bFGdH; SWM06: if (!($file_size == 0)) { goto ZoNvL; } goto cuKtL; HJw3m: $localpath = "\x70\165\x62\154\x69\x63\57\165\160\154\157\x61\x64\57" . $this->bus_id . "\x2f" . $group_id; goto kdppY; dxnUV: if (empty($_W["\163\145\x74\164\151\x6e\147"]["\x72\145\x6d\157\x74\x65"]["\x74\x79\x70\x65"])) { goto vqDo2; } goto b9Bjc; jFp7v: $res = Db::tb("\151\155\141\x67\x65\x73")->insertGetId(["\x67\x72\x6f\x75\160\137\151\x64" => $group_id, "\151\155\x67\x5f\x6e\x61\155\x65" => $newfilename, "\151\155\147\x5f\143\x6f\166\x65\162" => $localpath]); goto rMKF1; UTi1U: y0TEJ: goto pmEmd; pb_yL: return $rs; goto ho3He; YryvE: return $rs; goto UTi1U; SuSky: $rs = array(); goto kCIDv; WoZcb: $base_path = ATTACHMENT_ROOT . "\x2f" . $localpath; goto SRFA1; cuKtL: $rs["\x63\157\x64\145"] = 0; goto XrYfa; cCKaM: $mode = intval("\x30\67\x37\67", 8); goto SVx7p; SRFA1: vvbhS: goto iv9xh; vOIAh: $rs["\156\x61\155\x65"] = $newfilename; goto oLxOc; YO5kU: $rs["\x69\x64"] = $res; goto dYVPb; bYMoR: if (is_error($remotestatus)) { goto JaxgC; } goto HhtBf; wL3zy: if (!($file_size > 5242880)) { goto y0TEJ; } goto pg0mZ; dGk3l: Q2xUd: goto waV3x; KbfPj: $rs["\x63\x6f\x64\x65"] = 0; goto QjFUT; h1kc3: return $rs; goto uYbCP; BhLUU: if (in_array($file_type, $alltype)) { goto DwkUT; } goto hDPkE; L3VOY: $rs["\x6d\163\147"] = "\xe6\226\207\xe4\xbb\266\347\261\273\xe5\236\x8b\351\224\231\xe8\xaf\257"; goto VAOjZ; Df5f0: unlink($newfilepath); goto pb_yL; HhtBf: $remoteurl = tomedia($localpath); goto nIiVu; pmEmd: $alltype = ["\151\155\x61\147\145\x2f\152\160\x67", "\x69\x6d\141\147\145\57\x6a\160\145\x67", "\x69\155\141\147\x65\x2f\x70\x6e\147", "\151\155\x61\147\x65\57\147\x69\146"]; goto BhLUU; tF9Lt: list($width, $height, $mimetype) = @getimagesize($newfilepath); goto SmTgp; P8rOi: $newfilename = md5($file_name . time()) . "\x2e" . $ext; goto svXKV; dYVPb: return $rs; goto AkORD; Ydpxv: JaxgC: goto aqg0I; LWiQA: $rs["\x6f\x72\x69\147\x69\x6e\x5f\156\x61\155\x65"] = $file_name; goto x03g9; hDPkE: $rs["\x63\x6f\144\145"] = 0; goto L3VOY; aqg0I: $rs["\x63\157\144\x65"] = 0; goto XoQpM; K0nMl: $localpath = $_W["\x61\x63\x63\157\165\156\164"]["\141\x64\x64\157\156\163"] . "\x2f" . $this->bus_id . "\x2f" . $group_id; goto WoZcb; B70Rf: unlink($newfilepath); goto dGk3l; oLxOc: $rs["\x75\x72\x6c"] = $localpath; goto YO5kU; ON31W: if (!(!$ok || !file_exists($newfilepath))) { goto By0Ch; } goto rNPdm; QjFUT: $rs["\x6d\163\147"] = "\346\226\x87\xe4\xbb\266\347\xb1\273\xe5\236\213\xe9\224\x99\xe8\257\xaf"; goto Df5f0; b9Bjc: $remotestatus = file_remote_upload($localpath); goto bYMoR; h2O91: $ok = @move_uploaded_file($_FILES["\146\151\154\145\x5f\x75\x70\154\157\141\x64"]["\x74\155\x70\x5f\156\141\155\145"], $newfilepath); goto ON31W; svXKV: if (!empty($_W["\163\145\x74\164\151\x6e\147"]["\x72\145\155\x6f\x74\x65"]["\x74\x79\160\x65"])) { goto Y72O4; } goto HJw3m; dIpC7: global $_W; goto dxnUV; AkORD: } public function ImgUrl($path) { goto kpa0D; SJ1PA: $parr = explode("\141\x64\144\x6f\x6e\163", $self); goto j4Vcp; BaIqu: if (!(count($parr) > 1)) { goto c2gx6; } goto fs1zz; Y6649: return $path; goto dtFGy; kpa0D: if (!(strpos($path, "\150\x74\x74\160\72\x2f\x2f") !== false || strpos($path, "\x68\164\x74\x70\163\72\57\x2f") !== false)) { goto Ce1FF; } goto Y6649; OhjYZ: return $url; goto SyZzp; tVqNR: $this->url_prefix = "\x68\x74\x74\160\x73\72\x2f\x2f" . $host . "\x2f" . $subdir . "\x2f"; goto IudNh; j4Vcp: $subdir = ''; goto BaIqu; nfwB5: if (!($this->url_prefix === '')) { goto IbShf; } goto jpJ3O; dtFGy: Ce1FF: goto nfwB5; IudNh: IbShf: goto FHjQW; fs1zz: $subdir = str_replace("\57", '', $parr[0]); goto Utihd; jpJ3O: $self = $_SERVER["\120\110\120\x5f\x53\105\x4c\x46"]; goto SJ1PA; Utihd: c2gx6: goto RZzAk; FHjQW: $url = $this->url_prefix . $path; goto OhjYZ; RZzAk: $host = explode("\x3a", $_SERVER["\x48\124\124\120\x5f\110\x4f\x53\124"])[0]; goto tVqNR; SyZzp: } public function album_cover($img_id) { goto Mlb8G; yVdhk: $res = Db::tb("\151\x6d\x61\x67\x65\163\x5f\147\x72\x6f\x75\160")->where(["\x67\x72\x6f\x75\160\137\151\x64" => $img["\x67\162\x6f\x75\160\x5f\x69\144"]])->update(["\x67\x72\157\165\x70\x5f\x63\x6f\x76\x65\x72" => $img_id]); goto I4aJu; vT922: nB2pT: goto yVdhk; I4aJu: return $res === false ? 1 : $res; goto cM6pe; I2Mrq: $group = Db::tb("\151\x6d\141\147\x65\163\x5f\147\162\x6f\165\x70")->where(["\x67\162\x6f\x75\160\137\x69\x64" => $img["\x67\162\x6f\165\160\x5f\151\144"]])->find(); goto pzB0P; Mlb8G: $img = Db::tb("\151\155\141\x67\145\x73")->where(["\151\x6d\147\137\x69\x64" => $img_id])->find(); goto I2Mrq; pzB0P: if (!($group["\x67\162\x6f\165\x70\x5f\143\157\166\145\162"] === $img_id)) { goto nB2pT; } goto GMH2B; GMH2B: return 1; goto vT922; cM6pe: } public function album_images_move($img_ids, $group_id) { $res = Db::tb("\151\155\141\x67\x65\163")->where("\x69\x6d\147\137\x69\x64", "\x69\x6e", $img_ids)->update(["\147\x72\157\x75\x70\x5f\151\144" => $group_id]); return $res; } public function album_images_del($img_ids) { goto MlIZn; LLB9s: ECp2F: goto ORaMA; ORaMA: foreach ($imgs as $k => $v) { goto SyuB4; SyuB4: if (strpos($v, "\x68\164\164\160\x3a\57\57") === false && strpos($v, "\150\x74\x74\x70\x73\72\x2f\57") === false) { goto y_fzs; } goto xCyPx; xCyPx: file_remote_delete($v); goto zsj2M; SYXpX: y_0vH: goto lgYdi; JqDTL: if (!file_exists($file_path)) { goto y_0vH; } goto Mgilh; qlNeQ: $file_path = str_replace("\141\160\x70\x6c\151\143\x61\x74\151\x6f\156\x2f", '', APP_PATH) . $v; goto JqDTL; XG0Ny: y_fzs: goto qlNeQ; zsj2M: goto Gignk; goto XG0Ny; lgYdi: Gignk: goto tscZx; Mgilh: unlink($file_path); goto SYXpX; tscZx: r_abe: goto kVjyj; kVjyj: } goto wA2TS; MlIZn: $where["\x69\155\147\137\151\x64"] = ["\x69\x6e", $img_ids]; goto RCOCK; YNZcf: return $res; goto ScCcJ; aeqGu: foreach ($all_imgs as $item) { $imgs[$item["\151\x6d\x67\x5f\151\x64"] . ''] = $item["\151\155\x67\x5f\x63\157\166\145\x72"]; Z_HX0: } goto LLB9s; RCOCK: $all_imgs = Db::tb("\x69\155\x61\x67\x65\x73")->where($where)->field("\151\x6d\147\x5f\151\144\54\151\x6d\147\x5f\143\157\166\145\x72")->select(); goto L75C2; BUTxj: $res = Db::tb("\151\155\x61\x67\x65\163")->where($where)->delete(); goto YNZcf; wA2TS: gs2PH: goto BUTxj; L75C2: $imgs = array(); goto aeqGu; ScCcJ: } private function getAlbumPictureCount($group_id) { $count = Db::tb("\x69\155\141\x67\145\163")->where("\x67\x72\157\x75\x70\137\x69\144", $group_id)->count(); return $count; } }
