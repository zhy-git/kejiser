<html>
<head>

    <link rel="stylesheet" href="application/images/public/css/bast/bootstrap.css"/>
    <link rel="stylesheet" href="application/images/public/css/common.css"/>
    <link rel="stylesheet" href="application/images/public/css/dialogalbumlist.css"/>
    <link rel="stylesheet" href="application/images/public/css/ns_blue_common.css"/>

    <script src="application/images/public/js/jquery-2.1.1.js"></script>
    <script src="application/images/public/js/layer/2.4/layer.js"></script>
    <script src="application/images/public/js/public_js.js"></script>

    <style>
        .dislog-style ul {
            width: 100%;
            margin: 0;
        }
        .mytable{border-bottom: solid 1px #DDD;}
        .dislog-style ul li span {
            display: inline-block;
            width: 60px;
            text-align: center;
            height: 30px;
            line-height: 30px;
        }
        .dislog-style ul li input {
            width: 200px;
            height: 30px;
        }
        .album-img {
            margin-top: 5px;
            display: inline-block;
            border-radius: 50px;
            background-color: #FFF;
            height: 20px;
            width: 20px;
            line-height: 20px;
            text-align: center;
        }
        .album-img-active {
            margin-top: 5px;
            display: inline-block;
            border-radius: 50px;
            background-color: #999;
            height: 20px;
            width: 20px;
            line-height: 20px;
            text-align: center;
            color: #fff;
        }
        .pagination ul li {
            width: auto !important;
            margin-left: 0px !important;
            height: auto !important;
        }
        #turn-ul {
            margin-top: 0;
            position: absolute;
            left: 25%;
            bottom: 0px;
        }
        .pagination-right ul li {
            margin-bottom: 0 !important;
        }
        .input-file{
            position: absolute;
            top: 9px !important;
            right: 9px !important;
            height: 30px !important;
            width: 94px !important;
            filter: alpha(opacity : 0) !important;
            opacity: 0 !important;
            line-height:auto;
        }
        #turn-ul{
            position: static;
        }
        .upload-con {
            top: 50px;
            right: 0px;
        }
        .album-title{
            display: inline-block;
            white-space: nowrap;
            width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .img-li{
            line-height: 116px;
            border:2px  solid #eee;
            text-align:center;
        }
        .img-li img:first-child{
            display: inline-block !important;
            vertical-align: middle !important;
            max-width: 100% !important;
            max-height: 100% !important;
            height: auto !important;
            width:auto !important;
            border:none !important;
        }
        .img-li  .icon_ok{
            bottom:0;
            right:0;
        }
    </style>
</head>
</html>
<body>
<table class="mytable">
    <tr>
        <th width="45%"></th>
        <th width="9%"></th>
        <th width="14%"></th>
        <th width="12%" >
            <a class="btn btn-warning" style="right: 100px;cursor:pointer; position: static;" onclick="layer_show('创建相册', '{:url('images/index/album_add')}' ,400,300)" href="javascript:;"><!--  -->
                创建相册
            </a>
        </th>

        <th width="12%" style="padding-right: 8px;cursor:pointer;">
            <a id="open_uploader" href="javascript:$('#fileupload').click();" style="right: 100px; cursor:pointer;position: static;" class="btn btn-success"  >
               上传图片
            </a>
            <input accept="image/gif, image/jpeg, image/png, image/jpg" type="file" style="cursor:pointer;font-size:0;"id="fileupload" hidefocus="true" size="1" class="input-file" name="file_upload" multiple/>
        </th>

    </tr>
</table>
<input type="hidden" id="group_id" value=""/>
<div class='dialog_main'>
    <div class="dialog_body">
        <aside style="border-right: solid 1px #DDD;">
            <ul id="album_list"></ul>
        </aside>
        <article>
            <ul id="albumList" style="overflow: hidden; width: 100%;"></ul>
            <div style="clear: both;"></div>
        </article>
    </div>
    <footer style="border-top:1px solid #DDD;background-color:#FFF;">
        <span id="select_count"></span>
        <input type="button" value="确认" id="confirm" />
    </footer>
</div>
<div class="common-tip-message js-common-tip">
    <div class="inner"></div>
</div>

{include file="uploadImg"/}

<script type="text/javascript">
    var select_array = {};
    getAlbumClassALL();
    //图片选择数量
    var count = 0;
    //分类查询相册
    function SelectAlbumByType(obj) {
        $(".select_type").removeClass("select_type");
        $(obj).addClass("select_type");
        $("#select_count").css("visibility", "hidden");
        $("#confirm").removeClass("input_blue");
        var group_id = $(".select_type").attr("data-album_id");
        $("#group_id").val(group_id);
        $.ajax({
            type : "post",
            url : "{:url('images/index/getAlbumPictureALL')}",
            data : {"group_id" : group_id},
            dataType: 'json',
            success : function(data) {
                count = 0;
                $("#select_count").css("visibility", "hidden");
                var html = '';
                if (data.length > 0) {
                    for (var i = 0; i < data.length; i++) {
                        html += "<li class='img-li'title='"+data[i]["img_name"]+"'data-id="
                            + data[i]["img_id"]
                            + " img_path='"
                            + data[i]['img_cover']
                            + "' onclick='select_img(this,"
                            + data[i]["img_id"]
                            + ")'><img src='"
                            + data[i]["img_cover"]
                            + "' alt='"
                            + data[i]["img_name"]
                            + "' />";
                        html += "<img src='/application/images/public/images/icon_ok.png' class='icon_ok' /></li>";
                    }
                } else {
                    html += '<div class="none_info">暂无符合条件的数据记录！</div>';
                }
                $("#albumList").html(html);
            }
        });

    }

    //查询相册
    function getAlbumClassALL() {
        $.ajax({
            type : "post",
            url : "{:url('images/index/getAlbumALL')}",
            async : false,
            dataType: 'json',
            success : function(data) {
                var html = '';
                var boxHtml = '';
                if (data.length > 0) {
                    for (var i = 0; i < data.length; i++) {
                        if (data[i]["is_default"] == 1) {
                            $("#group_id").val(data[i]["group_id"]);
                            html += "<li class='select_type' onclick='SelectAlbumByType(this)' data-album_id='" + data[i]['group_id'] + "'>";
                            html += "<b class='album-title'>"+data[i]['group_name'] + "</b><span class='album-img-active'>" + data[i]['img_count'] + "</li>";
                            boxHtml += "<option value='"+data[i]['group_id']+"'  selected>" + data[i]['group_name'] + "</option>";
                        } else {
                            html += "<li onclick='SelectAlbumByType(this)' data-album_id=" + data[i]["group_id"] + ">";
                            html += "<b class='album-title'>" +data[i]["group_name"] + "</b><span  class='album-img'>" + data[i]["img_count"] + "</span></li>";
                            boxHtml += "<option value='"+data[i]['group_id']+"'>" + data[i]['group_name'] + "</option>";
                        }
                    }
                } else {
                    html += '<div class="none_info">暂无符合条件的数据记录！</div>';
                }
                $("#album_list").html(html);
                $(".select_type").click();
            }
        })
    }

    function refreshCount(){
        if (count == 0) {
            $("#select_count").css("visibility", "hidden");
            $("#confirm").removeClass("input_blue");
        } else {
            $("#select_count").css("visibility", "visible");
            $("#confirm").addClass("input_blue");
        }
        if (count > {$num} && {$num} > 0) {
            $("#select_count").text("最多选取"+{$num}+"张照片");
            $("#select_count").css("color", "red");
            $("#confirm").removeClass("input_blue");
        } else {
            $("#select_count").text("已选择" + count + "张");//张照片
            $("#select_count").css("color", "black");
        }
    }
    function select_img(obj) {
        var id = $(obj).attr("data-id");
        var path = $(obj).attr("img_path");
        if ($(obj).hasClass("select_img")) {
            $(obj).removeClass("select_img");
            $(obj).find(".icon_ok").css("display", "none");
            delete(select_array[id]);
            --count;
        } else {
            $(obj).addClass("select_img");
            $(obj).find(".icon_ok").css("display", "block");
            select_array[id] = path;
            ++count;
        }
        refreshCount();
    }

    $("#confirm").click(function() {
        if ($("#confirm").hasClass("input_blue")) {
            console.log('图片选择确认 ----------------------');
            console.log(select_array);
            var data = '{$data}';
            data = JSON.parse(data);
            console.log(data);
            if(parent.images_select)
            {
                parent.images_select(select_array,data);
            }
            parent.layer.closeAll();
        }
    });

</script>
</body>