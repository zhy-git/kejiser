<?php
 namespace app\api\service; use app\common\model\ResOrderPayment; use app\common\model\Config; use app\common\model\ResOrder; use app\common\model\Area; use think\Db; require EXTEND_PATH . "\x57\x78\x70\x61\x79\57\127\x78\120\141\171\x2e\101\160\151\x2e\160\150\160"; class CaterPayService { public function orderInfo($data) { goto tSmeJ; uW94Z: $info = $order->getInfo($data); goto QyK0w; QyK0w: return $info; goto BlidO; tSmeJ: $order = new ResOrder(); goto uW94Z; BlidO: } public function orderPay($data) { goto sv04b; hebEU: $unifiedorder = \WxPayApi::unifiedOrder($input); goto hvHNs; o9NGw: ckqRa: goto DFeWD; EOwcM: u6LXL: goto XegIU; zhCly: GhrNh: goto Osq8M; jG1Oq: $rs["\x63\x6f\x64\x65"] = 1; goto LWJuU; cLMlm: $input->SetOpenid($data["\x6f\160\x65\x6e\151\x64"]); goto Gme3B; YyFVT: if (!($info->pay_status != 0)) { goto GhrNh; } goto k9aQS; Lhuty: $input->SetOut_trade_no($data["\157\x75\164\137\x74\x72\x61\144\x65\x5f\156\x6f"]); goto kvIft; GTVW1: $rs["\x63\157\x64\145"] = 1; goto qkhYc; DFeWD: $res = $this->weixinapp($unifiedorder); goto F3VGf; vsM_d: $payment = new ResOrderPayment(); goto iO6le; hvHNs: if (!($unifiedorder["\162\145\164\165\162\x6e\x5f\x63\x6f\144\145"] == "\106\101\111\x4c")) { goto u6LXL; } goto jG1Oq; fsRoV: $rs["\x63\x6f\x64\145"] = 1; goto SMrv3; L2TML: return $rs; goto NEykg; XNFSA: $input->SetBody($info->pay_body); goto cLMlm; iO6le: $info = $payment->where("\157\165\164\137\x74\x72\141\x64\145\137\156\157", $data["\x6f\165\164\137\x74\x72\x61\144\145\x5f\156\x6f"])->find(); goto fRWrZ; qkhYc: $rs["\155\x73\x67"] = "\350\256\xa2\345\x8d\x95\344\270\x8d\xe5\xad\x98\xe5\234\xa8"; goto hjWAa; ULkNM: $rs["\x6d\x73\x67"] = "\xe8\xae\xa2\345\215\225\344\xb8\xbb\351\242\230\xe5\267\xb2\xe6\224\xb9\xe5\217\230"; goto RJy4W; kvIft: $input->SetTrade_type("\112\x53\x41\120\111"); goto hebEU; Ys2wu: $input = new \WxPayUnifiedOrder(); goto XNFSA; F3VGf: $rs["\x69\156\x66\x6f"] = $res; goto L2TML; k9aQS: $rs["\x63\x6f\144\145"] = 1; goto ULkNM; fRWrZ: if (!empty($info)) { goto U9Mcu; } goto GTVW1; SMrv3: $rs["\x6d\163\147"] = $unifiedorder["\145\x72\x72\137\x63\x6f\144\145\137\x64\x65\x73"]; goto Ppmfd; Osq8M: $GLOBALS["\155\143\x68\x5f\151\x64"] = $data["\x6d\x63\150\137\151\144"]; goto Ys2wu; XegIU: if (!($unifiedorder["\x72\x65\x73\x75\154\x74\137\143\157\144\x65"] == "\x46\101\111\114")) { goto ckqRa; } goto fsRoV; Ppmfd: return $rs; goto o9NGw; hjWAa: return $rs; goto NORzI; NORzI: U9Mcu: goto YyFVT; RJy4W: return $rs; goto zhCly; vTyxv: $input->SetTotal_fee($info->pay_money * 100); goto Lhuty; sv04b: $rs = array("\x63\x6f\x64\145" => 0, "\151\x6e\x66\157" => array()); goto vsM_d; RRFQK: return $rs; goto EOwcM; LWJuU: $rs["\x6d\163\147"] = $unifiedorder["\x72\x65\164\165\x72\x6e\x5f\x6d\163\x67"]; goto RRFQK; Gme3B: $input->SetDetail($info->pay_detail); goto vTyxv; NEykg: } private function weixinapp($unifiedorder) { goto UvP2I; GHB1t: $input->SetTimeStamp('' . time() . ''); goto deEwR; GVWjX: $param = json_decode($param, true); goto qhBbI; xu_kK: $param = $con->where("\x6b\145\x79", "\x57\130\x50\x41\131")->where("\155\143\150\137\151\x64", $GLOBALS["\x6d\x63\150\137\151\x64"])->where("\x69\163\137\165\163\145", 1)->value("\x76\x61\x6c\165\x65"); goto GVWjX; mZxep: return $input; goto cmD9x; JLm4S: $input->SetSignType("\x4d\x44\65"); goto yFg6Q; deEwR: $input->SetNonceStr($this->createNoncestr()); goto tMtyB; qhBbI: $input = new \WxPayJsApiPay(); goto wvXI5; UvP2I: $con = new Config(); goto xu_kK; yFg6Q: $input->SetSign(); goto mZxep; tMtyB: $input->SetPackage("\x70\x72\145\160\x61\171\137\x69\144\75" . $unifiedorder["\160\x72\145\x70\141\x79\137\x69\144"]); goto JLm4S; wvXI5: $input->SetAppid($param["\x41\x50\120\137\x49\104"]); goto GHB1t; cmD9x: } private function createNoncestr($length = 32) { goto VaMCa; VaMCa: $chars = "\x61\142\143\x64\x65\x66\x67\x68\151\152\x6b\154\155\156\x6f\x70\161\x72\163\x74\x75\166\x77\170\171\172\x30\61\62\63\64\x35\x36\x37\70\x39"; goto AsTLp; mFx_j: CXv04: goto gjhsu; moqrS: return $str; goto XtrBg; gjhsu: $i++; goto bOg0P; d2a6e: if (!($i < $length)) { goto NLdq6; } goto OCiV4; ZlaB8: Bekhh: goto d2a6e; OCiV4: $str .= substr($chars, mt_rand(0, strlen($chars) - 1), 1); goto mFx_j; bOg0P: goto Bekhh; goto Xszd4; oiyTg: $i = 0; goto ZlaB8; Xszd4: NLdq6: goto moqrS; AsTLp: $str = ''; goto oiyTg; XtrBg: } public function payCallback($out_trade_no, $pay_type) { goto YhKhF; uck18: return "\163\165\x63\x63\x65\x73\163"; goto yG0pX; v2UhT: Db::startTrans(); goto eQeag; YhKhF: $data = array("\x6f\162\144\x65\162\x5f\163\x74\141\164\165\x73" => 2, "\x70\141\171\x5f\163\x74\x61\x74\165\163" => 2, "\160\x61\x79\x5f\x74\171\160\x65" => $pay_type, "\160\141\x79\x5f\164\151\x6d\x65" => time()); goto v2UhT; eQeag: try { goto N6rHi; qg8Zv: $order->allowField(true)->save($data, ["\x6f\165\164\137\x74\x72\x61\x64\x65\x5f\156\x6f" => $out_trade_no]); goto yrsI4; yrsI4: $payment = new ResOrderPayment(); goto Kv17k; HDMsW: Db::commit(); goto Ks_zi; Kv17k: $payment->allowField(true)->save($data, ["\x6f\165\164\x5f\164\x72\141\144\145\137\x6e\157" => $out_trade_no]); goto HDMsW; N6rHi: $order = new ResOrder(); goto qg8Zv; Ks_zi: } catch (\Exception $e) { Db::rollback(); return null; } goto uck18; yG0pX: } }
