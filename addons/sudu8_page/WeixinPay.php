<?php
 class WeixinPay { protected $appid; protected $mch_id; protected $key; protected $openid; protected $out_trade_no; protected $body; protected $total_fee; protected $identity; protected $sub_mchid; protected $attach; function __construct($appid, $openid, $mch_id, $key, $out_trade_no, $body, $total_fee, $identity, $sub_mchid, $attach = '') { goto VQLYK; vhZ5s: $this->body = $body; goto ai_wG; WDPlC: $this->sub_mchid = $sub_mchid; goto zlEjz; XRkgs: $this->openid = $openid; goto ggI67; XfaNR: $this->out_trade_no = $out_trade_no; goto vhZ5s; ai_wG: $this->total_fee = $total_fee; goto tdrbg; tKqBb: $this->key = $key; goto XfaNR; tdrbg: $this->identity = $identity; goto WDPlC; VQLYK: $this->appid = $appid; goto XRkgs; zlEjz: $this->attach = $attach; goto hkiGL; ggI67: $this->mch_id = $mch_id; goto tKqBb; hkiGL: } public function pay() { $return = $this->weixinapp(); return $return; } private function unifiedorder() { goto rYJ1d; U3grM: $parameters["\163\165\x62\x5f\155\143\150\x5f\x69\144"] = $this->mch_id; goto GrLW7; CazMr: $xmlData = $this->arrayToXml($parameters); goto OzoBb; VQKR9: $parameters["\163\x75\142\137\141\160\x70\151\x64"] = $this->appid; goto U3grM; u6EbL: if (!$this->attach) { goto eIBkA; } goto ae1it; ePnoQ: w9zNP: goto Zrqqt; ae1it: $parameters["\x61\164\164\x61\x63\x68"] = $this->attach; goto u5ib7; RQLpw: $parameters = array("\141\x70\160\151\x64" => $this->appid, "\x62\x6f\144\x79" => $this->body, "\x6d\x63\150\137\x69\x64" => $this->mch_id, "\x6e\x6f\x6e\x63\145\137\x73\x74\162" => $this->createNoncestr(), "\156\x6f\x74\151\x66\x79\x5f\x75\162\154" => $this->getNotifyUrl("\57\141\x64\144\157\x6e\163\x2f\x73\x75\x64\165\x38\x5f\160\x61\147\x65\x2f\160\x61\x79\x2e\x70\150\x70"), "\x6f\165\x74\137\x74\x72\141\144\145\x5f\x6e\x6f" => $this->out_trade_no, "\164\x6f\164\141\x6c\137\146\145\145" => $this->total_fee, "\x74\x72\141\x64\x65\x5f\x74\x79\x70\145" => "\x4a\123\101\120\x49"); goto CfA52; CfA52: if (!($this->identity == 1)) { goto w9zNP; } goto nZjcU; u5ib7: eIBkA: goto GAmKc; CcGVV: return $return; goto Qcnmn; GAmKc: $parameters["\x73\x69\147\x6e"] = $this->getSign($parameters); goto CazMr; OzoBb: $return = $this->xmlToArray($this->postXmlCurl($xmlData, $url, 60)); goto CcGVV; GrLW7: $parameters["\x73\165\x62\137\157\x70\145\156\x69\x64"] = $this->openid; goto nQ7IU; rYJ1d: $url = "\x68\x74\164\160\163\72\57\x2f\141\160\151\x2e\155\x63\150\56\167\x65\151\x78\151\x6e\x2e\x71\x71\x2e\x63\x6f\x6d\x2f\160\x61\171\57\x75\x6e\x69\146\151\x65\144\x6f\x72\144\x65\162"; goto RQLpw; nQ7IU: P2K4u: goto u6EbL; Zrqqt: if (!($this->identity == 2)) { goto P2K4u; } goto VQKR9; nZjcU: $parameters["\157\160\x65\x6e\151\x64"] = $this->openid; goto ePnoQ; Qcnmn: } protected function getNotifyUrl($url) { goto DZwzu; Q41Jf: return $current_url; goto ERYCa; AP4U7: TD_23: goto k4tTn; ppUTI: $current_url = "\150\164\x74\x70\163\72\x2f\x2f"; goto AP4U7; k4tTn: $current_url .= $_SERVER["\110\x54\124\x50\137\x48\117\123\124"] . strstr($_SERVER["\122\105\121\125\105\123\124\x5f\x55\x52\111"], "\x2f\141\x70\160\57\x69\156\x64\145\x78", true) . $url; goto Q41Jf; tkg_Z: if (!(isset($_SERVER["\110\x54\124\120\123"]) && $_SERVER["\110\x54\124\120\123"] == "\x6f\x6e")) { goto TD_23; } goto ppUTI; DZwzu: $current_url = "\x68\x74\x74\160\72\x2f\x2f"; goto tkg_Z; ERYCa: } private static function postXmlCurl($xml, $url, $second = 30) { goto XO3JQ; wijwZ: $data = curl_exec($ch); goto xg5Q0; nNDjK: curl_close($ch); goto AzwUh; qgbd_: curl_close($ch); goto UNZsV; olVPo: curl_setopt($ch, CURLOPT_URL, $url); goto atjXY; U1RS9: curl_setopt($ch, CURLOPT_HEADER, FALSE); goto pE9cZ; AzwUh: return $data; goto Glztz; L3_wt: goto ihXJI; goto HP2CZ; cU30p: curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE); goto U1RS9; CM4fu: curl_setopt($ch, CURLOPT_POSTFIELDS, $xml); goto ye9Mr; Senl9: curl_setopt($ch, CURLOPT_TIMEOUT, $second); goto olVPo; UNZsV: throw new WxPayException("\143\x75\162\x6c\xe5\207\xba\xe9\224\231\357\274\214\xe9\x94\x99\xe8\257\xaf\xe7\240\x81\72{$error}"); goto L3_wt; pE9cZ: curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE); goto i9LMP; fQDFT: curl_setopt($ch, CURLOPT_TIMEOUT, 40); goto eueIr; xg5Q0: if ($data) { goto O0NUB; } goto Bvctk; HP2CZ: O0NUB: goto nNDjK; XO3JQ: $ch = curl_init(); goto Senl9; ye9Mr: curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 20); goto fQDFT; atjXY: curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE); goto cU30p; eueIr: set_time_limit(0); goto wijwZ; Bvctk: $error = curl_errno($ch); goto qgbd_; i9LMP: curl_setopt($ch, CURLOPT_POST, TRUE); goto CM4fu; Glztz: ihXJI: goto mTNEZ; mTNEZ: } protected function arrayToXml($arr) { goto k1nwo; k1nwo: $xml = "\x3c\x72\157\157\x74\76"; goto Nu_mB; Nu_mB: foreach ($arr as $key => $val) { goto K81MJ; KhXAs: OK9Ue: goto gSqCc; C7nD1: $xml .= "\x3c" . $key . "\76" . $val . "\x3c\x2f" . $key . "\x3e"; goto u6DXd; K81MJ: if (is_array($val)) { goto OK9Ue; } goto C7nD1; iVMpB: UnHNH: goto F6Q6C; Hjatm: Q2HeD: goto iVMpB; u6DXd: goto Q2HeD; goto KhXAs; gSqCc: $xml .= "\74" . $key . "\76" . arrayToXml($val) . "\74\57" . $key . "\x3e"; goto Hjatm; F6Q6C: } goto MEC20; MEC20: rLGXL: goto QGLd7; gNocI: return $xml; goto nwFen; QGLd7: $xml .= "\74\x2f\162\x6f\157\x74\76"; goto gNocI; nwFen: } protected function xmlToArray($xml) { goto rDN5P; ec1mn: $xmlstring = simplexml_load_string($xml, "\123\x69\155\160\154\145\x58\115\114\x45\x6c\145\155\145\x6e\x74", LIBXML_NOCDATA); goto OTuBp; IzymQ: return $val; goto Lx0_l; OTuBp: $val = json_decode(json_encode($xmlstring), true); goto IzymQ; rDN5P: libxml_disable_entity_loader(true); goto ec1mn; Lx0_l: } private function weixinapp() { goto VX8CU; LuDBO: CwnsP: goto Jx_5M; GRWoP: $parameters["\160\x61\171\x53\151\147\156"] = $this->getSign($parameters); goto Ob7bm; EC3Sk: goto CwnsP; goto sRvJC; ziync: if ($unifiedorder["\x72\x65\164\x75\162\x6e\137\143\157\144\145"] == "\106\101\111\x4c") { goto m9Qm3; } goto E0uZF; Mw3s7: $parameters["\x65\x72\x72\163"] = 1; goto YFNSc; YFNSc: $parameters["\x72\x65\164\165\162\156\137\155\163\x67"] = $unifiedorder["\x72\x65\164\x75\162\156\137\155\x73\x67"]; goto LuDBO; VX8CU: $unifiedorder = $this->unifiedorder(); goto ziync; E0uZF: $parameters = array("\141\160\x70\111\x64" => $this->appid, "\x74\x69\155\145\123\164\141\155\x70" => '' . time() . '', "\x6e\x6f\156\143\145\123\164\162" => $this->createNoncestr(), "\160\x61\x63\153\141\x67\x65" => "\160\x72\145\x70\141\x79\x5f\x69\x64\x3d" . $unifiedorder["\x70\162\x65\160\x61\171\137\x69\x64"], "\163\151\147\156\x54\171\160\x65" => "\x4d\x44\x35"); goto GRWoP; sRvJC: m9Qm3: goto Nazrd; Ob7bm: $parameters["\x72\x65\164\x75\x72\156\x5f\x6d\x73\147"] = $unifiedorder["\162\145\x74\x75\x72\x6e\x5f\155\x73\x67"]; goto L78zL; Jx_5M: return $parameters; goto hsAVs; Nazrd: $parameters = array(); goto Mw3s7; L78zL: $parameters["\x65\x72\162\x73"] = 0; goto EC3Sk; hsAVs: } protected function createNoncestr($length = 32) { goto MPRP7; wRxvI: $i++; goto gX3wY; pUT02: $str = ''; goto RZamx; gX3wY: goto OhW_k; goto y5Bxs; VyAIV: return $str; goto DlQGu; VlCGI: OhW_k: goto eWkYX; eWkYX: if (!($i < $length)) { goto tDfFf; } goto K4ScA; K4ScA: $str .= substr($chars, mt_rand(0, strlen($chars) - 1), 1); goto iT_0V; MPRP7: $chars = "\141\x62\143\144\145\x66\x67\150\151\152\x6b\154\x6d\x6e\x6f\x70\161\162\163\164\165\166\x77\x78\171\x7a\60\x31\x32\63\64\x35\x36\67\70\71"; goto pUT02; iT_0V: oaurL: goto wRxvI; y5Bxs: tDfFf: goto VyAIV; RZamx: $i = 0; goto VlCGI; DlQGu: } protected function getSign($Obj) { goto XXDDV; Nnbo1: Txbsk: goto TrCtr; TrCtr: ksort($Parameters); goto MNQ88; XXDDV: foreach ($Obj as $k => $v) { $Parameters[$k] = $v; piNgX: } goto Nnbo1; kcF63: $String = $String . "\46\x6b\x65\x79\x3d" . $this->key; goto aXDBW; FMfDX: $result_ = strtoupper($String); goto t34JN; t34JN: return $result_; goto i74Z6; MNQ88: $String = $this->formatBizQueryParaMap($Parameters, false); goto kcF63; aXDBW: $String = md5($String); goto FMfDX; i74Z6: } protected function formatBizQueryParaMap($paraMap, $urlencode) { goto f3YKt; LXzBi: ksort($paraMap); goto vu3Sh; rnRD6: $reqPar; goto HVFZ1; f3YKt: $buff = ''; goto LXzBi; vu3Sh: foreach ($paraMap as $k => $v) { goto a2fVo; cL7im: mQVhu: goto CKXZH; q3zPE: F6eQh: goto Eynr8; Eynr8: $buff .= $k . "\75" . $v . "\46"; goto cL7im; maWuD: $v = urlencode($v); goto q3zPE; a2fVo: if (!$urlencode) { goto F6eQh; } goto maWuD; CKXZH: } goto vml5P; zYWFX: $reqPar = substr($buff, 0, strlen($buff) - 1); goto Q3245; HVFZ1: if (!(strlen($buff) > 0)) { goto zU6OW; } goto zYWFX; Q3245: zU6OW: goto U00rS; U00rS: return $reqPar; goto Mgewp; vml5P: QUVlG: goto rnRD6; Mgewp: } }