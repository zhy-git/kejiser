{template 'common/header'}

<ul class="nav nav-tabs">

    {if $id}
    <li {if $op == 'display'}class="active"{/if}><a href="{php echo $this->createWebUrl('duoproducts', array('op' => 'display',  'id' => $id ))}">基本信息</a></li>
    {else}
    <li {if $op == 'display'}class="active"{/if}><a href="{php echo $this->createWebUrl('duoproducts', array('op' => 'display'))}">基本信息</a></li>
    {/if}

    {if $id}
    <li {if $op == 'types'}class="active"{/if}><a href="{php echo $this->createWebUrl('duoproducts', array('op' => 'types', 'id' => $id ))}">规格/库存</a></li>
    {/if}

</ul>


{if $op == 'display'}
<form class="form-horizontal" action="" method="post">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">产品管理</h3>
        </div>
        <div class="panel-body">
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">序号</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="num" id="num" value="{$products['num']}" style="width: 100px" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">序号越大越靠前</div>
            </div>

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">所属栏目</label>
                <div class="form-controls col-sm-5">
                    <select name="cid" class="form-control">
                        {loop $listAll $cateP}
                        <option value="{$cateP['id']}" {if $cateP['id']==$products['cid']}selected{/if}>{if $cateP['cid'] == 0}{/if}{$cateP['name']}</option>
                        {loop $cateP['data'] $cate}
                        <option value="{$cate['id']}" {if $cate['id']==$products['cid']}selected{/if}>{if $cate['cid'] !== 0}&nbsp;&nbsp;|----{/if}{$cate['name']}</option>
                        {/loop}
                        {/loop}
                    </select>
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">选择所属栏目，不选为顶级</div>
            </div>

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">推荐到横排</label>
                <div class="form-controls col-sm-5">
                    <label style="margin-right: 20px">
                        <input type="radio" name="type_x" value="0" {if $products['type_x'] == '0'} checked{/if} />
                        不推荐
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="type_x" value="1" {if $products['type_x'] == '1'} checked{/if} />
                        推荐
                    </label>
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">推荐后会在首页横排区块显示</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">推荐到竖排</label>
                <div class="form-controls col-sm-5">
                    <label style="margin-right: 20px">
                        <input type="radio" name="type_y" value="0" {if $products['type_y'] == '0'} checked{/if} />
                        不推荐
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="type_y" value="1" {if $products['type_y'] == '1'} checked{/if} />
                        推荐
                    </label>
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">推荐后会在首页竖排区块显示</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">推荐到首页栏目</label>
                <div class="form-controls col-sm-5">
                    <label style="margin-right: 20px">
                        <input type="radio" name="type_i" value="0" {if $products['type_i'] == '0'} checked{/if} />
                        不推荐
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="type_i" value="1" {if $products['type_i'] == '1'} checked{/if} />
                        推荐
                    </label>
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">推荐后会在首页该栏目块显示</div>
            </div>
            

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">标题</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="title" id="title" value="{$products['title']}" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">请填写标题</div>
            </div>


            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">抵用积分</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="score" id="score" value="{$products['score']}" style="width: 100px" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">设置最高抵用积分</div>
            </div>

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">多少钱起</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="priceq" id="priceq" value="{$products['price']}" style="width: 100px" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
            </div>

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">市场价</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="market_price" id="market_price" value="{$products['market_price']}" style="width: 100px" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
            </div>


            <div class="form-group">

                <label for="" class="control-label col-sm-2" style="margin-right:45px">缩略图</label>

                <div class="form-controls col-sm-5">

                    {php echo tpl_form_field_image('thumb', $products['thumb'])}

                </div>

                <div class="col-sm-1"></div>

                <div class="form-controls col-sm-3 help-block">最宽750px，高度随意</div>

            </div>

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">简介</label>
                <div class="form-controls col-sm-5">
                    <textarea class="form-control" rows="3" name="descs" placeholder="">{$products['desc']}</textarea>
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">请输入简介</div>
            </div>

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">组图</label>
                <div class="form-controls col-sm-5">
                    {php echo tpl_form_field_multi_image('imgtext',$products['imgtext']);}
                </div>
            </div>

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">标签</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="explains" id="explains" value="{$products['labels']}" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">多个标签请用英文","隔开</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">产品详情</label>
                <div class="form-controls col-sm-8">
                    {php echo tpl_ueditor('product_txt', $products['product_txt']);}
                    <div class="help-block">请输入详细介绍</div>
                </div>
            </div>

            <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">每日他人点击分享获取积分设置</h3>
        </div>
        <div class="panel-body">
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">是否启用规则</label>
                <div class="form-controls col-sm-5">
                    <label style="margin-right: 20px">
                        <input type="radio" name="get_share_gz" value="1" {if $products['get_share_gz'] == '1'} checked{/if} />
                        开启
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="get_share_gz" value="2" {if $products['get_share_gz'] == '2'} checked{/if} />
                        关闭
                    </label>
                </div>
                <div class="col-sm-1"></div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">获取积分</label>
                <div class="form-controls col-sm-2">
                    <div class="input-group">
                      <input type="text" class="form-control" name="get_share_score" value="{$products['get_share_score']}">
                      <span class="input-group-addon">积分/次</span>
                    </div>
                </div>
                <div class="col-sm-4"></div>
                <div class="form-controls col-sm-3 help-block">他人点击分享一次获得的积分</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">获取积分限制</label>
                <div class="form-controls col-sm-2">
                    <div class="input-group">
                      <input type="text" class="form-control" name="get_share_num" value="{$products['get_share_num']}">
                      <span class="input-group-addon">次/每天</span>
                    </div>
                </div>
                <div class="col-sm-4"></div>
                <div class="form-controls col-sm-3 help-block">他人每日点击分享获取积分次数限制</div>
            </div>
        </div>
    </div>
    
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <input name="token" type="hidden" value="{$_W['token']}" />
            <input type="submit" class="btn btn-primary col-lg-3" name="submit" value="保存商品基础信息" />
            <span style="margin-left:20px;color: #f00;line-height: 34px;">下一步需要设置规格、库存信息</span>
        </div>
    </div>
</form>
{/if}


{if $op == 'types'}
<style type="text/css">
    .ggz{
        border-left: 1px solid #dedede;
        border-top: 1px solid #dedede;
        border-bottom: 1px solid #dedede;
        text-align: center !important;
        height: 34px;
        line-height: 34px;
        padding-top: 0 !important;
        background-color: #eeeeee;
        width: 60px;
    }
    .ggzbtn{
        border-right: 1px solid #dedede;
        border-top: 1px solid #dedede;
        border-bottom: 1px solid #dedede;
        text-align: center !important;
        height: 34px;
        line-height: 34px;
        padding-top: 0 !important;
        background-color: #eeeeee;
        position: absolute;
        width: 60px;
        cursor:pointer;
        right: 0;
        top: 0;
    }
    .dels{
        position: absolute;
        right: 10px;
        top: 7px;
        cursor:pointer;
    }

    .waic1{
        border:1px solid #dedede; margin-top:20px; padding:10px;
    }
    .waic2{
        background-color:#eeeeee;; line-height:30px; padding:0 10px; position:relative;
        height: 30px;
    }
    .waic3{
        position: relative; margin-top:10px;
    }
    .ggzbtn3{
        border-right: 1px solid #dedede;
        border-top: 1px solid #dedede;
        border-bottom: 1px solid #dedede;
        text-align: center !important;
        height: 34px;
        line-height: 34px;
        padding-top: 0 !important;
        background-color: #eeeeee;
        position: absolute;
        width: 60px;
        cursor:pointer;
        right:0px;
        top: 0;
    }
    .yandd{
        display: inline-block;
        border: 1px solid #dedede;
        padding: 3px 5px;
        margin-top: 10px;
        margin-right: 5px;
    }
    .ssnd{
        cursor: pointer;
        padding: 0 4px;
        color: #fff;
        background: #F03150;
        height: 14px;
        line-height: 12px;
        font-size: 12px;
        float: right;
        margin: 4px 0 0 4px;
    }
    .biaotou{
        text-align: center;
        padding: 8px 0;
        font-weight: bold;
    }
    .tds{
        text-align: center;
        padding: 8px 0;
    }
    .shukdd{
        width: 100px;
        padding: 4px 5px;
        border: 1px solid #dedede;
    }
    .sddds{
        position: relative;
    }
    .ggsx{
        border: 1px solid #dedede;
        width: 60px;
        text-align: center;
        padding: 2px;
        position: absolute;
        right: 5px;
        top: 6px;
        cursor:pointer;
    }
    .ggzbcaa{
        position: relative;
        height: 30px;
        margin-top: 10px;
    }
    .ggzbc{
        border: 1px solid #dedede;
        background-color: #eeeeee;
        width: 120px;
        padding: 5px;
        position: absolute;
        left: 50%;
        margin-left: -60px;
        text-align: center;
        cursor:pointer;
    }
    .sdhd{
        line-height: 35px;
    }
    .xuzndt{
        border: 1px solid #dedede;
        width: 40%;
        display: inline-block;
        text-align: center;
        padding: 3px 0px;
        cursor:pointer;
    }
    .xuzndd{
        width: 50px;
        max-height: 50px;
        margin-top: 5px;
        margin-left: 10%;
    }
    .xuzndd img{
        width: 100%;
        max-height: 50px;
    }

</style>
<form class="form-horizontal" action="" method="post" onsubmit="return check();">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">产品管理</h3>
        </div>
        <div class="panel-body">



            <!-- <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">产品库存</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="nokc" id="nokc" value="{$proarr['kc']}" style="width: 100px" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off" {if $products['types']==2}readonly{/if}>
                </div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">产品价格</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="noprice" id="noprice" value="{$proarr['price']}" style="width: 100px" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off" {if $products['types']==2}readonly{/if}>
                </div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">产品图片</label>
                <div class="form-controls col-sm-5">
                    <div class='xuzndt' style="width:50px; display: inline-block;" name='imgurl999' id="cpccz" onclick="showImageDialog(this)">选择</div>
                    <div class='xuzndt' style="width:50px; display: inline-block;" name='imgurl999' id="cpcss" onclick="delimage(this)">删除</div>
                    <input type="hidden" name="nothumb" id="imgyc999" value="{$proarr['thumb']}">
                    <div class='xuzndd' id='imgxs999'>
                        {if $proarr['thumb']}
                        <img src="{$proarr['thumb']}">
                        {/if}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">是否使用规格</label>
                <div class="form-controls col-sm-5">
                    <input type="hidden" id="ischeck" name="ischeck" value="{$products['types']}">
                    <input type="checkbox" onchange="setgg(this)" name="guig" id="guig" value="{$products['types']}" style="width: 15px; margin-top:0" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off" {if $products['types']==2}checked{/if}>
                </div>
            </div>
 -->

            <input type="hidden" id="ischeck" name="ischeck" value="2">
            <div id="jtgg" >
            <div class="class="form-group"">
            <label for="" class="control-label col-sm-2" style="margin-right:33px">规格组和规格值</label>
            <div class="form-controls col-sm-6" id="izggz">
            <label for="" class="control-label col-sm-2 ggz">规格组</label>
            <input type="text" id="ggzval" placeholder="如颜色、尺码、套餐"  style="width:298px" class="form-control ng-pristine ng-untouched ng-valid ng-empty">
            <label for="" class="control-label col-sm-2 ggzbtn" onclick="ggzset()">添加</label>
        </div>
        <div class="form-controls col-sm-6 sdhd" id="izggzw" {if $counttypes < 3}style="display:none;"{/if}>
        最多只可添加3个规格组
    </div>
    <div class="form-controls col-sm-6" id="izggzwval" style="margin-left:172px">



    </div>
    </div>
    </div>
    </div>
    </div>

    <div class="panel panel-default" id="ggzs" >
    <div class="panel-heading sddds">
        <h3 class="panel-title">商品列表<span style="color: #f00;padding-left: 20px">[请先添加规则值，再填写库存，价格等]</span></h3>
        <!-- <div class="ggsx" onclick="datasets()">
            刷新
        </div> -->
    </div>

    <div style="padding:10px">
        <table cellpadding="0" cellspacing="0" style="border:1px solid #dedede" border="1px" width="100%" id="tabb">

        </table>
        <!-- <div class="ggzbcaa">
            <div class="ggzbc" onclick="ggzbc()">规格值保存</div>
        </div> -->
    </div>
    </div>

    <!-- 规格组长度 -->
    <input type="hidden" id="typelen" name="typelen">
    <!-- 规格组 -->
    <input type="hidden" id="typesarr" name="typesarr">
    <!-- 所有字商品的数据 -->
    <input type="hidden" id="biaogedata" name="biaogedata">


    <div class="form-group">
        <div class="col-sm-12">
            <input name="token" type="hidden" value="{$_W['token']}" />
            <input type="submit" class="btn btn-primary col-lg-1" name="submit" value="保存" />
        </div>
    </div>

</form>

<script type="text/javascript">
    var datajson = [];
    datajson = $.parseJSON('{php echo json_encode($datajson);}');

    var datacounts = 0;
    var typessy = 2;

    {if $id}
    $(function(){
        if(JSON.stringify(datajson) != '[]' || datajson.length != 0){
            ggzhtml();
        }
        datasets();
    })
    {/if}

        //是否使用规格
        function setgg(me){
            var flag = $(me).is(":checked");
            if(flag){
                typessy = 1; //使用规格
                $("#nokc").val(0);
                $("#nokc").attr("readonly","true");
                $("#noprice").attr("readonly","true");
                $("#cpccz").removeAttr("onclick");
                $("#cpcss").removeAttr("onclick");


                $("#jtgg").show();
                $("#ggzs").show();
                $("#ischeck").val(2);
            }else{
                typessy=2;
                $("#nokc").val(0);
                $("#nokc").removeAttr("readonly");
                $("#noprice").val(0);
                $("#noprice").removeAttr("readonly");
                $("#cpccz").attr("onclick","showImageDialog(this)");
                $("#cpcss").attr("onclick","delimage(this)");


                $("#jtgg").hide();
                $("#ggzs").hide();
                $("#ischeck").val(1);
            }
        }

        var ggz = 0;  //控制显示可输入规格组input

        // 规格组数组
        {if $counttypes > 0}
        var ggzarr = [];

        {loop $typesarr $item}
        ggzarr.push("{$item}");
        {/loop}

            datacounts = 1;
            {else}
            var ggzarr = [];
            datacounts = 0;
            {/if}
                if(ggzarr[0] == ''){
                    ggzarr = [];
                }

                //规格组json
                {if $counttypes > 0}

                var ggzjson = {};
                {loop $typesjson $aa $res}
                var carr = [];
                {loop $res $rec}
                carr.push("{$rec}");
                {/loop}
                    ggzjson["{$aa}"] = carr;
                    {/loop}

                        {else}
                        var ggzjson = {};
                        {/if}


                            //增加规格组
                            function ggzset(){
                                datacounts = 0;
                                var ggzval = $("#ggzval").val();
                                if(ggzval){
                                    ggz++;
                                    if(ggz==3){
                                        $("#izggz").hide();
                                        $("#izggzw").show();

                                    }
                                    ggzarr.push(ggzval);  //追加规格数组

                                    ggzjson[ggzval] = [];

                                    $("#ggzval").val("");
                                    ggzhtml();
                                }else{
                                    alert("请先设置规格组名！")
                                }


                            }

                            // 增加规格组操作
                            function ggzhtml(){
                                var ggzhtml = "";
                                for(var i=0; i<ggzarr.length; i++){
                                    var jsonarr = "";
                                    var key = ggzarr[i];
                                    var arr = ggzjson[key];
                                    for(var j=0; j<arr.length; j++){
                                        jsonarr +=  "<div class='yandd'>"+
                                            "<span>"+arr[j]+"</span>"+
                                            "<span class='ssnd' onclick='delbq("+j+","+i+")'>x</span>"+
                                            "</div>";
                                    }

                                    ggzhtml += "<div class='waic1'>"+
                                        "<div class='waic2'>"+
                                        ggzarr[i]+
                                        "<div class='leix5 wi wi-delete dels' onclick='del("+i+")'>"+"</div>"+
                                        "</div>"+
                                        "<div class='waic4' id='ggzid"+i+"'>"+
                                        jsonarr+
                                        "</div>"+
                                        "<div class='waic3'>"+
                                        "<label for='' class='control-label col-sm-2 ggz'>规格值</label>"+
                                        "<input type='text' id='ggzval"+i+"' placeholder='如红色、白色'  style='width:276px' class='form-control ng-pristine ng-untouched ng-valid ng-empty'>"+
                                        "<label for='' class='control-label col-sm-2 ggzbtn3' onclick='ggzqd("+i+")'>确定</label>"+
                                        "</div>"+
                                        "</div>";
                                }
                                $("#izggzwval").html(ggzhtml);
                            }

                            // 删除规格组
                            function del(i){
                                datacounts = 0;
                                ggz--;
                                $("#izggz").show();
                                $("#izggzw").hide();

                                var keys = ggzarr[i];
                                delete ggzjson[keys];
                                ggzarr.splice(i,1);
                                ggzhtml();
                                datasets();
                            }

                            // 增加规格值
                            function ggzqd(val){
                                datacounts = 1;

                                var arr = [];

                                var keys = ggzarr[val];
                                var ggz = $("#ggzval"+val).val();
                                if(!ggz){
                                    alert("请输入对应的规格值");
                                }else{
                                    arr = ggzjson[keys];
                                    arr.push(ggz);
                                }
                                var strhtml = "";
                                for(var i=0; i<arr.length; i++){
                                    strhtml += "<div class='yandd'>"+
                                        "<span>"+arr[i]+"</span>"+
                                        "<span class='ssnd' onclick='delbq("+i+","+val+")'>x</span>"+
                                        "</div>";
                                }
                                $("#ggzid"+val).html(strhtml);
                                $("#ggzval"+val).val("");
                                ggzjson[keys] = arr;

                                //设置datajson的新添加的值

                                datasets();
                            }

                            // 删除标签功能
                            function delbq(i,val){
                                var keys = ggzarr[val];
                                var arr = ggzjson[keys];
                                arr.splice(i,1);

                                var strhtml = "";
                                for(var i=0; i<arr.length; i++){
                                    strhtml += "<div class='yandd'>"+
                                        "<span>"+arr[i]+"</span>"+
                                        "<span class='ssnd' onclick='delbq("+i+","+val+")'>x</span>"+
                                        "</div>";
                                }
                                $("#ggzid"+val).html(strhtml);
                                $("#ggzval"+val).val("");

                                ggzjson[keys] = arr;
                                datasets();
                            }

                            var jg = ["库存","价格","货号","规格图片"];
                            var allarrone = []; //构建多重json
                            var tablearr = [];  //构建表格头部
                            // 构建规格
                            function datasets(){

                                allarrone = []; //构建多重json
                                tablearr = [];  //构建表格头部
                                $("#tabb").html("");
                                //判断规格组的值有没有都设置
                                var flag = 1;
                                for(var i=0; i<ggzarr.length; i++){
                                    if(ggzjson[ggzarr[i]].length == 0){
                                        alert(ggzarr[i]+"规格组没有设置规格值！");
                                        flag = 0;
                                        break;
                                    }
                                }
                                if(flag == 0){
                                    return false;
                                }else{
                                    //构建多重json一条数据
                                    if(ggzarr.length == 1){
                                        var sz1 = ggzjson[ggzarr[0]];

                                        //构建表格
                                        tablearr.push(ggzarr[0]);
                                        tablearr = tablearr.concat(jg);
                                        var wzdata = [];
                                        
                                        console.log("貌似外层出差")
                                        console.log(sz1);


                                        for(var i=0; i<sz1.length; i++){
                                            var datakey = sz1[i];
                                            if(datacounts == 1){

                                                if(!datajson){
                                                    console.log(111)
                                                    var jsondata = {};
                                                    jsondata[ggzarr[0]] = sz1[i];
                                                    jsondata["库存"] = 0;
                                                    jsondata["价格"] = 0;
                                                    jsondata["货号"] = 0;
                                                    jsondata["规格图片"] = "";
                                                    allarrone.push(jsondata);

                                                }else{
                                                    console.log(222)
                                                    $.each(datajson,function (ks,vs) {
                                                        wzdata.push(ks);
                                                    });
                                                    if(wzdata.indexOf(datakey) == -1){
                                                        wzdata.push(datakey);
                                                        var jsondata = {};
                                                        jsondata[ggzarr[0]] = sz1[i];

                                                        jsondata["库存"] = 0;
                                                        jsondata["价格"] = 0;
                                                        jsondata["货号"] = 0;
                                                        jsondata["规格图片"] = "";
                                                        allarrone.push(jsondata);
                                                    }

                                                    $.each(datajson,function (kk,vv) {
                                                        wzdata.push(kk);
                                                        if(kk == datakey){
                                                            var aa = vv;
                                                            var newarr = aa.split(",");
                                                            var jsondata = {};
                                                            jsondata[ggzarr[0]] = sz1[i];

                                                            jsondata["库存"] = newarr[0];
                                                            jsondata["价格"] = newarr[1];
                                                            jsondata["货号"] = newarr[2];
                                                            jsondata["规格图片"] = newarr[3];
                                                            allarrone.push(jsondata);
                                                        }else{
                                                            if(wzdata.indexOf(datakey) == -1){
                                                                wzdata.push(datakey);
                                                                var jsondata = {};
                                                                jsondata[ggzarr[0]] = sz1[i];

                                                                jsondata["库存"] = 0;
                                                                jsondata["价格"] = 0;
                                                                jsondata["货号"] = 0;
                                                                jsondata["规格图片"] = "";
                                                                allarrone.push(jsondata);
                                                            }
                                                        }
                                                    });
                                                }
                                            }else{
                                                var jsondata = {};
                                                jsondata[ggzarr[0]] = sz1[i];
                                                jsondata["库存"] = 0;
                                                jsondata["价格"] = 0;
                                                jsondata["货号"] = 0;
                                                jsondata["规格图片"] = "";
                                                allarrone.push(jsondata);
                                            }

                                        }
                                    }
                                    //构建多重json二条数据
                                    if(ggzarr.length == 2){
                                        var sz1 = ggzjson[ggzarr[0]];
                                        var sz2 = ggzjson[ggzarr[1]];


                                        //构建表格
                                        tablearr.push(ggzarr[0]);
                                        tablearr.push(ggzarr[1]);
                                        tablearr = tablearr.concat(jg);

                                        var wzdata = [];

                                        for(var i=0; i<sz1.length; i++){
                                            for(var j=0; j<sz2.length; j++){

                                                var datakey = sz1[i]+sz2[j];
                                                if(datacounts == 1){
                                                    if(!datajson){
                                                        console.log(333)
                                                        var jsondata = {};
                                                        jsondata[ggzarr[0]] = sz1[i];
                                                        jsondata[ggzarr[1]] = sz2[j];
                                                        jsondata["库存"] = 0;
                                                        jsondata["价格"] = 0;
                                                        jsondata["货号"] = 0;
                                                        jsondata["规格图片"] = "";
                                                        allarrone.push(jsondata);
                                                    }else{
                                                        console.log(444)
                                                        console.log("是不是这边报错")
                                                        console.log(datajson)
                                                        $.each(datajson,function (ks,vs) {
                                                            wzdata.push(ks);
                                                        });

                                                        if(wzdata.indexOf(datakey) == -1){
                                                            wzdata.push(datakey);
                                                            var jsondata = {};
                                                            jsondata[ggzarr[0]] = sz1[i];
                                                            jsondata[ggzarr[1]] = sz2[j];

                                                            jsondata["库存"] = 0;
                                                            jsondata["价格"] = 0;
                                                            jsondata["货号"] = 0;
                                                            jsondata["规格图片"] = "";
                                                            allarrone.push(jsondata);
                                                        }

                                                        $.each(datajson,function (kk,vv) {
                                                            if(kk == datakey){
                                                                var aa = vv;
                                                                var newarr = aa.split(",");
                                                                var jsondata = {};
                                                                jsondata[ggzarr[0]] = sz1[i];
                                                                jsondata[ggzarr[1]] = sz2[j];

                                                                jsondata["库存"] = newarr[0];
                                                                jsondata["价格"] = newarr[1];
                                                                jsondata["货号"] = newarr[2];
                                                                jsondata["规格图片"] = newarr[3];
                                                                allarrone.push(jsondata);
                                                            }else{
                                                                if(wzdata.indexOf(datakey) == -1){
                                                                    wzdata.push(datakey);
                                                                    var jsondata = {};
                                                                    jsondata[ggzarr[0]] = sz1[i];
                                                                    jsondata[ggzarr[1]] = sz2[j];

                                                                    jsondata["库存"] = 0;
                                                                    jsondata["价格"] = 0;
                                                                    jsondata["货号"] = 0;
                                                                    jsondata["规格图片"] = "";
                                                                    allarrone.push(jsondata);
                                                                }
                                                            }
                                                        });
                                                    }

                                                }else{
                                                    var jsondata = {};
                                                    jsondata[ggzarr[0]] = sz1[i];
                                                    jsondata[ggzarr[1]] = sz2[j];
                                                    jsondata["库存"] = 0;
                                                    jsondata["价格"] = 0;
                                                    jsondata["货号"] = 0;
                                                    jsondata["规格图片"] = "";
                                                    allarrone.push(jsondata);
                                                }

                                            }
                                        }


                                    }
                                    //构建多重json三条数据
                                    if(ggzarr.length == 3){
                                        var sz1 = ggzjson[ggzarr[0]];
                                        var sz2 = ggzjson[ggzarr[1]];
                                        var sz3 = ggzjson[ggzarr[2]];

                                        //构建表格
                                        tablearr.push(ggzarr[0]);
                                        tablearr.push(ggzarr[1]);
                                        tablearr.push(ggzarr[2]);
                                        tablearr = tablearr.concat(jg);

                                        var wzdata = [];
                                        for(var i=0; i<sz1.length; i++){
                                            for(var j=0; j<sz2.length; j++){
                                                for(var z=0; z<sz3.length; z++){
                                                    var datakey = sz1[i]+sz2[j]+sz3[z];
                                                    if(datacounts == 1){
                                                        if(!datajson){
                                                            var jsondata = {};
                                                            jsondata[ggzarr[0]] = sz1[i];
                                                            jsondata[ggzarr[1]] = sz2[j];
                                                            jsondata[ggzarr[2]] = sz3[z];
                                                            jsondata["库存"] = 0;
                                                            jsondata["价格"] = 0;
                                                            jsondata["货号"] = 0;
                                                            jsondata["规格图片"] = "";
                                                            allarrone.push(jsondata);
                                                        }else{
                                                            $.each(datajson,function (ks,vs) {
                                                                wzdata.push(ks);
                                                            });
                                                            $.each(datajson,function (kk,vv) {
                                                                wzdata.push(kk);
                                                                if(kk == datakey){
                                                                    var aa = vv;
                                                                    var newarr = aa.split(",");
                                                                    var jsondata = {};
                                                                    jsondata[ggzarr[0]] = sz1[i];
                                                                    jsondata[ggzarr[1]] = sz2[j];
                                                                    jsondata[ggzarr[2]] = sz3[z];
                                                                    jsondata["库存"] = newarr[0];
                                                                    jsondata["价格"] = newarr[1];
                                                                    jsondata["货号"] = newarr[2];
                                                                    jsondata["规格图片"] = newarr[3];
                                                                    allarrone.push(jsondata);
                                                                }else{
                                                                    if(wzdata.indexOf(datakey) == -1){
                                                                        wzdata.push(datakey);
                                                                        var jsondata = {};
                                                                        jsondata[ggzarr[0]] = sz1[i];
                                                                        jsondata[ggzarr[1]] = sz2[j];
                                                                        jsondata[ggzarr[2]] = sz3[z];
                                                                        jsondata["库存"] = 0;
                                                                        jsondata["价格"] = 0;
                                                                        jsondata["货号"] = 0;
                                                                        jsondata["规格图片"] = "";
                                                                        allarrone.push(jsondata);
                                                                    }
                                                                }
                                                            });
                                                        }
                                                    }else{
                                                        var jsondata = {};
                                                        jsondata[ggzarr[0]] = sz1[i];
                                                        jsondata[ggzarr[1]] = sz2[j];
                                                        jsondata[ggzarr[2]] = sz3[z];
                                                        jsondata["库存"] = 0;
                                                        jsondata["价格"] = 0;
                                                        jsondata["货号"] = 0;
                                                        jsondata["规格图片"] = "";
                                                        allarrone.push(jsondata);
                                                    }

                                                }
                                            }
                                        }

                                    }
                                    // 构建表头
                                    var strtab = "<tr>";
                                    for(var k = 0; k<tablearr.length; k++){
                                        strtab += "<td class='biaotou'>"+tablearr[k]+"</td>";
                                    }
                                    strtab += "</tr>";
                                    $("#tabb").html(strtab);
                                    //构建表身
                                    var lensz = ggzarr.length;
                                    var tabdata = "";
                                    for(var d = 0; d<allarrone.length; d++){
                                        tabdata +=  "<tr>";
                                        for(var k = 0; k<tablearr.length; k++){
                                            if(k<lensz){
                                                tabdata += "<td class='tds '>"+allarrone[d][tablearr[k]]+"</td>";
                                            }else if(tablearr[k]=="规格图片"){
                                                var imgkk = "";
                                                if(allarrone[d][tablearr[k]]){
                                                    var imgkk = "<img src="+allarrone[d][tablearr[k]]+">";
                                                }else{
                                                    var imgkk = "";
                                                }
                                                tabdata +=  "<td class='tds' style='position: relative;'>"+
                                                    "<input type='hidden' id='imgurl"+d+"' name='valarr"+d+"' value="+allarrone[d][tablearr[k]]+">"+
                                                    "<div class='xuzndt' name='imgurl"+d+"' onclick='showImageDialog(this);'>选择</div>"+
                                                    "<div class='xuzndt' name='imgurl"+d+"' onclick='delimage(this)'>删除</div>"+
                                                    "<div class='xuzndd' id='imgxs"+d+"'>"+
                                                    imgkk+
                                                    "</div>"
                                                "</td>";
                                            }else{
                                                tabdata += "<td class='tds'><input type='text' class='shukdd' name='valarr"+d+"' value='"+allarrone[d][tablearr[k]]+"'></td>";
                                            }
                                        }
                                        tabdata +=  "</tr>";
                                    }
                                    $("#tabb").append(tabdata);

                                }

                            }

                            function ggzbc(){

                                for(var i=0; i<allarrone.length; i++){
                                    var kucun = $("input[name='valarr"+i+"']")[0].value;
                                    var money = $("input[name='valarr"+i+"']")[1].value;
                                    var huohao = $("input[name='valarr"+i+"']")[2].value;
                                    var imgs = $("input[name='valarr"+i+"']")[3].value;
                                    allarrone[i]['库存'] = kucun;
                                    allarrone[i]['价格'] = money;
                                    allarrone[i]['货号'] = huohao;
                                    allarrone[i]['规格图片'] = imgs;
                                }

                                var val = JSON.stringify(allarrone);

                                $("#biaogedata").val(val);
                                $("#typelen").val(ggzarr.length);
                                $("#typesarr").val(ggzarr.toString());

                                // alert("规格值设置成功！");

                            }

                            function showImageDialog(elm, opts, options) {

                                require(["util"], function(util){

                                    var btn = $(elm);
                                    var key = $(btn).attr("name");
                                    var dval = key.substr(6,key.length);
                                    var imgkey = "imgxs"+dval;

                                    var ipt = btn.parent().prev();
                                    var val = ipt.val();
                                    var img = ipt.parent().next().children();
                                    options = {'global':false,'class_extra':'','direct':true,'multiple':false,'fileSizeLimit':5120000};
                                    util.image(val, function(url){

                                        var urlnew = url.url;
                                        var strurl = "<img src='"+urlnew+"'>";
                                        $("#"+key).val(urlnew);
                                        $("#"+imgkey).html(strurl);
                                        if(typessy==2){
                                            $("#imgyc999").val(url.url);
                                        }

                                    }, options);
                                });
                            }
                            function delimage(me){
                                var key = $(me).attr("name");
                                var dval = key.substr(6,key.length);
                                var imgkey = "imgxs"+dval;
                                $("#"+key).val("");
                                $("#"+imgkey).html("");
                                if(typessy==2){
                                    $("#imgyc999").val("");
                                }
                            }


                            function check(){
                                //判断规格组的值有没有都设置
                                for(var i=0; i<ggzarr.length; i++){
                                    if(ggzjson[ggzarr[i]].length == 0){
                                        alert(ggzarr[i]+"规格组没有设置规格值！");
                                        return false;
                                    }
                                }
                                ggzbc();
                                if(confirm('你确定就这样保存本产品?')){
                                    return true;
                                }else{
                                    return false;
                                }
                            }
</script>

{/if}
{template 'common/footer'}