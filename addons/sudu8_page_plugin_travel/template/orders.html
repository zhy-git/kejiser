{template 'common/header'}
<style>
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button{
  -webkit-appearance: none !important;
  margin: 0;
}
.we7-table{font-size: 12px;}
.we7-table>tbody>tr>td:first-child, .wechat-communication>tbody>tr>td:first-child{padding-left:15px}
.we7-table>tbody>tr>td{border: 1px solid #eee;}
.we7-table>tbody>tr>td img, .wechat-communication>tbody>tr>td img {max-width: 50px;}
.dingdan{color: #bbb;padding-left: 20px}
.border-top td{border:none !important}
.loader1{
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    background: #000 50% 50%;
    opacity: .3;
}
.ssdd{
    width: 200px;
    border: 1px solid #dedede;
    padding: 20px 10px;
}
.zzcc{
    position: fixed;
    top: 0; 
    width: 100%;
    height: 100%;
    background-color: #000000;
    opacity: 0.4;
    z-index: 100000;
}
.bbdd{
    position: fixed;
    z-index: 100001;
    background-color: #ffffff;
    width: 400px;
    height: 220px;
    top: 50%;
    left: 50%;
    margin-top: -200px;
    margin-left: -110px;
    padding: 10px;
}
.ddhh{
    line-height: 30px;
    position: relative;
}
.ddxx{
    position: absolute;
    right: 0;
    top:0;
    cursor:pointer;
}
.xdsoft_datetimepicker{
  z-index: 100100!important;
}
.float-left{
  float: left;
}
.mr-20{
  margin-right: 20px;
  margin-bottom: 20px
}
</style>
<link rel="stylesheet" type="text/css" href="{$_W['siteroot']}web/resource/components/datetimepicker/jquery.datetimepicker.css"/ >
<script type="text/javascript" src="{$_W['siteroot']}web/resource/components/datetimepicker/jquery.datetimepicker.js"></script>
<script type="text/javascript">
  $(function(){
     $('#change_info_date').datetimepicker({
      lang:'ch',
      format:"Y-m-d H:i:s",
      allowBlank:true,
      validateOnBlur:false,
    });
  })

  //  $("#excel").click(function(){
  //   var user_info = $('#user_info').val();
  //   var href = window.location.href;

  //   if(href.indexOf("record") != -1){
  //     var excel_href = href.replace(/record/,"excel");
  //     window.location.href = excel_href;
  //   } else{
  //     window.location.href = href + "&opt=excel";
  //   }
  // })

  // $("#filter").click(function(){
  //   var user_info = $('#user_info').val();
  //   var url = window.location.href;
  //   if(url.indexOf("&opt") != -1){
  //     url = url.slice(0, url.indexOf("&opt"));
  //   }
    
  //   window.location.href = url + "&opt=record&datetimepicker=" + $('#datetimepicker').val() + '&end_datetimepicker=' + $('#end_datetimepicker').val() + "&select_state=" + $('#select_state').val() + "&datetimepicker2=" + $('#datetimepicker2').val() + '&end_datetimepicker2=' + $('#end_datetimepicker2').val() + "&select_info=" + $('#select_info').val() + "&user_info=" + user_info;
  // })


  function ycc(){
    $(".loader1").hide();
      $("#bbdd").hide();
      $("#qxdd").hide();
      $('#change_info').hide();
  }

  function tijiao(){
      var emp = $("#emp").val();
      var orderid = $("#orderid").val();
      var newurl = document.URL+"&op=queren&orderid="+orderid+"&emp="+emp;
      location.href = newurl;
  }

  function changedate(){
    var newdate = $("#change_info_date").val();
      if(!newdate){
          alert("必须选择日期！");
          return false;
      }
      var orderid = $("#oid").val();
      var newurl = document.URL+"&op=changedate&orderid="+orderid+"&newdate="+newdate;
      location.href = newurl;
  }
  function showchange_info(id){
    $("#oid").val(id);
    $(".loader1").show();
    $('#change_info').show();
  }
</script>
<div style="height:80px">

   <h3 style="float: left;margin-top: 0;">{if $op == 'yh'}{$userinfo['nickname']}{/if}产品核销</h3>

</div>



<div class="form-horizontal">

  <div style="margin-bottom: 15px; height: 50px;">

    <form class="form-horizontal" action=""  method="post">

       <label for="" class="control-label col-sm-2" style="margin-left:70px; margin-right:20px;">请输入订单号</label>

       <div class="form-controls col-sm-5">

           <input type="text" name="order_id" id="order_id" class="form-control ng-pristine ng-untouched ng-valid ng-empty" value="" onkeyup="this.value=this.value.match(/[0-9]+/g)"  placeholder="" autocomplete="off">

       </div>

       <div class="col-sm-1">

          <input type="button" onclick="search()" value="搜索" class="btn btn-default btn-sm" style="padding:7px 20px">

      </div>

  </form>

</div>



</div>

<div>

    <table class="table we7-table table-hover article-list vertical-middle">

        <tbody id="shujl">

        </tbody>

    </table>
    <style>
    .textbg{color:#fff;margin-right: 2px;background: #67C23A}
    </style>
    <table class="table table-responsive" style="table-layout: fixed;">

        <tbody><tr style="background:#f8f8f8">

            <td style="width:60px;border-left:1px solid #f2f2f2;">商品</td>

            <td style="width:150px;"></td>

            <td style="width:70px;text-align: right;;">单价/数量</td>

            <td style="width:150px;text-align: center;">优惠信息</td>

            <td style="width:90px;text-align: center;">姓名 - 联系方式</td>

            <td style="width:100px;text-align: center;">价格</td>

            <td style="width:100px;text-align: center;">核销时间</td>

            <td style="width:90px;text-align: center">状态</td>





            {loop $arr $item}

        </tr>

        <tr><td colspan="8" style="height:20px;padding:0;border-top:none;">&nbsp;</td></tr>

        <tr class="trorder">

            <td colspan="4">

                订单编号:  {$item['order_id']}                               </td>

                <td colspan="4" style="text-align:right;font-size:12px;" class="aops">
                <span style="float: right;">下单时间：{$item['creattime']} </span>
             </td>

         </tr>

         <tr class="trbody">

            <td style="overflow:hidden;"><img src="{$item['thumb']}" style="width:50px;height:50px;border:1px solid #ccc; padding:1px;" onerror=""></td>

            <td style="text-align: left;overflow:hidden;border-left:none;"> {$item['product']}</td>

            <td style="text-align:right;border-left:none;">

                {loop $item['order_duo'] $duo}

                {$duo[0]}<br> 

                {$duo[1]}  x  {$duo[4]} <br>

                {/loop}

            </td>



            <td style="text-align: left;font-size: 12px;">
              {if $item['discounts'] > 0}
              <span class="textbg" style="background: #6671e4">折</span>会员折扣：{$item['discounts']}折<br>
              {/if}
              {if $item['yhInfo_mj']['msg']}
              <span class="textbg" style="background: #F56C6C;">减</span>{$item['yhInfo_mj']['msg']} - ￥{$item['yhInfo_mj']['money']}<br>
              {/if}
              {if $item['yhInfo_yhq']['msg'] != "未使用优惠券"}
              <span class="textbg">券</span>{$item['yhInfo_yhq']['msg']} - ￥{$item['yhInfo_yhq']['money']}<br>
              {/if}
              {if $item['yhInfo_score']['money'] > 0}
              <span class="textbg" style="background: #00c4ff">分</span>{$item['yhInfo_score']['msg']} - ￥{$item['yhInfo_score']['money']}
              {/if}

           </td>


           <td rowspan="1" style="text-align:center;">



            <label class="label label-danger"></label>
            {if $item['pro_user_name'] != ""}
              {$item['pro_user_name']} - {$item['pro_user_tel']}
            {/if}
            <span style="margin-top:5px;display:block;"></span>



        </td>

        <td rowspan="1" style="text-align:center">

            ￥{$item['true_price']} 

            



        </td>

        <td rowspan="1" style="text-align:center">

           {if $item['flag']==1 || $item['flag']==2}

           {$item['custime']}

           {/if}

       </td>



       <td rowspan="1" class="ops" style="line-height:20px;text-align:center">



        {if $item['flag'] ==0}
        <span class="btn btn-default btn-sm">未支付</span>
        {/if}

        {if $item['flag'] ==1}

        <a class="btn btn-danger btn-sm" style="background-color:green; border:1px solid green;" onclick="xiaofei({$item['id']})">立即核销</a>
        <a class="btn btn-danger btn-sm" onclick="qx({$item['id']})" style="margin-top: 5px">取消订单</a>
        {/if}

        {if $item['flag'] ==2} <span class="btn btn-success btn-sm" style="background-color:green;">已完成</span>{/if}

        {if $item['flag'] ==3} 

        <a class="btn btn-danger btn-sm" onclick="queren({$item['id']})" style="background-color:green; border:1px solid green;">确认订单</a>
        <a class="btn btn-danger btn-sm" onclick="qx({$item['id']})" style="margin-top: 5px">取消订单</a>

        {/if}

        {if $item['flag'] ==-1} <span class="btn btn-warning btn-sm">已关闭</span>{/if}

        {if $item['flag'] ==-2} <span class="btn btn-warning btn-sm">订单无效</span>{/if}

		{if $item['flag'] == 4}
		<span class="btn btn-default btn-sm">待收货</span>
		{if $item['kuaidihao']}
			<br>{$item['kuaidi']}
			<br>{$item['kuaidihao']}
		{/if}
		{/if}
		{if $item['flag'] == 5}
		<span class="btn btn-warning btn-sm">已取消</span>{/if}
		{if $item['flag'] == 6}
	        <a class="btn btn-success btn-sm" onclick="qx({$item['id']})" style="margin-top: 5px">同意取消</a>
	        <a class="btn btn-danger btn-sm" onclick="qx1({$item['id']})" style="margin-top: 5px">拒绝取消</a>
		{/if}
		{if $item['flag'] ==8} <span class="btn btn-default btn-sm" style="margin-top: 5px">已退货</span> {/if}
		{if $item['flag'] ==9} <span class="btn btn-default btn-sm" style="margin-top: 5px">已拒绝退货</span> {/if}
    </td>
</tr>

{if $item['pro_user_txt']}
<tr style=";border-bottom:none;background:#f9f9f9;">

    <td colspan="8" style="text-align:right">
        备注：{$item['pro_user_txt']}
    </td>
</tr>
{/if}
{if $item['flag'] ==2 && $item['hxinfo2']}
  <tr>
      <td colspan="8" style="line-height:40px;padding:0;box-sizing: border-box;padding:0 10px;color:#5cb85c;">
      核销信息：{$item['hxinfo2']}
      </td>
  </tr>
{/if}

{if $item['beizhu_val']}
<tr style=";border-bottom:none;background:#f9f9f9;">

    <td colspan="8" style="text-align:right">
        
        自定义表单内容：

        {loop $item['beizhu_val'] $items}

                {if $item['type']== 3}

                {$items['name']}：

                        {loop $items['val'] $item2}

                            {$item2},

                        {/loop}

                {/if}
                {if $items['type']== 5}
                {$items['name']}：
                        {loop $items['z_val'] $item2}
                           <a href="{$item2}" target="_blank"><img src="{$item2}" alt="" style="width:60px"></a>
                        {/loop}
                {/if}
                {if $items['type']== 16}
                  表单说明：{$items['val']}
                  {/if}
                  {if $items['type']!= 5 && $items['type']!= 3 && $items['type']!= 16}
                    {$items['name']}：{$items['val']}
                {/if}

                <br/>

            {/loop}

    </td>

</tr>
{/if}
<!--自带表单-->
{if $item['pro_user_name'] != "" || $item['pro_user_tel'] != "" || $item['pro_user_add'] != "" || $item['appoint_date'] != 0}
<tr >
  <td colspan="8" style="line-height: 20px;text-align:right">
  {if $item['pro_user_name'] != ""}姓名：{$item['pro_user_name']}<br>{/if}
  {if $item['pro_user_tel'] != ""}电话：{$item['pro_user_tel']}<br>{/if}
  {if $item['pro_user_add'] != ""}地址：{$item['pro_user_add']}<br>{/if}
  {if $item['appoint_date'] != 0}预约时间：{$item['appoint_date']}<a  onclick="showchange_info({$item['id']})" style="color:#f00;cursor: pointer;"> [修改]</a><br>{/if}
    </td>
</tr>
{/if}
<!--自带表单-->

<!--修改记录-->
{if $item['modify_info']}
<tr>
  <td colspan="7" style="line-height: 20px;">
  {if $item['modify_info']['flag'] != 2}
  {$item['modify_info']['pro_name']}在<?php echo date("Y-m-d H:i:s", $item['modify_info']['creattime'])?>申请修改预约信息为：姓名：{$item['modify_info']['pro_name']}，电话：{$item['modify_info']['pro_tel']}，地址：{$item['modify_info']['pro_address']}，预约日期：<?php echo date("Y-m-d H:i:s", $item['modify_info']['appoint_date'])?>  
  {/if}

  {if $item['modify_info']['flag'] == 1}
  <a onclick="querenchange({$item['id']})" style="color:green"> [确认修改]</a> 
  <a onclick="nochange({$item['id']})" style="color:#f00"> [拒绝修改]</a> 
  {/if}
  
    {if $item['modify_info']['flag'] == 3}
  <a href="javascript:;" style="color:#f00"> [已拒绝修改]</a>
    {/if}

    {if $item['modify_info']['flag'] == 2}
  {$item['pro_user_name']}在<?php echo date("Y-m-d H:i:s", $item['modify_info']['creattime'])?>申请修改预约信息为：姓名：{$item['pro_user_name']}，电话：{$item['pro_user_tel']}，地址：{$item['pro_user_add']}，预约日期：{$item['appoint_date']} <a href="javascript:;" style="color:green"> [已修改]</a> <br>
  修改前信息为：姓名：{$item['modify_info']['pro_name']}，电话：{$item['modify_info']['pro_tel']}，地址：{$item['modify_info']['pro_address']}，预约日期：<?php echo date("Y-m-d H:i:s", $item['modify_info']['appoint_date'])?>  
  {/if}
    </td>
</tr>
{/if}
<!--修改记录-->
<!-- <tr><td colspan="8" style="height:20px;padding:0;border-top:none;">&nbsp;</td></tr> -->

{/loop}



</tbody></table>

<div id="fenye">

    {$pager}

</div>
</div>
    <div class="loader1" style="display: none;background: rgba(0,0,0,.7);"></div>
    <div class="bbdd" id="bbdd" style="display:none">
          <div class="ddhh">
              <span>请选择上门服务人员</span>
              <div class="ddxx" onclick="ycc()">[关闭]</div>
          </div>
          <div>
              <form class="form-horizontal" action="" method="post">
                  <input type="hidden" id="orderid" name="orderid">
                  <table class="table we7-table  vertical-middle" style="border:0">
                      <tr>
                          <td style="width:110px">选择员工：</td>
                          <td >
                              <select style="width:200px" id="emp" name="emp">
                                <option value="">不需要上门人员</option>
                                  {loop $emps $item}
                                  <option value="{$item['id']}">
                                    {$item['realname']}
                                  </option>
                                  {/loop}
                              </select>
                          </td>
                      </tr>
                      
                      <tr>
                          <td style="width:95px"></td>
                          <td >
                              <a onclick="tijiao()" class="btn btn-success btn-sm">提交</a>
                          </td>
                      </tr>
                  </table>
              </form>
          </div>
    </div>
    <div class="bbdd" id="change_info" style="display:none">
        <div class="ddhh">
            <span>修改预约时间</span>
            <div class="ddxx" onclick="ycc()">[关闭]</div>
        </div>
        <div>
            <form class="form-horizontal" action="" method="post">
                <input type="hidden" id="oid" name="oid">
                <table class="table we7-table  vertical-middle" style="border:0">
                    <tr>
                        <td style="width:110px">选择日期：</td>
                        <td >
                            <input type="text" name="change_info_date" style="display: inline-block;width: 200px" id="change_info_date" data-date-format="yyyy-mm-dd hh:ii" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                        </td>
                    </tr>
                    
                    <tr>
                        <td style="width:95px"></td>
                        <td >
                            <a onclick="changedate()" class="btn btn-success btn-sm">提交</a>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>

    <script type="text/javascript">

    function search(){

        var val = $("#order_id").val();

        if(!val){

            alert("定单号不能为空，请输入订单号！");

            return;

        }

        var url = GetQueryString("order_id");

        if(url=="null"){

            var newurl = document.URL+"&order_id="+val;

            location.href = newurl;

        }else{

            var newurl = document.URL.replace("&order_id="+url, "&order_id="+val);

            location.href = newurl;

        }

    }



    function GetQueryString(name){

       var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");

       var r = window.location.search.substr(1).match(reg);

       if(r!=null)return  unescape(r[2]); return "null";

   }



   function xiaofei(id){



    if(window.confirm('确定核销该订单？')){



        var newurl = document.URL+"&op=hx&order="+id;

        location.href = newurl;



    }



}



function queren(id){
    $("#orderid").val(id);
    $(".loader1").show();
    $("#bbdd").show();
}
function qx(id){
  if(window.confirm('确定允许客户取消该笔订单？退款将直接到账')){
      var newurl = document.URL+"&op=confirmqx&order="+id;
      location.href = newurl;
  }
}

function qx1(id){
  if(window.confirm('确定拒绝该客户的退款请求？')){
      var newurl = document.URL+"&op=refuseqx&order="+id;
      location.href = newurl;
  }
}

function querenchange(id){
  if(window.confirm('确认通过该用户的修改请求？')){
      var newurl = document.URL+"&op=acceptmodify&order="+id;
      location.href = newurl;
  }
}

function nochange(id){
  if(window.confirm('确认拒绝该用户的修改请求？')){
      var newurl = document.URL+"&op=refusemodify&order="+id;
      location.href = newurl;
  }
}
</script>
{template 'common/footer'}