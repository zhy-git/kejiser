{template 'common/header'}
<ul class="nav nav-tabs">
    <li {if $op=='display' }class="active" {/if}><a href="{php echo $this->createWebUrl('activity', array('op' => 'display'))}">活动列表</a></li>
    <li {if $op=='post' }class="active" {/if}><a href="{php echo $this->createWebUrl('activity', array('op' => 'post'))}">添加活动</a></li>
</ul>
{if $op == 'display'}
<style type="text/css">
	.padding{
		padding: 3px 0;
		box-sizing: border-box;
		vertical-align: middle;
	}
</style>
<div>
    <h3 style="float: left;margin-top: 0;">活动列表</h3>
</div>
<table class="table table-responsive we7-table table-hover vertical-middle" style="table-layout: fixed;" > 
	<!-- class="table we7-table table-hover article-list vertical-middle" -->
	<tbody>
        <tr>
        	<td style="width: 110px">活动信息</td>
        	<td style="width: 220px"></td>
        	<td style="width: 130px">状态</td>
        	<td style="width: 180px">数据</td>
        	<td>操作</td>
       	</tr>
       	{loop $activities $item}
       	<tr>
       		<td>
               	<img src="{media $item['thumb']}" width="60" height="60" alt="">
       		</td>
       		<td style="display: flex;flex-flow: column;">
       			<div class="padding"><text style='color: #aaa'>名称</text><br/></div>
       			<div>
       				<text>{$item['title']}</text><br/>
       			</div>
       			<div class="padding"><text style='color: #aaa'>时间</text><br/></div>
       			<div>
       				<text>开始：{php echo date('Y-m-d H:i:s',$item['begin'])}</text><br/>
       				<text>结束：{php echo date('Y-m-d H:i:s',$item['end'])}</text>
       			</div>
       		</td>
       		<td>
       			{if $item['status']=='1'}启动{else}不启动{/if} <br><br>
       			{if time() > $item['end']}<label class="label label-sm label-danger">已过期</label>
       			{elseif time() < $item['begin'] }<label class="label label-sm label-primary">未开始</label>
       			{else}<label class="label label-sm label-success">正在进行</label>
       			{/if}
       		</td>
       		<td >
       			<div class="padding">参与人数：<label class="label label-success label-sm">{$item['participate']}</label></div>
       			<div class="padding">获奖人数：<label class="label label-danger label-sm">{$item['win']}</label></div>
       			<div class="padding">浏 览 量：<label class="label label-primary label-sm">{$item['browse']}</label></div>
       			<div class="padding">分 享 量：<label class="label label-warning label-sm">{$item['share']}</label></div>
       		</td>
       		<td>
       			<div class="padding">管理</div>
       			<a class="btn btn-success btn-sm" href="{php echo $this->createWeburl('activity', array('id' => $item['id'], 'op' =>'editPrize'))}" >奖项设置</a>
                <a class="btn btn-primary btn-sm" href="{php echo $this->createWeburl('activity', array('id' => $item['id'], 'op' =>'record'))}" >抽奖记录</a>
                
       			<div class="padding">基础操作</div>
       			<a class="btn btn-success btn-sm" href="{php echo $this->createWeburl('activity', array('id' => $item['id'], 'op' =>'post'))}" >编辑</a>
                <a class="btn btn-danger btn-sm" onclick="return confirm('此操作不可恢复，确认吗？'); return false;" href="{php echo $this->createWeburl('activity', array('id' => $item['id'], 'op' => 'delete'))}">删除</a>
       		</td>
       	</tr>
        <tr>
           <td colspan="5">
                底部菜单添加活动链接：{$item['url']}
           </td> 
        </tr>
       	{/loop}
    </tbody>
</table>
{/if} 

{if $op == 'post'}
<form class="form-horizontal" action="" method="post">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">活动信息设置</h3>
        </div>
        <div class="panel-body">
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">活动名称</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="title" id="title" value="{$item['title']}" class="form-control ng-pristine ng-untouched ng-valid ng-empty" placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">请填写活动名称</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">活动开始时间</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="btime" value="{$item['begin']}" id="datetimepicker1" style="width: 200px" class="form-control ng-pristine ng-untouched ng-valid ng-empty" placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">请填写开始时间</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">活动结束时间</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="etime" value="{$item['end']}" id="datetimepicker2" style="width: 200px" class="form-control ng-pristine ng-untouched ng-valid ng-empty" placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">请填写结束时间</div>
            </div>
            <!-- <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">活动规则</label>
                <div class="form-controls col-sm-6" style="padding-right: 30px;">
                    <textarea class="form-control" rows="5" name="descp" placeholder="">{$item['descp']}</textarea>
                </div>
                <div class="help-block">请填写活动规则</div>
            </div> -->
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">活动规则</label>
                <div class="form-controls col-sm-7">
                    {php echo tpl_ueditor('descp', $item['descp']);}
                    <div class="help-block">请填写活动规则</div>
                </div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">活动缩略图</label>
                <div class="form-controls col-sm-5">
                    {php echo tpl_form_field_image('thumb', $item['thumb'])}
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">请选择活动缩略图</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">背景图片</label>
                <div class="form-controls col-sm-5">
                    {php echo tpl_form_field_image('bg', $item['bg'])}
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">请选择背景图片，不填系统默认</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">点击模式标题图</label>
                <div class="form-controls col-sm-5">
                    {php echo tpl_form_field_image('text_img1', $item['text_img1'])}
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">请选择文字标题图片，不填系统默认</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">摇一摇模式标题图</label>
                <div class="form-controls col-sm-5">
                    {php echo tpl_form_field_image('text_img2', $item['text_img2'])}
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">请选择文字标题图片，不填系统默认</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">小程序头部颜色</label>
                <div class="form-controls col-sm-2">
                    <div id="colorSelector1"><div style="width: 34px;height: 34px;background: {$item['nav_color']};float: left;border: 1px solid #ccc;border-right: 0;"></div></div>
                    <input type="text" id="nav_color" name="nav_color" value="{$item['nav_color']}" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off" style="width: 100px">
                </div>
                <div class="form-controls col-sm-3 help-block">顶部的背景颜色</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">活动状态</label>
                <div class="form-controls col-sm-5" style="padding-right: 30px;">
                    <label style="margin-right: 20px">
                        <input type="radio" name="status" value="1" {if $item['status']=='1' } checked{/if} /> 启用
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="status" value="0" {if $item['status']=='0' } checked{/if} /> 不启用
                    </label>
                </div>
                <div class="form-controls col-sm-4 help-block">启用后活动才会在规定时间内显示，默认开启</div>
            </div>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">活动基础设置</h3>
        </div>
        <div class="panel-body">
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">抽奖开始方式</label>
                <div class="form-controls col-sm-5" style="padding-right: 30px;">
                    <label style="margin-right: 20px">
                        <input type="radio" name="means" value="1" {if $item['base']['means']=='1' } checked{/if} /> 点击开始按钮
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="means" value="0" {if $item['base']['means']=='0' } checked{/if} /> 摇一摇
                    </label>
                </div>
                <div class="form-controls col-sm-4 help-block">默认点击开始按钮</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">每次抽奖消耗积分</label>
                <div class="form-controls col-sm-4">
                    <input type="text" name="jifen" value="{$item['base']['jifen']}" class="form-control ng-pristine ng-untouched ng-valid ng-empty" placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">不填默认为10</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">每人每天可参与次数</label>
                <div class="form-controls col-sm-4">
                    <input type="text" name="every_join" value="{$item['base']['every_join']}" class="form-control ng-pristine ng-untouched ng-valid ng-empty" placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">不填默认为3</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">每人是否只能中一次奖</label>
                <div class="form-controls col-sm-5" style="padding-right: 30px;">
                    <label style="margin-right: 20px">
                        <input type="radio" name="just_one" value="1" {if $item['base']['just_one']=='1' } checked{/if} /> 是
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="just_one" value="0" {if $item['base']['just_one']=='0' } checked{/if} /> 否
                    </label>
                </div>
                <div class="form-controls col-sm-4 help-block">是则中奖人不可能再中，默认否</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">参与人群</label>
                <div class="form-controls col-sm-5" style="padding-right: 30px;">
                    <label style="margin-right: 20px">
                        <input type="radio" name="users_type" value="1" {if $item['base']['users_type']=='1' } checked{/if} /> 会员
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="users_type" value="0" {if $item['base']['users_type']=='0' } checked{/if} /> 所有人
                    </label>
                </div>
                <div class="form-controls col-sm-4 help-block">默认所有人</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">个人信息填写时间</label>
                <div class="form-controls col-sm-5" style="padding-right: 30px;">
                    <label style="margin-right: 20px">
                        <input type="radio" name="fill_time" value="1" {if $item['base']['fill_time']=='1' } checked{/if} /> 中奖后
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="fill_time" value="0" {if $item['base']['fill_time']=='0' } checked{/if} /> 抽奖前
                    </label>
                </div>
                <div class="form-controls col-sm-4 help-block">默认抽奖前</div>
            </div>
            <!-- <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">分享类型</label>
                <div class="form-controls col-sm-5" style="padding-right: 30px;">
                    <label style="margin-right: 20px">
                        <input type="radio" name="share_type" value="1" {if $item['base']['share_type']=='1' } checked{/if} /> 分享即可
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="share_type" value="0" {if $item['base']['share_type']=='0' } checked{/if} /> 分享后链接被点进
                    </label>
                </div>
                <div class="form-controls col-sm-4 help-block">默认分享即可</div>
            </div> -->
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">单次好友点击增加次数</label>
                <div class="form-controls col-sm-4">
                    <input type="text" name="share_add" value="{$item['base']['share_add']}" class="form-control ng-pristine ng-untouched ng-valid ng-empty" placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">不填默认为1</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">每天好友点击次数上限</label>
                <div class="form-controls col-sm-4">
                    <input type="text" name="everyday_share" value="{$item['base']['everyday_share']}" class="form-control ng-pristine ng-untouched ng-valid ng-empty" placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">不填默认为1</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">总好友点击次数上限</label>
                <div class="form-controls col-sm-4">
                    <input type="text" name="total_share" value="{$item['base']['total_share']}" class="form-control ng-pristine ng-untouched ng-valid ng-empty" placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">不填默认为10</div>
            </div>
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-12">
            <input name="token" type="hidden" value="{$_W['token']}" />
            <input type="submit" onsubmit="checkAddnew()" class="btn btn-primary col-lg-1" name="addnew" value="提交" />
        </div>
    </div>
</form>
<link rel="stylesheet" type="text/css" href="/addons/sudu8_page/static/js/colorpicker.css">
<script src="/addons/sudu8_page/static/js/colorpicker.js"></script>
<link rel="stylesheet" type="text/css" href="/web/resource/components/datetimepicker/jquery.datetimepicker.css" />
<script type="text/javascript" src="/web/resource/components/datetimepicker/jquery.datetimepicker.js"></script>
<script type="text/javascript">
$(function() {
    $('#colorSelector1').ColorPicker({
        color: '#0000ff',
        onShow: function (colpkr) {
            $(colpkr).fadeIn(500);
            return false;
        },
        onHide: function (colpkr) {
            $(colpkr).fadeOut(500);
            return false;
        },
        onChange: function (hsb, hex, rgb) {
            $('#colorSelector1 div').css('backgroundColor', '#' + hex);
            $('#nav_color').val("#"+hex);
        }
    });

    $('#datetimepicker1').datetimepicker({
        lang: 'ch',
        format: "Y-m-d H:i:s",
        allowBlank: true,
        validateOnBlur: false,
    });
    $('#datetimepicker2').datetimepicker({
        lang: 'ch',
        format: "Y-m-d H:i:s",
        allowBlank: true,
        validateOnBlur: false,
    });

    
})

</script>
{/if} 

{if $op == 'editPrize'}
<style type="text/css">
.square {
    width: 150px;
    height: 150px;
    background: #ddd;
    border-radius: 10px;
    text-align: center;
}

.play{
	width: 150px;
    height: 150px;
    border-radius: 50%;
    text-align: center;
    background: #ddd;
}

.prize_img{
    margin: 0 auto;
    margin-top: 20px;
    text-align: center;
}

.prize_title{
    margin: 0 auto;
    margin-top: 5px;
    text-align: center;
}

.del{
	margin-left: -40px; 
}

</style>
<script type="text/javascript">

$(document).ready(function() {
    $('.square').each(function() {
        $(this).mouseover(function() {
            $(this).css("background", "#aaa");
        })
        $(this).mouseout(function() {
            $(this).css("background", "#ddd");
        })
        $(this).click(function(){
        	var num = $(this).data('num');
            $("#num").val(num);
        })
    })

    $("#choose").click(function(){
        $('#edit').removeClass('active');
        $('#choose').addClass('active');
        $('.choosing').each(function(){
            $(this).show();
        })
        $('.editing').hide();
    })

    $("#edit").click(function(){
        $('#choose').removeClass('active');
        $('#edit').addClass('active');
        $('.choosing').each(function(){
            $(this).hide();
        })
        $('.editing').show();

        $('input[name="title"]').val('');
        $('input[name="thumb"]').val('');
        $('select[name="types"]').val('');
        $('input[name="detail"]').val('');
        $('input[name="total"]').val('');
        $('input[name="chance"]').val('');
        $('input[name="thumb"]').parent().next().find("img").attr("src", "");
        $('#pid').val('');

        $('#not_yhq').show();
        $('#yhq').hide();
    })

    $("select[name='types']").change(function(){
        if($(this).val() == '4'){
            $('#not_yhq').hide();
            $('#yhq').show();
        }else{
            $('#not_yhq').show();
            $('#yhq').hide();
        }
    })

    $("#addPrize").click(function(){
    	// alert($('select[name="types"]').val());
    	if(!$("#aid").val()) alert('未选择活动！');
    	else if(!$('input[name="title"]').val()) alert('标题必填！');
    	else if(!$('input[name="thumb"]').val()) alert('图片必填！');
    	else if(!$('select[name="types"]').val()) alert('类型必填！');
    	else if(!$('input[name="detail"]').val() && !$('select[name="yhq"]').val()) alert('内容必填！');
    	else if(!$('input[name="total"]').val()) alert('数量必填！');
    	else if(!$('input[name="chance"]').val()) alert('概率必填！');
    	else if($('input[name="chance"]').val() >= 10000 || $('input[name="chance"]').val() < 0) alert('概率必须小于100%！');
        else{
        	$.ajax({
	            url: "{php echo $this->createWebUrl('addPrize')}",
	            data:{
	                aid: $("#aid").val(),
	                pid: $("#pid").val(),
	                // num: num,
	                title: $('input[name="title"]').val(),
	                thumb: $('input[name="thumb"]').val(),
	                types: $('select[name="types"]').val(),
	                detail: $('select[name="types"]').val() == 4 ? $('select[name="yhq"]').val() :$('input[name="detail"]').val(),
	                total: $('input[name="total"]').val(),
	                chance: $('input[name="chance"]').val()
	            },
	            success: function(res){
	            	var json = JSON.parse(res);
	            	switch(json.types){
	                	case '1': json.types = '积分';break;
	                	case '2': json.types = '余额';break;
	                	case '3': json.types = '实物';break;
	                	case '4': json.types = '优惠券';break;
	                }
	            	if(json.flag == 'add'){
		                //alert(json.title);//<img src="{media $item['thumb']}" width="60" height="60" alt="">http://wxkf2.nttrip.cn/attachment/
		                
		                var html = '<tr><td>'+json.title+'</td><td><img src="'+json.thumb+'" width="60" height="60" alt=""></td><td>'+json.types+'</td><td>'+json.detail+'</td><td>'+
		                 			json.total+'</td><td>'+json.chance+'%</td><td>'+
		                 			'<a class="btn btn-default btn-sm" onclick="modifyPrize('+json.id+')" id="prize'+json.id+'">编辑</a>'+  
	                                ' <a class="btn btn-success btn-sm" onclick="selectPrize('+json.id+')" data-dismiss="modal">选择</a>'+
	                                ' <a class="btn btn-danger btn-sm" onclick="deletePrize(this, '+json.id+')">删除</a>'+
	                                '</td></tr>';
		                $('#prizes').find("tr:first").after(html);
	            	}else{
	            		var html2 = '<td>'+json.title+'</td><td><img src="'+json.thumb+'" width="60" height="60" alt=""></td><td>'+json.types+'</td><td>'+json.detail+'</td><td>'+
		                 			json.total+'</td><td>'+json.chance+'%</td><td>'+
		                 			'<a class="btn btn-default btn-sm" onclick="modifyPrize('+json.id+')" id="prize'+json.id+'">编辑</a>'+
	                                ' <a class="btn btn-success btn-sm" onclick="selectPrize('+json.id+')" data-dismiss="modal">选择</a>'+
	                                ' <a class="btn btn-danger btn-sm" onclick="deletePrize(this, '+json.id+')">删除</a>'+
	                                '</td>';
	            		var temp = '#prize' + json.id;
	            		$(temp).parent().parent().html(html2);
	            	}
	                $('#edit').removeClass('active');
			        $('#choose').addClass('active');
			        $('.choosing').each(function(){
			            $(this).show();
			        })
			        $('.editing').hide();

				}
        	})
        }
    })

    $("#switch").click(function(){
    	
    	$.ajax({
			url: "{php echo $this->createWebUrl('changeMeans')}",
			data: {
				id: $("#aid").val()
			},
			success: function(res){
				if(res == '0'){
		    		$("#switch").prev().val('0'); 
		    		$("#switch").prev().prev().html("<text>摇一摇</text>");
		    	}else{
		    		$("#switch").prev().val('1'); 
		    		$("#switch").prev().prev().html("<text>点击开始</text>");
		    	}
			}
		})
    })

    $(".del").each(function(){
    	$(this).click(function(){
    		// if(confirm('此操作不可恢复，确认吗？')){
	    		var index = $(this).data('index');
	    		$.ajax({
	    			url: "{php echo $this->createWebUrl('delSelectedPrize')}",
	    			data: {
	    				id: $("#aid").val(),
	    				index: index
	    			},
	    			success: function(res){
    					window.location.href = "{php echo $this->createWebUrl('activity', array('op' => 'editPrize'))}" + "&id=" + $("#aid").val();
    				}
    			})
    		// }
    	})
    })
})

</script>
<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">活动奖项设置</h3>
    </div>
    <div class="panel-body">
        <div style="margin-top: 30px" class="row">
            <div class="col-sm-1" style="margin-left: 50px;margin-top: 50px"></div>
            <div href="#mask" data-toggle="modal" data-num='1' class="col-sm-2 square" id='square1'>
                <div class="prize_img">
                    <img src="{media $selectedPrizes[1]['thumb']}" width="100" height="100" alt="">
                </div>
                <div class="prize_title"> 
                    {$selectedPrizes[1]['title']}
                </div>
            </div>
            <div class="col-sm-1">
            	{if $selectedPrizes[1]}
            	<div class="btn btn-xs btn-danger del" data-index='1'>×</div>
            	{/if}
            </div>
            <div href="#mask" data-toggle="modal" data-num='2' class="col-sm-2 square" id='square2'>
            	<div class="prize_img">
                    <img src="{media $selectedPrizes[2]['thumb']}" width="100" height="100" alt="">
                </div>
                <div class="prize_title"> 
                    {$selectedPrizes[2]['title']}
                </div>
            </div>
            <div class="col-sm-1">
            	{if $selectedPrizes[2]}
            	<div class="btn btn-xs btn-danger del" data-index='2'>×</div>
            	{/if}
            </div>
            <div href="#mask" data-toggle="modal" data-num='3' class="col-sm-2 square" id='square3'>
            	<div class="prize_img">
                    <img src="{media $selectedPrizes[3]['thumb']}" width="100" height="100" alt="">
                </div>
                <div class="prize_title"> 
                    {$selectedPrizes[3]['title']}
                </div>
            </div>
            <div class="col-sm-1">
            	{if $selectedPrizes[3]}
            	<div class="btn btn-xs btn-danger del" data-index='3'>×</div>
            	{/if}
            </div>
        </div>
        <div style="margin-top: 50px" class="row">
            <div class="col-sm-1" style="margin-left: 50px;margin-top: 50px"></div>
            <div href="#mask" data-toggle="modal" data-num='8' class="col-sm-2 square" id='square8'>
                <div class="prize_img">
                    <img src="{media $selectedPrizes[8]['thumb']}" width="100" height="100" alt="">
                </div>
                <div class="prize_title"> 
                    {$selectedPrizes[8]['title']}
                </div>
            </div>
            <div class="col-sm-1">
                {if $selectedPrizes[8]}
                <div class="btn btn-xs btn-danger del" data-index='8'>×</div>
                {/if}
            </div>
            <div class="col-sm-2 play">
                <div style="margin-top: 55px;font-size: 24px" >
                    {if $means == '1'}
                    <text>点击开始</text>
                    {else}
                    <text>摇一摇</text>
                    {/if}
                </div>
                <input type="hidden" name="switch" value="{$means}">
                <div class="btn btn-sm btn-success" style="margin-top: 4px;" id="switch">切换</div>
            </div>
            <div class="col-sm-1"></div>
            <div href="#mask" data-toggle="modal" data-num='4' class="col-sm-2 square" id='square4'>
                <div class="prize_img">
                    <img src="{media $selectedPrizes[4]['thumb']}" width="100" height="100" alt="">
                </div>
                <div class="prize_title"> 
                    {$selectedPrizes[4]['title']}
                </div>
            </div>
            <div class="col-sm-1">
                {if $selectedPrizes[4]}
                <div class="btn btn-xs btn-danger del" data-index='4'>×</div>
                {/if}
            </div>
        </div>
        <div style="margin-top: 50px;margin-bottom: 30px" class="row">
            <div class="col-sm-1" style="margin-left: 50px;margin-top: 50px"></div>
            <div href="#mask" data-toggle="modal" data-num='7' class="col-sm-2 square" id='square7'>
                <div class="prize_img">
                    <img src="{media $selectedPrizes[7]['thumb']}" width="100" height="100" alt="">
                </div>
                <div class="prize_title"> 
                    {$selectedPrizes[7]['title']}
                </div>
            </div>
            <div class="col-sm-1">
                {if $selectedPrizes[7]}
                <div class="btn btn-xs btn-danger del" data-index='7'>×</div>
                {/if}
            </div>
            <div href="#mask" data-toggle="modal" data-num='6' class="col-sm-2 square" id='square6'>
                <div class="prize_img">
                    <img src="{media $selectedPrizes[6]['thumb']}" width="100" height="100" alt="">
                </div>
                <div class="prize_title"> 
                    {$selectedPrizes[6]['title']}
                </div>
            </div>
            <div class="col-sm-1">
                {if $selectedPrizes[6]}
                <div class="btn btn-xs btn-danger del" data-index='6'>×</div>
                {/if}
            </div>
            <div href="#mask" data-toggle="modal" data-num='5' class="col-sm-2 square" id='square5'>
                <div class="prize_img">
                    <img src="{media $selectedPrizes[5]['thumb']}" width="100" height="100" alt="">
                </div>
                <div class="prize_title"> 
                    {$selectedPrizes[5]['title']}
                </div>
            </div>
            <div class="col-sm-1">
                {if $selectedPrizes[5]}
                <div class="btn btn-xs btn-danger del" data-index='5'>×</div>
                {/if}
            </div>
        </div>

    
    <table class="table table-responsive we7-table table-hover vertical-middle" style="table-layout: fixed;margin-top: 50px;text-align: center;"> 
	<!-- class="table we7-table table-hover article-list vertical-middle" -->
	<tbody>
		<tr style="background-color: #F4F6F9">
			<td><b>标题</b></td>
			<td><b>类型</b></td>
			<td><b>内容</b></td>
            <td><b>库存</b></td>
			<td><b>总数量</b></td>
			<td><b>总概率</b></td>
		</tr>
		{loop $prizes_set $p}
        <tr>
        	<td>{$p['title']}</td>
        	<td>
        		{if $p['types']=='1'}积分{/if}
            	{if $p['types']=='2'}余额{/if}
            	{if $p['types']=='3'}实物{/if}
            	{if $p['types']=='4'}优惠券{/if}
        	</td>
        	<td>{$p['detail']}</td>
            <td>{$p['storage']}</td>
        	<td>{$p['total_num']}</td>
        	<td>{$p['total_chance']}%</td>
       	</tr>
       	{/loop}
       	<tr>
            <td></td>
       		<td></td>
       		<td></td>
       		<td></td>
       		<td>合计：{$total_num_sum}</td>
       		<td>合计：{$total_chance_sum}%</td>
       	</tr>
    </tbody>
	</table>
    </div>
</div>
<div class="modal fade" id="mask" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="z-index: 1030">
    <div class="modal-dialog">
        <div class="modal-content" style="width: 1200px;margin-left: -240px">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <ul class="nav nav-tabs" style="margin-bottom: 0">
                    <li class="active" id="choose"><a class="modal-title" id="myModalLabel">选择奖品</a></li>
                    <li id="edit"><a class="modal-title" id="myModalLabel">添加奖品</a></li>
                </ul>
            </div>
            <div class="modal-body choosing">
                    <table id="prizes" class="table we7-table table-hover article-list vertical-middle">
                        <tr>
                            <td style="width: 14%">标题</td>
                            <td style="width: 14%">图片</td>
                            <td style="width: 13%">类型</td>
                            <td style="width: 13%">内容</td>
                            <td style="width: 13%">数量</td>
                            <td style="width: 13%">概率</td>
                            <td style="width: 18%">操作</td>
                        </tr>
                        {loop $prizes $prize}
                        <tr>
                            <td>
                                {$prize['title']}
                            </td>
                            <td>
                                <img src="{media $prize['thumb']}" width="60" height="60" alt="">
                            </td>
                            <td>
                            	{if $prize['types']=='1'}积分{/if}
                            	{if $prize['types']=='2'}余额{/if}
                            	{if $prize['types']=='3'}实物{/if}
                            	{if $prize['types']=='4'}优惠券{/if}
                            </td>
                            <td>
                            	{$prize['detail']}
                            </td>
                            <td>
                            	{$prize['total']}
                            </td>
                            <td>
                            	{$prize['chance']}%
                            </td>
                            <td>
                                <a class="btn btn-default btn-sm" onclick="modifyPrize({$prize['id']})" id="prize{$prize['id']}">编辑</a>
                                <a class="btn btn-success btn-sm" onclick="selectPrize({$prize['id']})" data-dismiss="modal">选择</a>
                                <a class="btn btn-danger btn-sm" onclick="deletePrize(this, {$prize['id']})">删除</a>
                            </td>
                        </tr>
                        {/loop}
                    </table>
            </div>
            <div class="modal-footer choosing">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <!-- <button type="button" class="btn btn-primary">确定</button> -->
            </div>
            <div class="editing" style="display: none;">
                <form class="form-horizontal" action="" method="post">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="" class="control-label col-sm-2" style="margin-right:45px">奖项标题</label>
                            <div class="form-controls col-sm-5">
                                <input type="text" name="title" value="" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                            </div>
                            <div class="col-sm-1"></div>
                            <div class="form-controls col-sm-3 help-block">必填</div>
                        </div>
                        <div class="form-group">
                            <label for="" class="control-label col-sm-2" style="margin-right:45px">主图</label>
                            <div class="form-controls col-sm-5">
                                {php echo tpl_form_field_image('thumb', '')}
                            </div>
                            <div class="col-sm-1"></div>
                            <div class="form-controls col-sm-3 help-block">必填</div>
                        </div>
                        <div class="form-group">
                            <label for="" class="control-label col-sm-2" style="margin-right:45px">所属类型</label>
                            <div class="form-controls col-sm-5" style="padding-right: 30px;">
                                <select name="types" class="form-control">
                                    <option value="">--选择奖品类型--</option>
                                    <option value="1">积分</option>
                                    <option value="2">余额</option>
                                    <option value="3">实物</option>
                                    <option value="4">优惠券</option>
                                </select>
                            </div>
                            <div class="form-controls col-sm-4 help-block">必填</div>
                        </div>
                        <div class="form-group" id="not_yhq">
                            <label for="" class="control-label col-sm-2" style="margin-right:45px">奖品内容</label>
                            <div class="form-controls col-sm-5">
                                <input type="text" name="detail" value="" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                            </div>
                            <div class="col-sm-1"></div>
                            <div class="form-controls col-sm-3 help-block">积分和余额要填数字</div>
                        </div>
                        <div class="form-group" id="yhq" style="display: none;">
                            <label for="" class="control-label col-sm-2" style="margin-right:45px">优惠券</label>
                            <div class="form-controls col-sm-5" style="padding-right: 30px;">
                                <select name="yhq" id="youhuiquan" class="form-control">
                                    <option value="">--选择优惠券--</option>
                                    {loop $coupons $coupon}
                                    <option value="{$coupon['id']}">{$coupon['title']}</option>
                                    {/loop}
                                </select>
                            </div>
                            <div class="form-controls col-sm-4 help-block">必填</div>
                        </div>
                        <div class="form-group">
                            <label for="" class="control-label col-sm-2" style="margin-right:45px">数量</label>
                            <div class="form-controls col-sm-5">
                                <input type="text" name="total" value="" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                            </div>
                            <div class="col-sm-1"></div>
                            <div class="form-controls col-sm-3 help-block">必填</div>
                        </div>
                        <div class="form-group">
                            <label for="" class="control-label col-sm-2" style="margin-right:45px">中奖概率</label>
                            <div class="form-controls col-sm-5">
                                <input type="text" name="chance" value="" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                            </div>
                            <div class="col-sm-1" style="margin-top: 5px;font-size: 20px;margin-left: -5px">‱</div>
                            <div class="form-controls col-sm-3 help-block">填0~9999的整数，填1概率即为万分之一</div>
                        </div>
                        <input type="hidden" id="aid" name="aid" value="{$id}" />
                        <input type="hidden" id="pid" name="pid" value="" />
                        <input type="hidden" disabled name="num" id="num" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="button" id="addPrize" class="btn btn-primary">提交</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
	function modifyPrize(id){
    	$.ajax({
    		url: "{php echo $this->createWebUrl('getPrizeInfo')}",
    		data: {
    			id: id
    		},
    		success: function(res){
    			var j = JSON.parse(res);
    			$('input[name="title"]').val(j.title);
               	$('input[name="thumb"]').val(j.thumb);
               	$('select[name="types"]').val(j.types);
                if(j.types != '4'){
                   $('#not_yhq').show();
                   $('#yhq').hide();
            	   $('input[name="detail"]').val(j.detail); 
                }else{
                   $('#not_yhq').hide();
                   $('#yhq').show();
                   $('#youhuiquan').find('option[value="'+j.detail+'"]').attr('selected', true);
                }
               	$('input[name="total"]').val(j.total);
            	$('input[name="chance"]').val(j.chance);
            	$('input[name="thumb"]').parent().next().find("img").attr("src", j.thumb_https);
            	$('#pid').val(j.id);
    		}
    	})
    	$('#choose').removeClass('active');
        $('#edit').addClass('active');
        $('.choosing').each(function(){
            $(this).hide();
        })
        $('.editing').show();
    }

    function deletePrize(that, id){
        if(confirm('此操作不可恢复，确认吗？')){
            $.ajax({
            url: "{php echo $this->createWebUrl('delPrize')}",
            data: {
                id: id
            },
            success: function(res){
                var json = JSON.parse(res);
                if(json == 1){
                    $(that).parent().parent().remove();
                    alert('删除成功！');
                }
            }
        })
        }
    }

    function selectPrize(id){
        $.ajax({
            url: "{php echo $this->createWebUrl('selectPrize')}",
            data: {
                id: id,
                num: $("#num").val(),
                aid: $("#aid").val()
            },
            success: function(res){
                var json = JSON.parse(res);
                if(json.flag == 1){
                	alert(json.warning);
                }else if(json.flag == 2){
                	alert(json.warning);
                }else{
                	window.location.href = "{php echo $this->createWebUrl('activity', array('op' => 'editPrize'))}" + "&id=" + json.aid;
                }
            }
        })
    }
</script>
{/if}
{if $op == 'record'}

<div>
    <input type="hidden" name="activity_id" value="{$id}" disabled id="activity_id" />
    <div style="display: inline;"><h3 style="float: left;margin-top: 0;">抽奖记录</h3></div>
    <div class="col-sm-1 btn btn-sm btn-primary" style="display:inline;margin-left: 30px" id="excel">导出excel</div>
    <div style="display: inline;" class="col-sm-2"></div>
    <div style="display: inline;">
    <form class="form-inline" action="" method="post">
        <div class="form-group" >
            <div class="form-controls">
                <select name="select_pid" id="select_pid" class="form-control" style="width: 200px">
                    <option value="">--中奖奖项--</option>
                    {loop $prizesSet $p}
                    <option value="{$p['id']}" {if $select_pid == $p['id']}selected{/if}>{$p['detail']}</option>
                    {/loop}
                </select>
            </div>
        </div>
        <div class="form-group">
            <div class="form-controls">
                <select name="select_status" id="select_status" class="form-control" style="width: 200px">
                    <option value="">--中奖状态--</option>
                    <option value="0" {if $select_status == '0'}selected{/if}>未中奖</option>
                    <option value="1" {if $select_status == '1'}selected{/if}>待领取</option>
                    <option value="2" {if $select_status == '2'}selected{/if}>已领取</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-3">
   <!--              <input name="token" type="hidden" value="{$_W['token']}" /> -->
                <div class="btn btn-primary" id="filter" />提交</div>
            </div>
        </div>
    </form>
    </div>
    
</div>
<table class="table table-responsive we7-table table-hover vertical-middle" style="table-layout: fixed;margin-top: 20px" > 
    <tbody>
        <tr>
            <td style="width: 90px">序号</td>
            <td style="width: 120px">抽奖人姓名</td>
            <td style="width: 140px">手机号</td>
            <td style="width: 205px">地址</td>
            <td style="width: 180px">抽奖结果</td>
            <td>抽奖时间</td>
        </tr>
        {loop $records $index $record}
        <tr>
            <td><?php echo $begin+$index+1; ?></td>
            <td>{$record['realname']}</td>
            <td>{$record['mobile']}</td>
            <td>{$record['address']}</td>
            <td>
                {if $record['status'] == '0'}<div class="label label-sm label-primary">未中奖</div>{/if}
                {if $record['types'] == '3' && $record['status'] == '1'}
                    <!-- <div class="label label-sm label-success">待领取</div> -->
                    <div class="btn btn-xs btn-danger shenhe" data-rid="{$record['id']}">审核发货</div>
                    <div>{$record['prize_detail']}</div>
                {/if}
                {if ($record['types'] != '3' || $record['status'] == '2') && $record['status'] != '0' }<div class="label label-sm label-success">已领取</div><div>{$record['prize_detail']}</div>{/if}
            </td>
            <td>{$record['createtime']}</td>
        </tr>
        {/loop}
    </tbody>
</table>
<script type="text/javascript">
    $(document).ready(function(){

        // $('.pagination a').each(function(){
            
        //     if(!$(this).parent().hasClass('active')){
        //         var href = $(this).attr('href');

                // if(href.indexOf('&select_pid')>=0){
                //     href = href.substring(0, href.indexOf('&select_pid'));
                // }
            
                // $(this).attr('href', href + "&select_pid=" + $('#select_pid').val() + "&id=" + $("#activity_id").val() + "&select_status=" + $('#select_status').val()) ;
             
        //     }
        // })

        $("#excel").click(function(){
            window.location.href = "{php echo $this->createWebUrl('activity', array('op' => 'record'))}" + "&opt=excel&select_pid=" + 
                    $('#select_pid').val() + "&select_status=" + $('#select_status').val() + "&id=" + $("#activity_id").val();
        })

        $("#filter").click(function(){
            window.location.href = "{php echo $this->createWebUrl('activity', array('op' => 'record'))}" + "&select_pid=" + 
                    $('#select_pid').val() + "&select_status=" + $('#select_status').val() + "&id=" + $("#activity_id").val();
        })

        $(".shenhe").each(function(){
            $(this).click(function(){
                window.location.href = "{php echo $this->createWebUrl('activity', array('op' => 'record'))}" + "&opt=shenhe&select_pid=" + 
                    $('#select_pid').val() + "&select_status=" + $('#select_status').val() + "&id=" + $("#activity_id").val() + "&rid=" + $(this).data("rid");
            })
        })
    });
</script>
{$pager}
{/if}
{template 'common/footer'}