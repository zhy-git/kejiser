{template 'common/header'}
<link rel="stylesheet" href="/addons/sudu8_page//static/css/web-icons/web-icons.css">
<link href="https://cdn.bootcss.com/bootstrap-select/2.0.0-beta1/css/bootstrap-select.min.css" rel="stylesheet">
<ul class="nav nav-tabs">

    {if $id}
    <li {if $op == 'display'}class="active"{/if}><a href="{php echo $this->createWebUrl('proadd', array('op' => 'display',  'id' => $id ))}">基本信息</a></li>
    {else}
    <li {if $op == 'display'}class="active"{/if}><a href="{php echo $this->createWebUrl('proadd', array('op' => 'display'))}">基本信息</a></li>
    {/if}

    {if $id}
    <li {if $op == 'types'}class="active"{/if}><a href="{php echo $this->createWebUrl('proadd', array('op' => 'types', 'id' => $id ))}">规格/库存</a></li>
    {/if}

</ul>


{if $op == 'display'}

<div class="panel-body">
    <div class="form-group" style="color:red">
       先配置拼团产品基础信息，点击下一步后详细配置产品详细信息
    </div>
</div>

<form class="form-horizontal" action="" method="post" onsubmit = "return checkmessage();">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">产品基础信息管理</h3>
        </div>
        <div class="panel-body">
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">序号</label>
                <div class="form-controls col-sm-5">
                    <input type="number" min='0' name="num" id="num" value="{$products['num']}" style="width: 100px" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">序号越大越靠前</div>
            </div>

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">所属栏目</label>
                <div class="form-controls col-sm-5">
                    <select name="cid" class="form-control">
                         {loop $listAll $cateP}
                            <option value="{$cateP['id']}" {if $products['pcid'] == $cateP['id']}selected="selected"{/if}>{$cateP['title']}</option>
                        {/loop}
                    </select>
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">选择所属栏目</div>
            </div>

			 <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">上下架</label>
                <div class="form-controls col-sm-5" style="padding-right: 30px;">
                    <label style="margin-right: 20px">
                        <input type="radio" name="show_pro" value="1" {if $products['show_pro'] == '1'} checked{/if} />
                        上架
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="show_pro" value="0" {if $products['show_pro'] == '0'} checked{/if} />
                        下架
                    </label>
                </div>
				<div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">上架后，此商品可展示在商品列表</div>
            </div>

             <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">推荐到横排</label>
                <div class="form-controls col-sm-5">
                    <label style="margin-right: 20px">
                        <input type="radio" name="type_x" value="0" {if $products['type_x'] == '0'} checked{/if} />
                        不推荐
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="type_x" value="1" {if $products['type_x'] == '1'} checked{/if} />
                        推荐
                    </label>
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">推荐后会在首页横排区块显示</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">推荐到竖排</label>
                <div class="form-controls col-sm-5">
                    <label style="margin-right: 20px">
                        <input type="radio" name="type_y" value="0" {if $products['type_y'] == '0'} checked{/if} />
                        不推荐
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="type_y" value="1" {if $products['type_y'] == '1'} checked{/if} />
                        推荐
                    </label>
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">推荐后会在首页竖排区块显示</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">推荐到首页栏目</label>
                <div class="form-controls col-sm-5">
                    <label style="margin-right: 20px">
                        <input type="radio" name="type_i" value="0" {if $products['type_i'] == '0'} checked{/if} />
                        不推荐
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="type_i" value="1" {if $products['type_i'] == '1'} checked{/if} />
                        推荐
                    </label>
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">推荐后会在首页该栏目块显示</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">取商品方式</label>
                <div class="form-controls col-sm-5">
                    <label style="margin-right: 20px">
                        <input type="radio" name="kuaidi" value="0" {if $products}{if $products['kuaidi'] == '0'} checked{/if}{/if} />
                        快递
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="kuaidi" value="1" {if $products}{if $products['kuaidi'] == '1'} checked{/if} {/if}/>
                        到店自取
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="kuaidi" value="2"  {if $products}{if $products['kuaidi'] == '2'} checked{/if}{else}checked{/if} />
                        全部
                    </label>
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">不选默认全部</div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">运费模板</label>
                <div class="form-controls col-sm-5">
                    <select class="form-control" name="yunfei_ggid">
                        <option value="0">选择运费模板</option>
                        {loop $yunfei_gg_list $vs}
                        <option value="{$vs['id']}" {if $vs['id'] == $products['yunfei_ggid']}selected{/if}>{$vs['name']}</option>
                        {/loop}
                    </select>
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">选择后使用选中运费模板</div>
            </div>
            <div class="form-group" style="display: block;">
                <label class="control-label col-sm-2" style="margin-right:45px">选择所属门店</label>
                <div class="form-controls col-sm-5" id="sonscatas">
                    <select name="stores[]" class="selectpicker form-control" multiple data-tick-icon="wb-star" data-icon-base="wb">
                    {loop $stores $vi}
                        <?php if(in_array($vi['id'], $stores_now)){?>
                        <option value="{$vi['id']}" selected="selected">{$vi['title']}</option>
                        <?php }else{?>
                        <option value="{$vi['id']}" >{$vi['title']}</option>
                        <?php }?>
                    {/loop}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">标题</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="title" id="title" value="{$products['title']}" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">请填写标题</div>
            </div>


            <div class="form-group">

                <label for="" class="control-label col-sm-2" style="margin-right:45px">缩略图</label>

                <div class="form-controls col-sm-5">

                    {php echo tpl_form_field_image('thumb', $products['thumb'])}

                </div>

                <div class="col-sm-1"></div>

                <div class="form-controls col-sm-3 help-block">最宽750px，高度随意</div>

            </div>

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">简介</label>
                <div class="form-controls col-sm-5">
                    <textarea class="form-control" rows="3" name="descs" placeholder="">{$products['descs']}</textarea>
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">请输入简介</div>
            </div>

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">组图</label>
                <div class="form-controls col-sm-5">
                    {php echo tpl_form_field_multi_image('imgtext',$products['imgtext']);}
                </div>
            </div>

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">标签</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="explains" id="explains" value="{$products['explains']}" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">多个标签请用英文","隔开</div>
            </div>



            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">拼团价</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="price" id="price" onkeyup="clearNoNum(this)" value="{$products['price']}" style="width: 100px" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">拼团价[显示用，一般设置最低价]  </div>
            </div>

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">团长折扣</label>
                <div class="form-controls col-sm-5">
                    <div class="input-group" style="width: 100px">
                      <input type="number" min='1' class="form-control" name="tz_yh" id="tz_yh" value="{$products['tz_yh']}">
                      <span class="input-group-addon">折</span>
                    </div>
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">请填1-10，填10则没有折扣</div>
            </div>

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">单买价</label>
                <div class="form-controls col-sm-5">
                    <input type="text" name="mark_price" onkeyup="clearNoNum(this)" id="mark_price" value="{$products['mark_price']}" style="width: 100px" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">单买价[显示用，一般设置最高价]</div>
            </div>


            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">最多可用积分</label>
                <div class="form-controls col-sm-5">
                    <input type="number" min="0" name="score" id="score" value="{$products['score']}" style="width: 100px" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">最多可用积分</div>
            </div>

            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">拼团人数</label>
                <div class="form-controls col-sm-5">
                    <input type="number" min="0" name="pt_min" id="pt_min" value="{$products['pt_min']}" style="width: 100px; float:left;" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                    <span style="float:left;padding:0px 20px; line-height:30px">——</span>
                    <input type="number" min="0" name="pt_max" id="pt_max" value="{$products['pt_max']}" style="width: 100px; float:left;" class="form-control ng-pristine ng-untouched ng-valid ng-empty"  placeholder="" autocomplete="off">
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">请填写组团人数区间默认2到5人</div>
            </div>

            <!-- <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">拼团方式</label>
                <div class="form-controls col-sm-5">
                    <label style="margin-right: 20px">
                        <input type="radio" name="types" value="1" {if $products['types'] == '1' || !$products} checked{/if} />
                        单层团
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="types" value="2" {if $products['types'] == '2'} checked{/if} />
                        阶梯团
                    </label>
                </div>
            </div> -->


            <div class="form-group">
                <label for="" class="control-label col-sm-2" style="margin-right:45px">产品详情</label>
                <div class="form-controls col-sm-8">
                    {php echo tpl_ueditor('product_txt', $products['texts']);}
                    <div class="help-block">请输入详细介绍</div>
                </div>
            </div>
        </div>
    </div>
    <!-- 会员卡设置 -->
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">会员购买设置</h3>
        </div>
        <div class="panel-body">
            <div class="form-group nr">
                <label for="" class="control-label col-sm-2" style="margin-right: 45px">开启单独会员购买设置</label>
                <div class="form-controls col-sm-5" style="padding-top: 7px">
                    <label style="margin-right: 20px">
                        <input type="radio" name="set1" value="1" {if $products}{if $products['vipconfig']}{if $products['vipconfig']['set1']==1}checked=checked{/if}{/if}{/if}/>
                    开启
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="set1" value="0" {if $products}{if $products['vipconfig']}{if $products['vipconfig']['set1']==0}checked=checked{/if}{else}checked=checked{/if}{else}checked=checked{/if}/>
                    关闭
                    </label>
                </div>
            </div>
            <div class="form-group nr">
                <label for="" class="control-label col-sm-2" style="margin-right: 45px">会员购买设置</label>
                <div class="form-controls col-sm-5" style="padding-top: 7px">
                    <label style="margin-right: 20px">
                        <input type="radio" name="set2" value="1" {if $products}{if $products['vipconfig']}{if $products['vipconfig']['set2']==1}checked=checked{/if}{/if}{/if}/>
                    开启
                    </label>
                    <label style="margin-right: 20px">
                        <input type="radio" name="set2" value="0" {if $products}{if $products['vipconfig']}{if $products['vipconfig']['set2']==0}checked=checked{/if}{else}checked=checked{/if}{else}checked=checked{/if}/>
                    关闭
                    </label>
                </div>
            </div>
            <div class="form-group set3" style="display: {if $products['vipconfig']['set2']==1}block{else}none{/if};">
                <label for="" class="control-label col-sm-2" style="margin-right: 45px">购买等级</label>
                <div class="form-controls col-sm-3" style="padding-top: 7px">
                <select name="set3" id="set3" class="form-control" style="width: 200px;display: inline-block;font-size: 12px">
                    {loop $grade_arr $i}
                        <option value="{$i['grade']}" {if $products['vipconfig']['set3'] == $i['grade']}selected='selected'{/if}>{$i['name']}({$i['grade']}级)</option>
                    {/loop}
                </select>
                </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">购买开始等级,如大众会员(1级)，即1,2,3,4..级都可购买</div>
            </div>

             <div class="form-group" >
                        <label for="" class="control-label col-sm-2" style="margin-right:45px">万能表单</label>
                        <div class="form-controls col-sm-5">
                            <select name="formset" style="width: 200px">
                                <option value="0">---不启用---</option>
                                {loop $gwcforms $val}
                                    <option value="{$val['id']}" {if $products}{if $val['id'] == $products['formset']}selected{/if}{/if}>{$val['formname']}</option>
                                {/loop}
                            </select>
                        </div>
                <div class="col-sm-1"></div>
                <div class="form-controls col-sm-3 help-block">选择后则可提交信息</div>
            </div>

            
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <input name="token" type="hidden" value="{$_W['token']}" />
            <input type="submit" class="btn btn-primary col-lg-1" name="submit" value="下一步"/>
        </div>
    </div>
</form>
{/if}

<script type="text/javascript">
    $('input[name="set2"]').each(function(){
        $(this).click(function(){
            if($(this).val()==1){
                $('.set3').show()
            }else{
                $('.set3').hide()
            }
        })
    })
    function clearNoNum(obj){  
      obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
      if(obj.value.charAt(0,1) == "."){
        obj.value = "";
      }
      obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的   
      obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");  
      obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3');//只能输入两个小数   
      if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额  
       obj.value= parseFloat(obj.value);  
      }  
    }
	function checkmessage(){
		var name=/^[a-z,A-Z,\d,_,\u4e00-\u9fa5]{1,30}$/;

		if(!$("#title").val()){
			alert("请填写标题！");
			return false;
		} else if(!name.test($('#title').val())) {
			alert("标题必须为1-30位的数字，字母，下划线或中文字符");
			return false;
		}
		
		var num = $('#num').val();
		if(isNaN(num) || num < 0){
			alert("序号请填入数字！");
			return false;
		}
		if(num.length > 6){
			alert("序号为最多为6位数字！");
			return false;
		}
		
		if(!$("#price").val()){
			alert("请填写拼团价！");
			return false;
		} else if(isNaN($("#price").val())){
			alert("拼团价请填入数字！");
			return false;
		}

		if(!$("#mark_price").val()){
			alert("请填写单买价！");
			return false;
		} else if(isNaN($("#mark_price").val())){
			alert("单买价请填入数字！");
			return false;
		}
		if(isNaN($("#score").val())){
			alert("最多可用积分请填入数字！");
			return false;
		}
		
		var pt_min = parseInt($("#pt_min").val());
		var pt_max = parseInt($("#pt_max").val());

		if(!$("#pt_min").val() || !$("#pt_max").val()||pt_min==0||pt_max==0){
			alert("请填写拼团人数！");
			return false;
		} else if(isNaN($("#pt_min").val()) || isNaN($("#pt_max").val())){
			alert("拼团人数请填入数字！");
			return false;
		} else if(pt_min > pt_max){
			alert("拼团最小人数不得大于最大人数！");
			return false;
		}

		var tz_yh = $("#tz_yh").val();
		if(!tz_yh){
			alert("请填写团长折扣！");
			return false;
		} else if(isNaN(tz_yh)){
			alert("团长折扣请填1~10的数字！");
			return false;
		} else if(tz_yh < 1 || tz_yh > 10){
			alert("团长折扣请填1~10的数字！");
			return false;
		}

		if($('#explains').val()){
			if (!name.test($('#explains').val())) {
				alert("标签必须为1-30位的数字，字母，下划线或中文字符");
				return false;
			  }
		}
	}

	//$('.imgurl_input input').attr('disabled',true);
</script>

{if $op == 'types'}
    <style type="text/css">
        .ggz{
            border-left: 1px solid #dedede;
            border-top: 1px solid #dedede;
            border-bottom: 1px solid #dedede;
            text-align: center !important;
            height: 34px;
            line-height: 34px;
            padding-top: 0 !important;
            background-color: #eeeeee;
            width: 60px;
        }
        .ggzbtn{
            border-right: 1px solid #dedede;
            border-top: 1px solid #dedede;
            border-bottom: 1px solid #dedede;
            text-align: center !important;
            height: 34px;
            line-height: 34px;
            padding-top: 0 !important;
            background-color: #eeeeee;
            position: absolute;
            width: 60px;
            cursor:pointer;
            right: 0;
            top: 0;
        }
        .dels{
            position: absolute;
            right: 10px;
            top: 7px;
            cursor:pointer;
        }

        .waic1{
            border:1px solid #dedede; margin-top:20px; padding:10px;
        }
        .waic2{
            background-color:#eeeeee;; line-height:30px; padding:0 10px; position:relative;
        }
        .waic3{
            position: relative; margin-top:10px;
        }
        .ggzbtn3{
            border-right: 1px solid #dedede;
            border-top: 1px solid #dedede;
            border-bottom: 1px solid #dedede;
            text-align: center !important;
            height: 34px;
            line-height: 34px;
            padding-top: 0 !important;
            background-color: #eeeeee;
            position: absolute;
            width: 60px;
            cursor:pointer;
            right:0px;
            top: 0;
        }
        .yandd{
            display: inline-block;
            border: 1px solid #dedede;
            padding: 3px 5px;
            margin-top: 10px;
            margin-right: 5px;
        }
        .ssnd{
            cursor:pointer;
            padding: 0 5px;
        }
        .biaotou{
            text-align: center;
            padding: 8px 0;
            font-weight: bold;
        }
        .tds{
            text-align: center;
            padding: 8px 0;
        }
        .shukdd{
            width: 100px;
            padding: 4px 5px;
            border: 1px solid #dedede;
        }
        .sddds{
            position: relative;
        }
        .ggsx{
            border: 1px solid #dedede;
            width: 60px;
            text-align: center;
            padding: 2px;
            position: absolute;
            right: 5px;
            top: 6px;
            cursor:pointer;
        }
        .ggzbcaa{
            position: relative;
            height: 30px;
            margin-top: 10px;
        }
        .ggzbc{
            border: 1px solid #dedede;
            background-color: #eeeeee;
            width: 120px;
            padding: 5px;
            position: absolute;
            left: 50%;
            margin-left: -60px;
            text-align: center;
            cursor:pointer;
        }
        .sdhd{
            line-height: 35px;
        }
        .xuzndt{
            border: 1px solid #dedede;
            width: 40%;
            display: inline-block;
            text-align: center;
            padding: 3px 0px;
            cursor:pointer;
        }
        .xuzndd{
            width: 50px;
            max-height: 50px;
            margin-top: 5px;
            margin-left: 10%;
        }
        .xuzndd img{
            width: 100%;
            max-height: 50px;
        }

    </style>
    <form class="form-horizontal" action="" method="post">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">产品管理</h3>
            </div>
            <div class="panel-body">


                <div id="jtgg">
                    <div class="form-group">
                        <label for="" class="control-label col-sm-2" style="margin-right:33px">规格组和规格值</label>
                        <div class="form-controls col-sm-6" id="izggz" {if $counttypes == 3}style="display:none;"{/if}>
                            <label for="" class="control-label col-sm-2 ggz">规格组</label>
                            <input type="text" id="ggzval" placeholder="如颜色、尺码、套餐"  style="width:298px" class="form-control ng-pristine ng-untouched ng-valid ng-empty">
                            <label for="" class="control-label col-sm-2 ggzbtn" onclick="ggzset()">确定</label>
                        </div>
                        <div class="form-controls col-sm-6 sdhd" id="izggzw" {if $counttypes < 3}style="display:none;"{/if}>
                            最多只可添加3个规格组
                        </div>
                        <div class="form-controls col-sm-6" id="izggzwval" style="margin-left:172px">



                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel panel-default" id="ggzs">
            <div class="panel-heading sddds">
                <h3 class="panel-title">规格值<!--<font color="red">[请先进行刷新操作,最后保存操作]</font>--></h3>
         <!--        <div class="ggsx" onclick="datasets()">
                    刷新
                </div> -->
            </div>

            <div style="padding:10px">
                <table cellpadding="0" cellspacing="0" style="border:1px solid #dedede" border="1px" width="100%" id="tabb">

                </table>
                <!-- <div class="ggzbcaa">
                    <div class="ggzbc" onclick="ggzbc()">规格值保存</div>
                </div> -->
            </div>
        </div>

        <!-- 规格组长度 -->
        <input type="hidden" id="typelen" name="typelen">
        <!-- 规格组 -->
        <input type="hidden" id="typesarr" name="typesarr">
        <!-- 所有字商品的数据 -->
        <input type="hidden" id="biaogedata" name="biaogedata">


        <div class="form-group">
            <div class="col-sm-12">
                <input name="token" type="hidden" value="{$_W['token']}" />
                <input type="submit" class="btn btn-primary col-lg-1" name="submit" value="保存" onclick="ggzbc()"/>
            </div>
        </div>

    </form>


    <script type="text/javascript">
        var datacounts = 0;
        var typessy = 2;
        var ggznum = 0;  //控制显示可输入规格组input

        {if $id}
            $(function(){
                ggzhtml();
                datasets();
            })
        {/if}




        // 规格组数组
        {if $counttypes > 0}
            var ggzarr = [];
            {loop $typesarr $item}
                ggznum++;
                ggzarr.push("{$item}");
            {/loop}
            datacounts = 1;
        {else}
            var ggzarr = [];
            datacounts = 0;
        {/if}

        //规格组json
        {if $counttypes > 0}

            var ggzjson = {};
            {loop $typesjson $aa $res}
                var carr = [];
                {loop $res $rec}
                    carr.push("{$rec}");
                {/loop}
                ggzjson["{$aa}"] = carr;
            {/loop}

        {else}
            var ggzjson = {};
        {/if}


        //增加规格组
        function ggzset(){
            datacounts = 0;
            var ggzval = $("#ggzval").val();
            if(ggzval){
                ggznum++;
                if(ggznum>3){
                    $("#izggz").hide();
                    $("#izggzw").show();
                    ggznum--;
                    return false;
                }
                ggzarr.push(ggzval);  //追加规格数组

                ggzjson[ggzval] = [];

                $("#ggzval").val("");
                ggzhtml();
            }else{
                alert("请先设置规格组名！")
            }


        }

        // 增加规格组操作
        function ggzhtml(){
            var ggzhtml = "";
            console.log(ggzarr);
            for(var i=0; i<ggzarr.length; i++){
                var jsonarr = "";
                var key = ggzarr[i];
                var arr = ggzjson[key];
                if(arr != undefined){
                    for(var j=0; j<arr.length; j++){
                        jsonarr +=   "<div class='yandd'>"+
                                        "<span>"+arr[j]+"</span>"+
                                        "<span class='ssnd' onclick='delbq("+j+","+i+")'>x</span>"+
                                    "</div>";
                    }

                    ggzhtml += "<div class='waic1'>"+
                                "<div class='waic2'>"+
                                    ggzarr[i]+
                                    "<div class='leix5 wi wi-delete dels' onclick='del("+i+")'>"+"</div>"+
                                "</div>"+
                                "<div class='waic4' id='ggzid"+i+"'>"+
                                jsonarr+
                                "</div>"+
                                "<div class='waic3'>"+
                                    "<label for='' class='control-label col-sm-2 ggz'>规格值</label>"+
                                    "<input type='text' id='ggzval"+i+"' placeholder='如红色、白色'  style='width:276px' class='form-control ng-pristine ng-untouched ng-valid ng-empty'>"+
                                    "<label for='' class='control-label col-sm-2 ggzbtn3' onclick='ggzqd("+i+")'>确定</label>"+
                                "</div>"+
                            "</div>";
                }
      
            }
            $("#izggzwval").html(ggzhtml)
        }

        // 删除规格组
        function del(i){
            
            datacounts = 0;
            ggznum--;
            console.log("this is "+ggznum)
            $("#izggz").show();
            $("#izggzw").hide();

            var keys = ggzarr[i];
            delete ggzjson[keys];

            ggzarr.splice(i,1);
            ggzhtml();
            datasets();

        }

        // 增加规格值
        function ggzqd(val){
            datacounts = 0;

            var keys = ggzarr[val];
            var ggz = $("#ggzval"+val).val();
            if(!ggz){
                alert("请输入对应的规格值");
            }else{
                var arr = ggzjson[keys];
                if(arr.indexOf(ggz) >= 0){
                    alert("不能重复添加规格值！");
                    $("#ggzval"+val).val("");
                    return false;
                }
                arr.push(ggz);
                datasets();
            }

            var strhtml = "";
            for(var i=0; i<arr.length; i++){
                strhtml += "<div class='yandd'>"+
                                "<span>"+arr[i]+"</span>"+
                                "<span class='ssnd' onclick='delbq("+i+","+val+")'>x</span>"+
                            "</div>";
            }
            $("#ggzid"+val).html(strhtml);
            $("#ggzval"+val).val("");
            ggzjson[keys] = arr;
        }

        // 删除标签功能
        function delbq(i,val){
            var keys = ggzarr[val];
            var arr = ggzjson[keys];
            arr.splice(i,1);

            var strhtml = "";
            for(var i=0; i<arr.length; i++){
                strhtml += "<div class='yandd'>"+
                                "<span>"+arr[i]+"</span>"+
                                "<span class='ssnd' onclick='delbq("+i+","+val+")'>x</span>"+
                            "</div>";
            }
            $("#ggzid"+val).html(strhtml);
            $("#ggzval"+val).val("");

            ggzjson[keys] = arr;
            datasets();
        }

        var jg = ["库存","拼团价","单买价","规格图片"];
        var allarrone = []; //构建多重json
        var tablearr = [];  //构建表格头部
        // 构建规格
        function datasets(){

            allarrone = []; //构建多重json
            tablearr = [];  //构建表格头部
            $("#tabb").html("");
            //判断规格组的值有没有都设置
            for(var i=0; i<ggzarr.length; i++){
                if(ggzjson[ggzarr[i]].length == 0){
                    alert(ggzarr[i]+"规格组没有设置规格值！");
                    return;
                }
            }
            //构建多重json一条数据
            if(ggzarr.length == 1){
                var sz1 = ggzjson[ggzarr[0]];

                //构建表格
                tablearr.push(ggzarr[0]);
                tablearr = tablearr.concat(jg);

                for(var i=0; i<sz1.length; i++){

                    var datakey = sz1[i];

                    if(datacounts == 1){
                        {loop $datajson $index $item}

                            if("{$index}"== datakey){
                                var aa = "{$item}";
                                var newarr = aa.split(",");
                                var jsondata = {};
                                jsondata[ggzarr[0]] = sz1[i];
                                jsondata["库存"] = newarr[0];
                                jsondata["拼团价"] = newarr[1];
                                jsondata["单买价"] = newarr[2];
                                jsondata["规格图片"] = newarr[3];
                                allarrone.push(jsondata);
                            }
                        {/loop}
                    }else{
                        var jsondata = {};
                        jsondata[ggzarr[0]] = sz1[i];
                        jsondata["库存"] = 0;
                        jsondata["拼团价"] = 0;
                        jsondata["单买价"] = 0;
                        jsondata["规格图片"] = "";
                        allarrone.push(jsondata);
                    }

                }
            }
            //构建多重json二条数据
            if(ggzarr.length == 2){
                var sz1 = ggzjson[ggzarr[0]];
                var sz2 = ggzjson[ggzarr[1]];

                //构建表格
                tablearr.push(ggzarr[0]);
                tablearr.push(ggzarr[1]);
                tablearr = tablearr.concat(jg);

                for(var i=0; i<sz1.length; i++){
                    for(var j=0; j<sz2.length; j++){

                        var datakey = sz1[i]+sz2[j];

                        if(datacounts == 1){
                            {loop $datajson $index $item}

                                if("{$index}"== datakey){
                                    var aa = "{$item}";
                                    var newarr = aa.split(",");
                                    var jsondata = {};
                                    jsondata[ggzarr[0]] = sz1[i];
                                    jsondata[ggzarr[1]] = sz2[j];
                                    jsondata["库存"] = newarr[0];
                                    jsondata["拼团价"] = newarr[1];
                                    jsondata["单买价"] = newarr[2];
                                    jsondata["规格图片"] = newarr[3];
                                    allarrone.push(jsondata);
                                }

                            {/loop}
                        }else{
                            var jsondata = {};
                            jsondata[ggzarr[0]] = sz1[i];
                            jsondata[ggzarr[1]] = sz2[j];
                            jsondata["库存"] = 0;
                            jsondata["拼团价"] = 0;
                            jsondata["单买价"] = 0;
                            jsondata["规格图片"] = "";
                            allarrone.push(jsondata);
                        }

                    }
                }

            }
            //构建多重json三条数据
            if(ggzarr.length == 3){
                var sz1 = ggzjson[ggzarr[0]];
                var sz2 = ggzjson[ggzarr[1]];
                var sz3 = ggzjson[ggzarr[2]];

                //构建表格
                tablearr.push(ggzarr[0]);
                tablearr.push(ggzarr[1]);
                tablearr.push(ggzarr[2]);
                tablearr = tablearr.concat(jg);

                for(var i=0; i<sz1.length; i++){
                    for(var j=0; j<sz2.length; j++){
                        for(var z=0; z<sz3.length; z++){

                            var datakey = sz1[i]+sz2[j]+sz3[z];

                            if(datacounts == 1){
                                {loop $datajson $index $item}

                                    if("{$index}"== datakey){
                                        var aa = "{$item}";
                                        var newarr = aa.split(",");
                                        var jsondata = {};
                                        jsondata[ggzarr[0]] = sz1[i];
                                        jsondata[ggzarr[1]] = sz2[j];
                                        jsondata[ggzarr[2]] = sz3[z];
                                        jsondata["库存"] = newarr[0];
                                        jsondata["拼团价"] = newarr[1];
                                        jsondata["单买价"] = newarr[2];
                                        jsondata["规格图片"] = newarr[3];
                                        allarrone.push(jsondata);
                                    }

                                {/loop}
                            }else{
                                var jsondata = {};
                                jsondata[ggzarr[0]] = sz1[i];
                                jsondata[ggzarr[1]] = sz2[j];
                                jsondata[ggzarr[2]] = sz3[z];
                                jsondata["库存"] = 0;
                                jsondata["拼团价"] = 0;
                                jsondata["单买价"] = 0;
                                jsondata["规格图片"] = "";
                                allarrone.push(jsondata);
                            }

                        }
                    }
                }

            }

            // 构建表头
            var strtab = "<tr>";
            for(var k = 0; k<tablearr.length; k++){
                strtab += "<td class='biaotou'>"+tablearr[k]+"</td>";
            }
            strtab += "</tr>";
            $("#tabb").html(strtab);
            //构建表身
            var lensz = ggzarr.length;
            var tabdata = "";
            for(var d = 0; d<allarrone.length; d++){
                tabdata +=  "<tr>";
                for(var k = 0; k<tablearr.length; k++){
                    if(k<lensz){
                        tabdata += "<td class='tds '>"+allarrone[d][tablearr[k]]+"</td>";
                    }else if(tablearr[k]=="规格图片"){
                        var imgkk = "";
                        if(allarrone[d][tablearr[k]]){
                            var imgkk = "<img src="+allarrone[d][tablearr[k]]+">";
                        }else{
                            var imgkk = "";
                        }
                        tabdata +=  "<td class='tds' style='position: relative;'>"+
                                        "<input type='hidden' id='imgurl"+d+"' class='shukdd' name='valarr"+d+"' value="+allarrone[d][tablearr[k]]+">"+
                                        "<div class='xuzndt' name='imgurl"+d+"' onclick='showImageDialog(this);'>选择</div>"+
                                        "<div class='xuzndt' name='imgurl"+d+"' onclick='delimage(this)'>删除</div>"+
                                        "<div class='xuzndd' id='imgxs"+d+"'>"+
                                            imgkk+
                                        "</div>"
                                    "</td>";
                    }else if(tablearr[k]=="库存"){
                        tabdata += "<td class='tds'><input type='number' min='0' class='shukdd' name='valarr"+d+"' value='"+allarrone[d][tablearr[k]]+"'></td>";
                    }else if(tablearr[k]=="拼团价" || tablearr[k]=="单买价"){
                        tabdata += "<td class='tds'><input type='text' onkeyup='clearNoNum(this)' class='shukdd' name='valarr"+d+"' value='"+allarrone[d][tablearr[k]]+"'></td>";
                    }
                    else{
                        tabdata += "<td class='tds'><input type='text' class='shukdd' name='valarr"+d+"' value='"+allarrone[d][tablearr[k]]+"'></td>";
                    }
                }
                tabdata +=  "</tr>";
            }
            $("#tabb").append(tabdata);

        }
        function clearNoNum(obj){  
          obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
          if(obj.value.charAt(0,1) == "."){
            obj.value = "";
          }
          obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的   
          obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");  
          obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3');//只能输入两个小数   
          if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额  
           obj.value= parseFloat(obj.value);  
          }  
        }
        function ggzbc(){

            for(var i=0; i<allarrone.length; i++){
                var kucun = $("input[name='valarr"+i+"']")[0].value;
                var money = $("input[name='valarr"+i+"']")[1].value;
                var huohao = $("input[name='valarr"+i+"']")[2].value;
                var imgs = $("input[name='valarr"+i+"']")[3].value;
                allarrone[i]['库存'] = kucun;
                allarrone[i]['拼团价'] = money;
                allarrone[i]['单买价'] = huohao;
                allarrone[i]['规格图片'] = imgs;
            }

            var val = JSON.stringify(allarrone);
            $("#biaogedata").val(val);
            $("#typelen").val(ggzarr.length);
            $("#typesarr").val(ggzarr.toString());
            $(".shukdd").attr("name",'');
            alert("规格值设置成功！");

        }

        function showImageDialog(elm, opts, options) {

            require(["util"], function(util){

                var btn = $(elm);
                var key = $(btn).attr("name");
                var dval = key.substr(6,key.length);
                var imgkey = "imgxs"+dval;

                var ipt = btn.parent().prev();
                var val = ipt.val();
                var img = ipt.parent().next().children();
                options = {'global':false,'class_extra':'','direct':true,'multiple':false,'fileSizeLimit':5120000};
                util.image(val, function(url){

                    var urlnew = url.url;
                    var strurl = "<img src='"+urlnew+"'>";
                    $("#"+key).val(urlnew);
                    $("#"+imgkey).html(strurl);
                    if(typessy==2){
                        $("#imgyc999").val(url.url);
                    }

                }, options);
            });
        }
        function delimage(me){
            var key = $(me).attr("name");
            var dval = key.substr(6,key.length);
            var imgkey = "imgxs"+dval;
            $("#"+key).val("");
            $("#"+imgkey).html("");
            if(typessy==2){
                $("#imgyc999").val("");
            }
        }

    </script>

{/if}

<link rel="stylesheet" type="text/css" href="/web/resource/components/datetimepicker/jquery.datetimepicker.css"/ >
<script type="text/javascript" src="/web/resource/components/datetimepicker/jquery.datetimepicker.js"></script>
<script src="https://cdn.bootcss.com/bootstrap-select/2.0.0-beta1/js/bootstrap-select.min.js"></script>
<script type="text/javascript">
    $(function(){
        $('#datetimepicker').datetimepicker({
            lang:'ch',
            format:"Y-m-d H:i:s",
            allowBlank:true,
            validateOnBlur:false,
        });
    })
</script>
{template 'common/footer'}
